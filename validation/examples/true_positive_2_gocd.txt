# TRUE POSITIVE: gocd/gocd
# SHA: d1b056af5b5177ac1fa8c2e49ce39cf8a9786083
# Our Score: 45
# High score (45), confirmed bug-introducing commit
# GitHub: https://github.com/gocd/gocd/commit/d1b056af5b5177ac1fa8c2e49ce39cf8a9786083

Commit message: Merge pull request #977 from jyotisingh/jetty_9_reincarnated

Jetty 9 reincarnated

--- agent/test/unit/com/thoughtworks/go/agent/testhelpers/FakeGoServer.java (modified) ---
additions: 42, deletions: 27, changes: 69
@@ -16,25 +16,31 @@
 
 package com.thoughtworks.go.agent.testhelpers;
 
-import java.io.File;
-import java.io.IOException;
-import java.net.InetAddress;
-import java.net.UnknownHostException;
+import com.thoughtworks.go.security.X509CertificateGenerator;
+import com.thoughtworks.go.util.TestFileUtil;
+import org.eclipse.jetty.server.*;
+import org.eclipse.jetty.servlet.ServletHolder;
+import org.eclipse.jetty.util.ssl.SslContextFactory;
+import org.eclipse.jetty.webapp.JettyWebXmlConfiguration;
+import org.eclipse.jetty.webapp.WebAppContext;
+import org.eclipse.jetty.webapp.WebInfConfiguration;
+import org.eclipse.jetty.webapp.WebXmlConfiguration;
+
 import javax.servlet.ServletException;
 import javax.servlet.ServletRequest;
 import javax.servlet.ServletResponse;
 import javax.servlet.http.HttpServlet;
-
-import com.thoughtworks.go.security.X509CertificateGenerator;
-import com.thoughtworks.go.util.TestFileUtil;
-import org.mortbay.jetty.Server;
-import org.mortbay.jetty.security.SslSocketConnector;
-import org.mortbay.jetty.servlet.ServletHolder;
-import org.mortbay.jetty.webapp.WebAppContext;
+import java.io.File;
+import java.io.IOException;
+import java.net.InetAddress;
+import java.net.UnknownHostException;
 
 public class FakeGoServer {
-    private Server server;
     public static final String PASSWORD = "Crui3CertSigningPassword";
+	private static final int MAX_IDLE_TIME = 30000;
+	private static final int RESPONSE_BUFFER_SIZE = 32768;
+
+	private Server server;
     private int serverPort;
     private int sslPort;
 
@@ -54,14 +60,14 @@ public void start() throws Exception {
         server.addConnector(sslConnector(keystore, truststore, sslPort));
         WebAppContext wac = new WebAppContext("testdata/goserverstub", "/go");
         wac.setConfigurationClasses(new String[]{
-                "org.mortbay.jetty.webapp.WebInfConfiguration",
-                "org.mortbay.jetty.webapp.WebXmlConfiguration",
-                "org.mortbay.jetty.webapp.JettyWebXmlConfiguration",
+				WebInfConfiguration.class.getCanonicalName(),
+				WebXmlConfiguration.class.getCanonicalName(),
+				JettyWebXmlConfiguration.class.getCanonicalName()
         });
         addStopServlet(server, wac);
         addFakeArtifactiPublisherServlet(wac);
         addFakeAgentCertificateServlet(wac);
-        server.addHandler(wac);
+        server.setHandler(wac);
         server.setStopAtShutdown(true);
         server.start();
     }
@@ -91,17 +97,26 @@ public void stop() throws Exception {
     }
 
 
-    public SslSocketConnector sslConnector(File keystore, File truststore, int sslPort) {
-        SslSocketConnector sslSocketConnector = new SslSocketConnector();
-        sslSocketConnector.setPort(sslPort);
-        sslSocketConnector.setMaxIdleTime(30000);
-        sslSocketConnector.setKeystore(keystore.getAbsolutePath());
-        sslSocketConnector.setPassword(PASSWORD);
-        sslSocketConnector.setKeyPassword(PASSWORD);
-        sslSocketConnector.setTruststore(truststore.getAbsolutePath());
-        sslSocketConnector.setTrustPassword(PASSWORD);
-        return sslSocketConnector;
-    }
+	public Connector sslConnector(File keystore, File truststore, int sslPort) {
+		HttpConfiguration httpsConfig = new HttpConfiguration();
+		httpsConfig.setOutputBufferSize(RESPONSE_BUFFER_SIZE);
+		httpsConfig.addCustomizer(new SecureRequestCustomizer());
+
+		SslContextFactory sslContextFactory = new SslContextFactory();
+		sslContextFactory.setKeyStorePath(keystore.getAbsolutePath());
+		sslContextFactory.setKeyStorePassword(PASSWORD);
+		sslContextFactory.setKeyManagerPassword(PASSWORD);
+		sslContextFactory.setTrustStorePath(truststore.getAbsolutePath());
+		sslContextFactory.setTrustStorePassword(PASSWORD);
+		sslContextFactory.setWantClientAuth(true);
+
+		ServerConnector https = new ServerConnector(server, new SslConnectionFactory(sslContextFactory, "http/1.1"), new HttpConnectionFactory(httpsConfig));
+		// https.setHost(host);
+		https.setPort(sslPort);
+		https.setIdleTimeout(MAX_IDLE_TIME);
+
+		return https;
+	}
 
     private void createX509Certificate(File keystore, File truststore, File agentKeystore) {
         final String principalDn = "ou=Cruise server webserver certificate, cn=" + getHostname();

--- app-server/pom.xml (added) ---
additions: 284, deletions: 0, changes: 284
@@ -0,0 +1,284 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- *************************GO-LICENSE-START******************************
+ * Copyright 2014 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END******************************* -->
+
+<project xmlns="http://maven.apache.org/POM/4.0.0"
+         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
+    <modelVersion>4.0.0</modelVersion>
+
+    <groupId>com.thoughtworks.go</groupId>
+    <artifactId>app-server</artifactId>
+    <version>1.0</version>
+
+    <parent>
+        <groupId>com.thoughtworks.go</groupId>
+        <artifactId>gocd</artifactId>
+        <version>1.0</version>
+        <relativePath>../</relativePath>
+    </parent>
+
+
+    <dependencies>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>base</artifactId>
+            <version>1.0</version>
+        </dependency>
+
+        <dependency>
+            <groupId>javax.servlet</groupId>
+            <artifactId>javax.servlet-api</artifactId>
+            <version>3.1.0</version>
+        </dependency>
+
+        <dependency>
+            <groupId>log4j</groupId>
+            <artifactId>log4j</artifactId>
+            <version>1.2.12</version>
+        </dependency>
+
+        <!-- apache commons -->
+        <dependency>
+            <groupId>commons-beanutils</groupId>
+            <artifactId>commons-beanutils-core</artifactId>
+            <version>1.7.0</version>
+            <exclusions>
+                <exclusion>
+                    <groupId>commons-logging</groupId>
+                    <artifactId>commons-logging</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>commons-collections</groupId>
+                    <artifactId>commons-collections</artifactId>
+                </exclusion>
+            </exclusions>
+        </dependency>
+        <dependency>
+            <groupId>commons-validator</groupId>
+            <artifactId>commons-validator</artifactId>
+            <version>1.3.1</version>
+            <exclusions>
+                <exclusion>
+                    <groupId>commons-digester</groupId>
+                    <artifactId>commons-digester</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>commons-logging</groupId>
+                    <artifactId>commons-logging</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>junit</groupId>
+                    <artifactId>junit</artifactId>
+                </exclusion>
+            </exclusions>
+        </dependency>
+        <dependency>
+            <groupId>commons-dbcp</groupId>
+            <artifactId>commons-dbcp</artifactId>
+            <version>1.4</version>
+        </dependency>
+        <dependency>
+            <groupId>commons-pool</groupId>
+            <artifactId>commons-pool</artifactId>
+            <version>1.5.6</version>
+        </dependency>
+        <!-- apache commons end -->
+
+        <dependency>
+            <groupId>org.jruby</groupId>
+            <artifactId>jruby-complete</artifactId>
+            <version>1.7.11</version>
+        </dependency>
+        <dependency>
+            <groupId>org.jruby.rack</groupId>
+            <artifactId>jruby-rack</artifactId>
+            <version>1.1.14</version>
+        </dependency>
+
+        <dependency>
+            <groupId>org.openrdf</groupId>
+            <artifactId>sesame-onejar</artifactId>
+            <version>2.3.1</version>
+        </dependency>
+
+        <dependency>
+            <groupId>org.springframework</groupId>
+            <artifactId>spring-web</artifactId>
+            <version>${spring.version}</version>
+        </dependency>
+
+        <dependency>
+            <groupId>com.unboundid</groupId>
+            <artifactId>unboundid-ldapsdk</artifactId>
+            <version>2.3.6</version>
+            <scope>test</scope>
+        </dependency>
+
+        <dependency>
+            <groupId>org.springframework</groupId>
+            <artifactId>web.servlet</artifactId>
+            <version>${spring.version}</version>
+        </dependency>
+
+        <dependency>
+            <groupId>org.objenesis</groupId>
+            <artifactId>objenesis</artifactId>
+            <version>1.2</version>
+        </dependency>
+
+        <!-- test dependencies -->
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>common</artifactId>
+            <version>1.0</version>
+            <type>test-jar</type>
+            <scope>test</scope>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>config-server</artifactId>
+            <version>1.0</version>
+            <type>test-jar</type>
+            <scope>test</scope>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>config-api</artifactId>
+            <version>1.0</version>
+            <type>test-jar</type>
+            <scope>test</scope>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>metrics</artifactId>
+            <version>1.0</version>
+            <type>test-jar</type>
+            <scope>test</scope>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>test-utils</artifactId>
+            <version>1.0</version>
+            <scope>test</scope>
+        </dependency>
+        <dependency>
+            <groupId>com.tlb</groupId>
+            <artifactId>tlb-java</artifactId>
+            <version>0.3.2-90-g6df47e3</version>
+            <scope>test</scope>
+            <exclusions>
+                <exclusion>
+                    <groupId>commons-io</groupId>
+                    <artifactId>commons-io</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>commons-codec</groupId>
+                    <artifactId>commons-codec</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>log4j</groupId>
+                    <artifactId>log4j</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>xalan</groupId>
+                    <artifactId>xalan</artifactId>
+                </exclusion>
+            </exclusions>
+        </dependency>
+
+        <dependency>
+            <groupId>net.sourceforge.cobertura</groupId>
+            <artifactId>cobertura</artifactId>
+            <version>2.0.3</version>
+            <scope>test</scope>
+            <exclusions>
+                <exclusion>
+                    <groupId>log4j</groupId>
+                    <artifactId>log4j</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>com.sun</groupId>
+                    <artifactId>tools</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>org.mortbay.jetty</groupId>
+                    <artifactId>servlet-api-2.5</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>org.mortbay.jetty</groupId>
+                    <artifactId>jetty</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>org.mortbay.jetty</groupId>
+                    <artifactId>jetty-util</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>org.mortbay.jetty</groupId>
+                    <artifactId>jetty-servlet-tester</artifactId>
+                </exclusion>
+            </exclusions>
+        </dependency>
+    </dependencies>
+
+    <build>
+        <sourceDirectory>src</sourceDirectory>
+        <resources>
+            <resource>
+                <directory>resources</directory>
+            </resource>
+            <resource>
+                <directory>properties/src</directory>
+            </resource>
+        </resources>
+        <testResources>
+            <testResource>
+                <directory>test-resources</directory>
+            </testResource>
+            <testResource>
+                <directory>properties/test</directory>
+            </testResource>
+            <testResource>
+                <directory>webapp</directory>
+                <includes>
+                    <include>WEB-INF/**/*</include>
+                    <include>localize.xml</include>
+                    <include>localize_ja.xml</include>
+                </includes>
+                <excludes>
+                    <exclude>WEB-INF/classes/**/*</exclude>
+                    <exclude>WEB-INF/lib/**/*</exclude>
+                    <exclude>WEB-INF/rails/**/*</exclude>
+                </excludes>
+            </testResource>
+            <testResource>
+                <directory>test/data</directory>
+            </testResource>
+        </testResources>
+
+        <plugins>
+            <plugin>
+                <groupId>org.apache.maven.plugins</groupId>
+                <artifactId>maven-compiler-plugin</artifactId>
+                <version>3.1</version>
+                <configuration>
+                    <source>1.6</source>
+                    <target>1.6</target>
+                </configuration>
+            </plugin>
+        </plugins>
+    </build>
+</project>
\ No newline at end of file

--- app-server/src/com/thoughtworks/go/server/AppServer.java (added) ---
additions: 49, deletions: 0, changes: 49
@@ -0,0 +1,49 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server;
+
+import com.thoughtworks.go.util.SystemEnvironment;
+
+import javax.net.ssl.SSLSocketFactory;
+
+public abstract class AppServer {
+    protected SystemEnvironment systemEnvironment;
+    protected String password;
+    protected SSLSocketFactory sslSocketFactory;
+
+    public AppServer(SystemEnvironment systemEnvironment, String password, SSLSocketFactory sslSocketFactory){
+        this.systemEnvironment = systemEnvironment;
+        this.password = password;
+        this.sslSocketFactory = sslSocketFactory;
+    }
+
+    abstract void addExtraJarsToClasspath(String extraClasspath);
+
+    abstract void setCookieExpirePeriod(int cookieExpirePeriod);
+
+    abstract void setInitParameter(String name, String value);
+
+    abstract void addStopServlet();
+
+    abstract Throwable getUnavailableException();
+
+    abstract void configure() throws Exception;
+
+    abstract void start() throws Exception;
+
+    abstract void stop() throws Exception;
+}

--- app-server/src/com/thoughtworks/go/server/StopJettyFromLocalhostServlet.java (renamed) ---
additions: 5, deletions: 5, changes: 10
@@ -1,5 +1,5 @@
 /*************************GO-LICENSE-START*********************************
- * Copyright 2014 ThoughtWorks, Inc.
+ * Copyright 2015 ThoughtWorks, Inc.
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -27,10 +27,10 @@
 
 public class StopJettyFromLocalhostServlet extends HttpServlet {
     final Logger logger = Logger.getLogger(StopJettyFromLocalhostServlet.class);
-    private GoServer goServer;
+    private AppServer jettyServer;
 
-    public StopJettyFromLocalhostServlet(GoServer goServer) {
-        this.goServer = goServer;
+    public StopJettyFromLocalhostServlet(AppServer jettyServer) {
+        this.jettyServer = jettyServer;
     }
 
     public void service(ServletRequest request, ServletResponse response)
@@ -46,7 +46,7 @@ public void run() {
                     waitOneSecondForJettyToReturnAProperReturnCodeToHttpclient();
                     try {
                         logger.info("stopping Jetty...");
-                        goServer.stop();
+                        jettyServer.stop();
                     } catch (Exception e) {
                         e.printStackTrace();
                         logger.info("cannot stop Jetty", e);

--- app-server/src/com/thoughtworks/go/server/util/ServletHelper.java (added) ---
additions: 50, deletions: 0, changes: 50
@@ -0,0 +1,50 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+import java.lang.reflect.InvocationTargetException;
+
+public abstract class ServletHelper {
+    public abstract ServletRequest getRequest(javax.servlet.ServletRequest servletRequest);
+
+    public abstract ServletResponse getResponse(javax.servlet.ServletResponse servletResponse);
+
+    public abstract String encodeString(String string);
+
+    private static ServletHelper instance;
+
+    public static void init(Boolean usingJetty9) {
+        try {
+            if (usingJetty9) {
+                instance = getAppServerHelper("com.thoughtworks.go.server.util.Jetty9ServletHelper");
+            } else {
+                instance = getAppServerHelper("com.thoughtworks.go.server.util.Jetty6ServletHelper");
+            }
+        } catch (Exception e) {
+            throw new RuntimeException(e);
+        }
+    }
+
+    public static ServletHelper getInstance() {
+        return instance;
+    }
+
+    private static com.thoughtworks.go.server.util.ServletHelper getAppServerHelper(String className) throws InstantiationException, IllegalAccessException, InvocationTargetException, NoSuchMethodException, ClassNotFoundException {
+        return (com.thoughtworks.go.server.util.ServletHelper) Class.forName(className).getConstructor().newInstance();
+    }
+}
+

--- app-server/src/com/thoughtworks/go/server/util/ServletRequest.java (added) ---
additions: 24, deletions: 0, changes: 24
@@ -0,0 +1,24 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+public interface ServletRequest {
+    String getUrl();
+    String getUriPath();
+    String getUriAsString();
+    void setRequestURI(String uri);
+}

--- app-server/src/com/thoughtworks/go/server/util/ServletResponse.java (added) ---
additions: 22, deletions: 0, changes: 22
@@ -0,0 +1,22 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+public interface ServletResponse {
+    int getStatus();
+    long getContentCount();
+}

--- base/src/com/thoughtworks/go/util/SystemEnvironment.java (modified) ---
additions: 10, deletions: 1, changes: 11
@@ -134,6 +134,8 @@ public class SystemEnvironment implements Serializable, ConfigDirProvider {
     public static GoSystemProperty<Integer> COMMAND_REPOSITORY_CACHE_TIME_IN_SECONDS = new CachedProperty<Integer>(new GoIntSystemProperty("command.repo.cache.timeout.in.secs", 30 * 60));
     public static GoSystemProperty<String> COMMAND_REPOSITORY_DIRECTORY = new CachedProperty<String>(new GoStringSystemProperty("command.repo.dir", DB_BASE_DIR + "command_repository"));
     public static GoSystemProperty<Boolean> CAPTURE_METRICS = new GoBooleanSystemProperty("capture.metrics", true);
+    public static GoSystemProperty<Integer> IDLE_TIMEOUT = new GoIntSystemProperty("idle.timeout", 30000);
+    public static GoSystemProperty<Integer> RESPONSE_BUFFER_SIZE = new GoIntSystemProperty("response.buffer.size", 32768);
 
     public static GoSystemProperty<Integer> PLUGIN_NOTIFICATION_LISTENER_COUNT = new CachedProperty<Integer>(new GoIntSystemProperty("plugin.notification.listener.count", 1));
 
@@ -149,7 +151,10 @@ public class SystemEnvironment implements Serializable, ConfigDirProvider {
     public static GoStringSystemProperty GO_DATABASE_PROVIDER = new GoStringSystemProperty("go.database.provider", H2_DATABASE);
 
     public static GoSystemProperty<Boolean> SHOULD_VALIDATE_XML_AGAINST_DTD = new GoBooleanSystemProperty("validate.xml.against.dtd", false);
+    public static GoSystemProperty<String> JETTY_XML_FILE_NAME = new GoStringSystemProperty("jetty.xml.file.name", JETTY_XML);
 
+    public static final String JETTY9 = "com.thoughtworks.go.server.Jetty9Server";
+    public static GoSystemProperty<String> APP_SERVER = new CachedProperty<String>(new GoStringSystemProperty("app.server", JETTY9));
 
     private volatile static Integer agentConnectionTimeout;
     private volatile static Integer cruiseSSlPort;
@@ -283,7 +288,7 @@ public String getConfigDir() {
     }
 
     public File getJettyConfigFile() {
-        return new File(getConfigDir(), JETTY_XML);
+        return new File(getConfigDir(), get(JETTY_XML_FILE_NAME));
     }
 
     /**
@@ -631,6 +636,10 @@ public String getDatabaseProvider() {
         return GO_DATABASE_PROVIDER.getValue();
     }
 
+    public boolean usingJetty9() {
+        return get(APP_SERVER).equals(JETTY9);
+    }
+
 
     public static abstract class GoSystemProperty<T> {
         private String propertyName;

--- common/pom.xml (modified) ---
additions: 32, deletions: 0, changes: 32
@@ -165,6 +165,22 @@
                     <groupId>com.sun</groupId>
                     <artifactId>tools</artifactId>
                 </exclusion>
+                <exclusion>
+                    <groupId>org.mortbay.jetty</groupId>
+                    <artifactId>servlet-api-2.5</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>org.mortbay.jetty</groupId>
+                    <artifactId>jetty</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>org.mortbay.jetty</groupId>
+                    <artifactId>jetty-util</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>org.mortbay.jetty</groupId>
+                    <artifactId>jetty-servlet-tester</artifactId>
+                </exclusion>
             </exclusions>
         </dependency>
     </dependencies>
@@ -292,6 +308,22 @@
                                 <groupId>com.sun</groupId>
                                 <artifactId>tools</artifactId>
                             </exclusion>
+                            <exclusion>
+                                <groupId>org.mortbay.jetty</groupId>
+                                <artifactId>servlet-api-2.5</artifactId>
+                            </exclusion>
+                            <exclusion>
+                                <groupId>org.mortbay.jetty</groupId>
+                                <artifactId>jetty</artifactId>
+                            </exclusion>
+                            <exclusion>
+                                <groupId>org.mortbay.jetty</groupId>
+                                <artifactId>jetty-util</artifactId>
+                            </exclusion>
+                            <exclusion>
+                                <groupId>org.mortbay.jetty</groupId>
+                                <artifactId>jetty-servlet-tester</artifactId>
+                            </exclusion>
                         </exclusions>
                     </dependency>
                 </dependencies>

--- common/src/com/thoughtworks/go/util/validators/JettyWorkDirValidator.java (modified) ---
additions: 7, deletions: 3, changes: 10
@@ -18,6 +18,7 @@
 
 import java.io.File;
 import java.io.IOException;
+
 import static java.text.MessageFormat.format;
 
 import com.thoughtworks.go.util.SystemEnvironment;
@@ -27,11 +28,14 @@
 
 public class JettyWorkDirValidator implements Validator {
     public Validation validate(Validation val) {
+        SystemEnvironment systemEnvironment = new SystemEnvironment();
         if (SystemEnvironment.getProperty("jetty.home", "").equals("")) {
-            new SystemEnvironment().setProperty("jetty.home", new SystemEnvironment().getPropertyImpl("user.dir"));
+            systemEnvironment.setProperty("jetty.home", systemEnvironment.getPropertyImpl("user.dir"));
         }
-        File home = new File(new SystemEnvironment().getPropertyImpl("jetty.home"));
-        File work = new File(new SystemEnvironment().getPropertyImpl("jetty.home"), "work");
+        systemEnvironment.setProperty("jetty.base", systemEnvironment.getPropertyImpl("jetty.home"));
+        
+        File home = new File(systemEnvironment.getPropertyImpl("jetty.home"));
+        File work = new File(systemEnvironment.getPropertyImpl("jetty.home"), "work");
         if (home.exists()) {
             if (work.exists()) {
                 try {

--- common/test/unit/com/thoughtworks/go/util/SystemEnvironmentTest.java (modified) ---
additions: 12, deletions: 0, changes: 12
@@ -66,6 +66,8 @@ public void shouldBeAbletoEnableAllNewFeatures() {
     public void shouldFindJettyConfigInTheConfigDir() {
         SystemEnvironment systemEnvironment = new SystemEnvironment();
         assertThat(systemEnvironment.getJettyConfigFile(), is(new File(systemEnvironment.getConfigDir(), "jetty.xml")));
+        systemEnvironment.set(SystemEnvironment.JETTY_XML_FILE_NAME, "jetty6.xml");
+        assertThat(systemEnvironment.getJettyConfigFile(), is(new File(systemEnvironment.getConfigDir(), "jetty6.xml")));
     }
 
     @Test
@@ -371,4 +373,14 @@ public void shouldGetGoDatabaseProvider() {
         System.setProperty("go.database.provider", "foo");
         assertThat(systemEnvironment.getDatabaseProvider(), is("foo"));
     }
+
+    @Test
+    public void shouldUseJetty9ByDefault(){
+        SystemEnvironment systemEnvironment = new SystemEnvironment();
+        assertThat(systemEnvironment.get(SystemEnvironment.APP_SERVER), is(SystemEnvironment.JETTY9));
+        assertThat(systemEnvironment.usingJetty9(), is(true));
+
+        systemEnvironment.set(SystemEnvironment.APP_SERVER, "JETTY6");
+        assertThat(systemEnvironment.usingJetty9(), is(false));
+    }
 }

--- common/test/unit/com/thoughtworks/go/util/validators/JettyWorkDirValidatorTest.java (modified) ---
additions: 43, deletions: 32, changes: 75
@@ -23,71 +23,82 @@
 import static org.hamcrest.core.Is.is;
 import static org.junit.Assert.assertThat;
 
+import org.junit.Before;
+import org.junit.Rule;
 import org.junit.Test;
+import org.junit.rules.TemporaryFolder;
 
 public class JettyWorkDirValidatorTest {
+    @Rule
+    public TemporaryFolder temporaryFolder =  new TemporaryFolder();
+    private File homeDir;
+    private SystemEnvironment systemEnvironment;
+
+    @Before
+    public void setUp() throws Exception {
+        homeDir = temporaryFolder.newFolder();
+        systemEnvironment = new SystemEnvironment();
+    }
+
+    @Test
+    public void shouldSetJettyHomeAndBasePropertyIfItsNotSet() {
+        systemEnvironment.clearProperty("jetty.home");
+        systemEnvironment.clearProperty("jetty.base");
+        systemEnvironment.setProperty("user.dir", "junk");
+        JettyWorkDirValidator jettyWorkDirValidator = new JettyWorkDirValidator();
+        Validation val = new Validation();
+        jettyWorkDirValidator.validate(val);
+        assertThat(val.isSuccessful(), is(true));
+        assertThat(SystemEnvironment.getProperty("jetty.home"), is("junk"));
+        assertThat(SystemEnvironment.getProperty("jetty.base"), is("junk"));
+    }
+
     @Test
-    public void shouldSetJettyHomePropertyIfItsNotSet() {
-        new SystemEnvironment().clearProperty("jetty.home");
+    public void shouldSetJettyBaseToValueOfJettyHome() {
+        systemEnvironment.setProperty("jetty.home", "foo");
+        systemEnvironment.clearProperty("jetty.base");
         JettyWorkDirValidator jettyWorkDirValidator = new JettyWorkDirValidator();
         Validation val = new Validation();
         jettyWorkDirValidator.validate(val);
         assertThat(val.isSuccessful(), is(true));
-        assertThat(SystemEnvironment.getProperty("jetty.home"), is(SystemEnvironment.getProperty("user.dir")));
+        assertThat(systemEnvironment.getPropertyImpl("jetty.base"), is("foo"));
     }
 
     @Test
     public void shouldCreateWorkDirIfItDoesNotExist() {
-        String testHomeDir = SystemEnvironment.getProperty("java.io.tmpdir") + "/test.jetty.home.dir";
-        File testHome = new File(testHomeDir);
-        testHome.mkdir();
-        testHome.deleteOnExit();
-        new SystemEnvironment().setProperty("jetty.home", testHomeDir);
+        systemEnvironment.setProperty("jetty.home", homeDir.getAbsolutePath());
         JettyWorkDirValidator jettyWorkDirValidator = new JettyWorkDirValidator();
         Validation val = new Validation();
         jettyWorkDirValidator.validate(val);
         assertThat(val.isSuccessful(), is(true));
-        assertThat(SystemEnvironment.getProperty("jetty.home"), is(testHomeDir));
-        File work = new File(testHomeDir, "work");
+        File work = new File(homeDir, "work");
         assertThat(work.exists(), is(true));
-        work.delete();
     }
 
     @Test
     public void shouldNotCreateTheJettyHomeDirIfItDoesNotExist() {
-        String testHomeDir = SystemEnvironment.getProperty("java.io.tmpdir") + "/test.jetty.home.dir.should.not.exist";
-        File testHome = new File(testHomeDir);
-        testHome.delete();
-        testHome.deleteOnExit();
-        new SystemEnvironment().setProperty("jetty.home", testHomeDir);
+        String jettyHome = "home_dir";
+        systemEnvironment.setProperty("jetty.home", jettyHome);
         JettyWorkDirValidator jettyWorkDirValidator = new JettyWorkDirValidator();
         Validation val = new Validation();
         jettyWorkDirValidator.validate(val);
         assertThat(val.isSuccessful(), is(true));
-        assertThat(SystemEnvironment.getProperty("jetty.home"), is(testHomeDir));
-        assertThat(testHome.exists(), is(false));
+        assertThat(systemEnvironment.getPropertyImpl("jetty.home"), is(jettyHome));
+        assertThat(systemEnvironment.getPropertyImpl("jetty.base"), is(jettyHome));
+        assertThat(new File(jettyHome).exists(), is(false));
     }
 
     @Test
     public void shouldRecreateWorkDirIfItExists() throws IOException {
-        String testHomeDir = SystemEnvironment.getProperty("java.io.tmpdir") + "/test.jetty.home.dir";
-        File testHome = new File(testHomeDir);
-        testHome.mkdir();
-        testHome.deleteOnExit();
-        File work = new File(testHome, "work");
-        work.mkdir();
-        File oldFile = new File(work, "oldfile");
-        work.deleteOnExit();
-        oldFile.createNewFile();
-        oldFile.deleteOnExit();
-
-        new SystemEnvironment().setProperty("jetty.home", testHomeDir);
+        File oldWorkDir = new File(homeDir, "work");
+        oldWorkDir.mkdir();
+        new File(oldWorkDir, "junk.txt").createNewFile();
+        systemEnvironment.setProperty("jetty.home", homeDir.getAbsolutePath());
         JettyWorkDirValidator jettyWorkDirValidator = new JettyWorkDirValidator();
         Validation val = new Validation();
         jettyWorkDirValidator.validate(val);
         assertThat(val.isSuccessful(), is(true));
-
-        File recreatedWorkDir = new File(testHomeDir, "work");
+        File recreatedWorkDir = new File(homeDir, "work");
         assertThat(recreatedWorkDir.exists(), is(true));
         assertThat(recreatedWorkDir.listFiles().length, is(0));
     }

--- config/config-server/pom.xml (modified) ---
additions: 2, deletions: 2, changes: 4
@@ -76,12 +76,12 @@
         <dependency>
             <groupId>org.slf4j</groupId>
             <artifactId>slf4j-api</artifactId>
-            <version>1.5.8</version>
+            <version>1.7.2</version>
         </dependency>
         <dependency>
             <groupId>org.slf4j</groupId>
             <artifactId>slf4j-log4j12</artifactId>
-            <version>1.5.8</version>
+            <version>1.7.2</version>
         </dependency>
 
         <dependency>

--- cruise-modules.rb (modified) ---
additions: 35, deletions: 9, changes: 44
@@ -177,16 +177,41 @@ def clone_command_repo(command_repository_default_dir)
   package(:jar, :file => _(:target, 'main.jar')).clean.with(:manifest => main_manifest).enhance do |jar|
     include_fileset_from_target(jar, 'server', "**/GoLauncher.class")
     include_fileset_from_target(jar, 'server', "**/GoLauncher.class")
-    include_fileset_from_target(jar, 'server', "**/GoSslSocketConnector.class")
-    include_fileset_from_target(jar, 'server', "**/GoCipherSuite.class")
     include_fileset_from_target(jar, 'server', "**/GoServer*.class")
-    include_fileset_from_target(jar, 'server', "**/JettyServer*.class")
-    include_fileset_from_target(jar, 'server', "**/GoWebXmlConfiguration*.class")
-    include_fileset_from_target(jar, 'server', "**/StopJettyFromLocalhostServlet*.class")
     include_fileset_from_target(jar, 'server', "**/DeploymentContextWriter*.class")
     include_fileset_from_target(jar, 'server', "**/BaseUrlProvider*.class")
-    include_fileset_from_target(jar, 'server', "**/AssetsContextHandler*.class")
-    include_fileset_from_target(jar, 'server', "**/AssetsContextHandlerInitializer*.class")
+
+    include_fileset_from_target(jar, 'app-server', "**/StopJettyFromLocalhostServlet*.class")
+    include_fileset_from_target(jar, 'app-server', "**/AppServer.class")
+    include_fileset_from_target(jar, 'app-server', "**/ServletHelper.class")
+    include_fileset_from_target(jar, 'app-server', "**/ServletRequest.class")
+    include_fileset_from_target(jar, 'app-server', "**/ServletResponse.class")
+
+    # ---- Jetty 9 start ---
+    include_fileset_from_target(jar, 'jetty9', "**/GoSslSocketConnector.class")
+    include_fileset_from_target(jar, 'jetty9', "**/GoPlainSocketConnector.class")
+    include_fileset_from_target(jar, 'jetty9', "**/GoSocketConnector.class")
+    include_fileset_from_target(jar, 'jetty9', "**/GoCipherSuite.class")
+    include_fileset_from_target(jar, 'jetty9', "**/Jetty9Server*.class")
+    include_fileset_from_target(jar, 'jetty9', "**/GoWebXmlConfiguration*.class")
+    include_fileset_from_target(jar, 'jetty9', "**/AssetsContextHandler*.class")
+    include_fileset_from_target(jar, 'jetty9', "**/AssetsContextHandlerInitializer*.class")
+    include_fileset_from_target(jar, 'jetty9', "**/Jetty9ServletHelper*.class")
+    include_fileset_from_target(jar, 'jetty9', "**/Jetty9Request.class")
+    include_fileset_from_target(jar, 'jetty9', "**/Jetty9Response.class")
+    # # ---- Jetty 9 end ---
+
+    # # ---- Jetty 6 start ---
+    include_fileset_from_target(jar, 'jetty6', "**/GoJetty6SslSocketConnector.class")
+    include_fileset_from_target(jar, 'jetty6', "**/GoJetty6CipherSuite.class")
+    include_fileset_from_target(jar, 'jetty6', "**/Jetty6Server*.class")
+    include_fileset_from_target(jar, 'jetty6', "**/Jetty6GoWebXmlConfiguration*.class")
+    include_fileset_from_target(jar, 'jetty6', "**/Jetty6AssetsContextHandler*.class")
+    include_fileset_from_target(jar, 'jetty6', "**/Jetty6AssetsContextHandlerInitializer*.class")
+    include_fileset_from_target(jar, 'jetty6', "**/Jetty6ServletHelper*.class")
+    include_fileset_from_target(jar, 'jetty6', "**/Jetty6Request.class")
+    include_fileset_from_target(jar, 'jetty6', "**/Jetty6Response.class")
+    # ---- Jetty 6 end ---
 
     include_fileset_from_target(jar, 'common', "**/SubprocessLogger*.class")
     include_fileset_from_target(jar, 'common', "**/validators/*.class")
@@ -252,9 +277,10 @@ def clone_command_repo(command_repository_default_dir)
             _("../installers/server/release/cruise-config.xml"),
             _("../installers/server/release/config.properties"),
             _("properties/src/log4j.properties"),
-            _("config/jetty.xml"))
+            _("config/jetty.xml"),
+            _("config/jetty6.xml"))
 
-    onejar.path('lib/').include(server_launcher_dependencies).include(tw_go_jar('tfs-impl')).include(tw_go_jar('plugin-infra/go-plugin-activator', 'go-plugin-activator'))
+    onejar.path('lib/').include(server_launcher_dependencies).include(jetty_jars).include(tw_go_jar('tfs-impl')).include(tw_go_jar('plugin-infra/go-plugin-activator', 'go-plugin-activator'))
     include_fileset_from_target(onejar, 'server', "**/GoMacLauncher*")
     include_fileset_from_target(onejar, 'server', "**/Mac*")
     include_fileset_from_target(onejar, 'common', "log4j.upgrade.*.properties")

--- development-utility/development-server-with-jetty6/pom.xml (added) ---
additions: 140, deletions: 0, changes: 140
@@ -0,0 +1,140 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- *************************GO-LICENSE-START******************************
+ * Copyright 2014 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END******************************* -->
+
+<project xmlns="http://maven.apache.org/POM/4.0.0"
+         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
+    <modelVersion>4.0.0</modelVersion>
+
+    <groupId>com.thoughtworks.go</groupId>
+    <artifactId>development-server-with-jetty6</artifactId>
+    <version>1.0</version>
+
+    <parent>
+        <groupId>com.thoughtworks.go</groupId>
+        <artifactId>gocd</artifactId>
+        <version>1.0</version>
+        <relativePath>../../</relativePath>
+    </parent>
+
+    <properties>
+        <main.dir>${project.basedir}/../../</main.dir>
+        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
+        <jetty.version>6.1.23</jetty.version>
+    </properties>
+
+    <dependencies>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>development-server</artifactId>
+            <version>1.0</version>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>server</artifactId>
+            <version>1.0</version>
+            <classifier>classes</classifier>
+        </dependency>
+
+        <!-- jetty -->
+        <dependency>
+            <groupId>org.mortbay.jetty</groupId>
+            <artifactId>jetty</artifactId>
+            <version>${jetty.version}</version>
+        </dependency>
+        <dependency>
+            <groupId>org.mortbay.jetty</groupId>
+            <artifactId>jetty-util</artifactId>
+            <version>${jetty.version}</version>
+        </dependency>
+        <dependency>
+            <groupId>org.mortbay.jetty</groupId>
+            <artifactId>jetty-management</artifactId>
+            <version>${jetty.version}</version>
+        </dependency>
+        <dependency>
+            <groupId>org.mortbay.jetty</groupId>
+            <artifactId>jetty-naming</artifactId>
+            <version>${jetty.version}</version>
+        </dependency>
+        <dependency>
+            <groupId>org.mortbay.jetty</groupId>
+            <artifactId>jetty-sslengine</artifactId>
+            <version>${jetty.version}</version>
+        </dependency>
+        <dependency>
+            <groupId>org.mortbay.jetty</groupId>
+            <artifactId>jetty-plus</artifactId>
+            <version>${jetty.version}</version>
+        </dependency>
+        <!-- jetty end -->
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>jetty6</artifactId>
+            <version>1.0</version>
+        </dependency>
+
+        <dependency>
+            <groupId>javax.servlet</groupId>
+            <artifactId>javax.servlet-api</artifactId>
+            <version>3.1.0</version>
+        </dependency>
+
+        <dependency>
+            <groupId>org.jruby</groupId>
+            <artifactId>jruby-complete</artifactId>
+            <version>1.7.11</version>
+        </dependency>
+        <dependency>
+            <groupId>org.jruby.rack</groupId>
+            <artifactId>jruby-rack</artifactId>
+            <version>1.1.14</version>
+        </dependency>
+        <dependency>
+            <groupId>org.bouncycastle</groupId>
+            <artifactId>bcprov-jdk15on</artifactId>
+            <version>1.47</version>
+        </dependency>
+
+        <dependency>
+            <groupId>org.slf4j</groupId>
+            <artifactId>slf4j-api</artifactId>
+            <version>1.7.2</version>
+        </dependency>
+        <dependency>
+            <groupId>org.slf4j</groupId>
+            <artifactId>slf4j-log4j12</artifactId>
+            <version>1.7.2</version>
+        </dependency>
+    </dependencies>
+
+    <build>
+        <sourceDirectory>src</sourceDirectory>
+
+        <plugins>
+            <plugin>
+                <groupId>org.apache.maven.plugins</groupId>
+                <artifactId>maven-compiler-plugin</artifactId>
+                <version>3.1</version>
+                <configuration>
+                    <source>1.6</source>
+                    <target>1.6</target>
+                </configuration>
+            </plugin>
+        </plugins>
+    </build>
+</project>
\ No newline at end of file

--- development-utility/development-server-with-jetty6/src/com/thoughtworks/go/server/DevelopmentServerWithJetty6.java (added) ---
additions: 36, deletions: 0, changes: 36
@@ -0,0 +1,36 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2014 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server;
+
+import com.thoughtworks.go.util.SystemEnvironment;
+
+/**
+ * @understands how to run a local development mode webserver so we can develop live
+ * Set the following before running the main method:
+ * Working directory: <project-path>/server
+ * VM arguments: -Xms512m -Xmx1024m -XX:PermSize=400m -Djava.awt.headless=true
+ * classpath: Use classpath of 'development-server'
+ */
+
+public class DevelopmentServerWithJetty6 {
+    public static void main(String[] args) throws Exception {
+        SystemEnvironment systemEnvironment = new SystemEnvironment();
+        systemEnvironment.set(SystemEnvironment.APP_SERVER, Jetty6Server.class.getCanonicalName());
+        systemEnvironment.set(SystemEnvironment.JETTY_XML_FILE_NAME, "jetty6.xml");
+        DevelopmentServer.main(args);
+    }
+}

--- development-utility/development-server/pom.xml (modified) ---
additions: 44, deletions: 18, changes: 62
@@ -34,6 +34,7 @@
     <properties>
         <main.dir>${project.basedir}/../../</main.dir>
         <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
+        <jetty.version>9.2.3.v20140905</jetty.version>
     </properties>
 
     <dependencies>
@@ -43,6 +44,43 @@
 			<version>1.0</version>
 			<classifier>classes</classifier>
 		</dependency>
+        <dependency>
+            <groupId>org.eclipse.jetty</groupId>
+            <artifactId>jetty-server</artifactId>
+            <version>${jetty.version}</version>
+        </dependency>
+        <dependency>
+            <groupId>org.eclipse.jetty</groupId>
+            <artifactId>jetty-plus</artifactId>
+            <version>${jetty.version}</version>
+        </dependency>
+        <dependency>
+            <groupId>org.eclipse.jetty</groupId>
+            <artifactId>jetty-jmx</artifactId>
+            <version>${jetty.version}</version>
+        </dependency>
+        <dependency>
+            <groupId>org.eclipse.jetty</groupId>
+            <artifactId>jetty-servlets</artifactId>
+            <version>${jetty.version}</version>
+        </dependency>
+        <dependency>
+            <groupId>org.eclipse.jetty</groupId>
+            <artifactId>jetty-util</artifactId>
+            <version>${jetty.version}</version>
+        </dependency>
+
+        <dependency>
+			<groupId>com.thoughtworks.go</groupId>
+			<artifactId>jetty9</artifactId>
+			<version>1.0</version>
+		</dependency>
+
+        <dependency>
+            <groupId>javax.servlet</groupId>
+            <artifactId>javax.servlet-api</artifactId>
+            <version>3.1.0</version>
+        </dependency>
 
         <dependency>
             <groupId>org.jruby</groupId>
@@ -60,28 +98,16 @@
             <version>1.47</version>
         </dependency>
 
-        <!-- jetty -->
-        <dependency>
-            <groupId>org.mortbay.jetty</groupId>
-            <artifactId>jetty-management</artifactId>
-            <version>${jetty.version}</version>
-        </dependency>
-        <dependency>
-            <groupId>org.mortbay.jetty</groupId>
-            <artifactId>jetty-naming</artifactId>
-            <version>${jetty.version}</version>
-        </dependency>
         <dependency>
-            <groupId>org.mortbay.jetty</groupId>
-            <artifactId>jetty-sslengine</artifactId>
-            <version>${jetty.version}</version>
+            <groupId>org.slf4j</groupId>
+            <artifactId>slf4j-api</artifactId>
+            <version>1.7.2</version>
         </dependency>
         <dependency>
-            <groupId>org.mortbay.jetty</groupId>
-            <artifactId>jetty-plus</artifactId>
-            <version>${jetty.version}</version>
+            <groupId>org.slf4j</groupId>
+            <artifactId>slf4j-log4j12</artifactId>
+            <version>1.7.2</version>
         </dependency>
-        <!-- jetty end -->
     </dependencies>
 
     <build>

--- installers/server/release/server.cmd (modified) ---
additions: 1, deletions: 1, changes: 2
@@ -66,4 +66,4 @@ set OPTION=-client
 
 :done
 
-"%JAVA_CMD%" %OPTION% %YOURKIT% -Xms%SERVER_MEM% -Xmx%SERVER_MAX_MEM% -XX:PermSize=%SERVER_MIN_PERM_GEN% -XX:MaxPermSize=%SERVER_MAX_PERM_GEN% %JVM_DEBUG% %GC_LOG% %GO_SERVER_SYSTEM_PROPERTIES% -Duser.language=en -DJAVA_SYS_MON_TEMP_DIR="%SERVER_DIR%\tmp" -Dorg.mortbay.jetty.Request.maxFormContentSize=30000000 -Djruby.rack.request.size.threshold.bytes=30000000 -Duser.country=US -Dcruise.config.dir="%SERVER_DIR%\config" -Dcruise.config.file="%SERVER_DIR%\config\cruise-config.xml" -Dcruise.server.port=%GO_SERVER_PORT% -Dcruise.server.ssl.port=%GO_SERVER_SSL_PORT% -jar "%SERVER_DIR%\go.jar"
+"%JAVA_CMD%" %OPTION% %YOURKIT% -Xms%SERVER_MEM% -Xmx%SERVER_MAX_MEM% -XX:PermSize=%SERVER_MIN_PERM_GEN% -XX:MaxPermSize=%SERVER_MAX_PERM_GEN% %JVM_DEBUG% %GC_LOG% %GO_SERVER_SYSTEM_PROPERTIES% -Duser.language=en -DJAVA_SYS_MON_TEMP_DIR="%SERVER_DIR%\tmp" -Dorg.eclipse.jetty.server.Request.maxFormContentSize=30000000 -Djruby.rack.request.size.threshold.bytes=30000000 -Duser.country=US -Dcruise.config.dir="%SERVER_DIR%\config" -Dcruise.config.file="%SERVER_DIR%\config\cruise-config.xml" -Dcruise.server.port=%GO_SERVER_PORT% -Dcruise.server.ssl.port=%GO_SERVER_SSL_PORT% -jar "%SERVER_DIR%\go.jar"

--- installers/server/release/server.sh (modified) ---
additions: 1, deletions: 1, changes: 2
@@ -115,7 +115,7 @@ fi
 SERVER_STARTUP_ARGS+=("-server $YOURKIT")
 SERVER_STARTUP_ARGS+=("-Xms$SERVER_MEM -Xmx$SERVER_MAX_MEM -XX:PermSize=$SERVER_MIN_PERM_GEN -XX:MaxPermSize=$SERVER_MAX_PERM_GEN")
 SERVER_STARTUP_ARGS+=("$JVM_DEBUG $GC_LOG $GO_SERVER_SYSTEM_PROPERTIES")
-SERVER_STARTUP_ARGS+=("-Duser.language=en -Dorg.mortbay.jetty.Request.maxFormContentSize=30000000 -Djruby.rack.request.size.threshold.bytes=30000000")
+SERVER_STARTUP_ARGS+=("-Duser.language=en -Djruby.rack.request.size.threshold.bytes=30000000")
 SERVER_STARTUP_ARGS+=("-Duser.country=US -Dcruise.config.dir=$GO_CONFIG_DIR -Dcruise.config.file=$GO_CONFIG_DIR/cruise-config.xml")
 SERVER_STARTUP_ARGS+=("-Dcruise.server.port=$GO_SERVER_PORT -Dcruise.server.ssl.port=$GO_SERVER_SSL_PORT")
 if [ "$TMPDIR" != "" ]; then

--- installers/server/win/config/wrapper-server.conf (modified) ---
additions: 1, deletions: 1, changes: 2
@@ -65,7 +65,7 @@ wrapper.java.additional.10=-Dcruise.server.ssl.port=8154
 wrapper.java.additional.11="-DJAVA_SYS_MON_TEMP_DIR=%CRUISE_SERVER_DIR%\tmp"
 wrapper.java.additional.12=%JVM_DEBUG%
 wrapper.java.additional.13=%GC_LOG%
-wrapper.java.additional.14="-Dorg.mortbay.jetty.Request.maxFormContentSize=30000000"
+wrapper.java.additional.14="-Dorg.eclipse.jetty.server.Request.maxFormContentSize=30000000"
 wrapper.java.additional.15="-Djruby.rack.request.size.threshold.bytes=30000000"
 
 #include config/wrapper-properties.conf

--- jetty6/pom.xml (added) ---
additions: 323, deletions: 0, changes: 323
@@ -0,0 +1,323 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- *************************GO-LICENSE-START******************************
+ * Copyright 2014 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END******************************* -->
+
+<project xmlns="http://maven.apache.org/POM/4.0.0"
+         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
+    <modelVersion>4.0.0</modelVersion>
+
+    <groupId>com.thoughtworks.go</groupId>
+    <artifactId>jetty6</artifactId>
+    <version>1.0</version>
+
+    <parent>
+        <groupId>com.thoughtworks.go</groupId>
+        <artifactId>gocd</artifactId>
+        <version>1.0</version>
+        <relativePath>../</relativePath>
+    </parent>
+
+    <properties>
+        <jetty.version>6.1.23</jetty.version>
+    </properties>
+
+    <dependencies>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>database</artifactId>
+            <version>1.0</version>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>app-server</artifactId>
+            <version>1.0</version>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>licensing</artifactId>
+            <version>1.0</version>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>config-server</artifactId>
+            <version>1.0</version>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>common</artifactId>
+            <version>1.0</version>
+        </dependency>
+        <!-- jetty -->
+        <dependency>
+            <groupId>org.mortbay.jetty</groupId>
+            <artifactId>jetty</artifactId>
+            <version>${jetty.version}</version>
+            <scope>provided</scope>
+        </dependency>
+        <dependency>
+            <groupId>org.mortbay.jetty</groupId>
+            <artifactId>jetty-util</artifactId>
+            <version>${jetty.version}</version>
+            <scope>provided</scope>
+        </dependency>
+        <dependency>
+            <groupId>org.mortbay.jetty</groupId>
+            <artifactId>jetty-management</artifactId>
+            <version>${jetty.version}</version>
+            <scope>provided</scope>
+        </dependency>
+        <dependency>
+            <groupId>org.mortbay.jetty</groupId>
+            <artifactId>jetty-naming</artifactId>
+            <version>${jetty.version}</version>
+            <scope>provided</scope>
+        </dependency>
+        <dependency>
+            <groupId>org.mortbay.jetty</groupId>
+            <artifactId>jetty-sslengine</artifactId>
+            <version>${jetty.version}</version>
+            <scope>provided</scope>
+        </dependency>
+        <dependency>
+            <groupId>org.mortbay.jetty</groupId>
+            <artifactId>jetty-plus</artifactId>
+            <version>${jetty.version}</version>
+            <scope>provided</scope>
+        </dependency>
+        <!-- jetty end -->
+
+        <!-- apache commons -->
+        <dependency>
+            <groupId>commons-beanutils</groupId>
+            <artifactId>commons-beanutils-core</artifactId>
+            <version>1.7.0</version>
+            <exclusions>
+                <exclusion>
+                    <groupId>commons-logging</groupId>
+                    <artifactId>commons-logging</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>commons-collections</groupId>
+                    <artifactId>commons-collections</artifactId>
+                </exclusion>
+            </exclusions>
+        </dependency>
+        <dependency>
+            <groupId>commons-validator</groupId>
+            <artifactId>commons-validator</artifactId>
+            <version>1.3.1</version>
+            <exclusions>
+                <exclusion>
+                    <groupId>commons-digester</groupId>
+                    <artifactId>commons-digester</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>commons-logging</groupId>
+                    <artifactId>commons-logging</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>junit</groupId>
+                    <artifactId>junit</artifactId>
+                </exclusion>
+            </exclusions>
+        </dependency>
+        <dependency>
+            <groupId>commons-dbcp</groupId>
+            <artifactId>commons-dbcp</artifactId>
+            <version>1.4</version>
+        </dependency>
+        <dependency>
+            <groupId>commons-pool</groupId>
+            <artifactId>commons-pool</artifactId>
+            <version>1.5.6</version>
+        </dependency>
+        <!-- apache commons end -->
+
+
+        <dependency>
+            <groupId>org.springframework</groupId>
+            <artifactId>web.servlet</artifactId>
+            <version>${spring.version}</version>
+        </dependency>
+
+        <dependency>
+            <groupId>org.bouncycastle</groupId>
+            <artifactId>bcprov-jdk15on</artifactId>
+            <version>1.47</version>
+            <scope>provided</scope>
+        </dependency>
+
+        <dependency>
+            <groupId>org.slf4j</groupId>
+            <artifactId>slf4j-api</artifactId>
+            <version>1.7.2</version>
+        </dependency>
+        <dependency>
+            <groupId>org.slf4j</groupId>
+            <artifactId>slf4j-log4j12</artifactId>
+            <version>1.7.2</version>
+        </dependency>
+        <!-- test dependencies -->
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>common</artifactId>
+            <version>1.0</version>
+            <type>test-jar</type>
+            <scope>test</scope>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>config-server</artifactId>
+            <version>1.0</version>
+            <type>test-jar</type>
+            <scope>test</scope>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>config-api</artifactId>
+            <version>1.0</version>
+            <type>test-jar</type>
+            <scope>test</scope>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>metrics</artifactId>
+            <version>1.0</version>
+            <type>test-jar</type>
+            <scope>test</scope>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>test-utils</artifactId>
+            <version>1.0</version>
+            <scope>test</scope>
+        </dependency>
+        <dependency>
+            <groupId>com.tlb</groupId>
+            <artifactId>tlb-java</artifactId>
+            <version>0.3.2-90-g6df47e3</version>
+            <scope>test</scope>
+            <exclusions>
+                <exclusion>
+                    <groupId>commons-io</groupId>
+                    <artifactId>commons-io</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>commons-codec</groupId>
+                    <artifactId>commons-codec</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>log4j</groupId>
+                    <artifactId>log4j</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>xalan</groupId>
+                    <artifactId>xalan</artifactId>
+                </exclusion>
+            </exclusions>
+        </dependency>
+
+        <dependency>
+            <groupId>net.sourceforge.cobertura</groupId>
+            <artifactId>cobertura</artifactId>
+            <version>2.0.3</version>
+            <scope>test</scope>
+            <exclusions>
+                <exclusion>
+                    <groupId>log4j</groupId>
+                    <artifactId>log4j</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>com.sun</groupId>
+                    <artifactId>tools</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>org.mortbay.jetty</groupId>
+                    <artifactId>servlet-api-2.5</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>org.mortbay.jetty</groupId>
+                    <artifactId>jetty</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>org.mortbay.jetty</groupId>
+                    <artifactId>jetty-util</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>org.mortbay.jetty</groupId>
+                    <artifactId>jetty-servlet-tester</artifactId>
+                </exclusion>
+            </exclusions>
+        </dependency>
+    </dependencies>
+
+    <build>
+        <sourceDirectory>src</sourceDirectory>
+        <plugins>
+            <plugin>
+                <groupId>org.codehaus.mojo</groupId>
+                <artifactId>build-helper-maven-plugin</artifactId>
+                <version>1.8</version>
+                <executions>
+                    <execution>
+                        <id>add-test-sources</id>
+                        <phase>generate-test-sources</phase>
+                        <goals>
+                            <goal>add-test-source</goal>
+                        </goals>
+                        <configuration>
+                            <sources>
+                                <source>${project.basedir}/test/unit</source>
+                                <source>${project.basedir}/test/integration</source>
+                            </sources>
+                        </configuration>
+                    </execution>
+                </executions>
+            </plugin>
+            <plugin>
+                <groupId>org.apache.maven.plugins</groupId>
+                <artifactId>maven-compiler-plugin</artifactId>
+                <version>3.1</version>
+                <configuration>
+                    <source>1.6</source>
+                    <target>1.6</target>
+                </configuration>
+            </plugin>
+            <plugin>
+                <groupId>org.apache.maven.plugins</groupId>
+                <artifactId>maven-dependency-plugin</artifactId>
+                <version>2.4</version>
+                <executions>
+                    <execution>
+                        <id>copy-dependencies</id>
+                        <phase>compile</phase>
+                        <goals>
+                            <goal>copy-dependencies</goal>
+                        </goals>
+                        <configuration>
+                            <outputDirectory>${project.build.directory}\lib</outputDirectory>
+                            <includeScope>provided</includeScope>
+                            <overWriteReleases>false</overWriteReleases>
+                            <overWriteSnapshots>false</overWriteSnapshots>
+                            <overWriteIfNewer>true</overWriteIfNewer>
+                        </configuration>
+                    </execution>
+                </executions>
+            </plugin>
+        </plugins>
+    </build>
+</project>
\ No newline at end of file

--- jetty6/src/com/thoughtworks/go/server/Jetty6AssetsContextHandler.java (renamed) ---
additions: 19, deletions: 2, changes: 21
@@ -1,3 +1,19 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
 package com.thoughtworks.go.server;
 
 import com.thoughtworks.go.util.SystemEnvironment;
@@ -6,15 +22,16 @@
 import org.mortbay.jetty.handler.ContextHandler;
 import org.mortbay.jetty.handler.ResourceHandler;
 import org.mortbay.jetty.webapp.WebAppContext;
+
 import javax.servlet.ServletException;
 import javax.servlet.http.HttpServletRequest;
 import javax.servlet.http.HttpServletResponse;
 import java.io.IOException;
 
-public class AssetsContextHandler extends ContextHandler {
+public class Jetty6AssetsContextHandler extends ContextHandler {
     private SystemEnvironment systemEnvironment;
 
-    public AssetsContextHandler(SystemEnvironment systemEnvironment) throws IOException {
+    public Jetty6AssetsContextHandler(SystemEnvironment systemEnvironment) throws IOException {
         super(systemEnvironment.getWebappContextPath() + "/assets");
         this.systemEnvironment = systemEnvironment;
     }

--- jetty6/src/com/thoughtworks/go/server/Jetty6AssetsContextHandlerInitializer.java (added) ---
additions: 57, deletions: 0, changes: 57
@@ -0,0 +1,57 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server;
+
+import org.mortbay.component.LifeCycle;
+import org.mortbay.jetty.webapp.WebAppContext;
+
+import java.io.IOException;
+
+public class Jetty6AssetsContextHandlerInitializer implements LifeCycle.Listener{
+    private Jetty6AssetsContextHandler assetsContextHandler;
+    private WebAppContext webAppContext;
+
+    public Jetty6AssetsContextHandlerInitializer(Jetty6AssetsContextHandler assetsContextHandler, WebAppContext webAppContext){
+        this.assetsContextHandler = assetsContextHandler;
+        this.webAppContext = webAppContext;
+    }
+
+    @Override
+    public void lifeCycleStarting(LifeCycle event) {
+    }
+
+    @Override
+    public void lifeCycleStarted(LifeCycle event) {
+        try {
+            assetsContextHandler.init(webAppContext);
+        } catch (IOException e) {
+            throw new RuntimeException(e);
+        }
+    }
+
+    @Override
+    public void lifeCycleFailure(LifeCycle event, Throwable cause) {
+    }
+
+    @Override
+    public void lifeCycleStopping(LifeCycle event) {
+    }
+
+    @Override
+    public void lifeCycleStopped(LifeCycle event) {
+    }
+}

--- jetty6/src/com/thoughtworks/go/server/Jetty6GoWebXmlConfiguration.java (renamed) ---
additions: 10, deletions: 8, changes: 18
@@ -1,5 +1,5 @@
 /*************************GO-LICENSE-START*********************************
- * Copyright 2014 ThoughtWorks, Inc.
+ * Copyright 2015 ThoughtWorks, Inc.
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -16,32 +16,34 @@
 
 package com.thoughtworks.go.server;
 
+import org.mortbay.jetty.webapp.WebXmlConfiguration;
+import org.mortbay.xml.XmlParser;
+import org.xml.sax.SAXException;
+
+import javax.servlet.UnavailableException;
 import java.io.File;
 import java.io.FileInputStream;
 import java.io.IOException;
 import java.util.zip.ZipEntry;
 import java.util.zip.ZipFile;
-import javax.servlet.UnavailableException;
 
-import org.mortbay.jetty.webapp.WebXmlConfiguration;
-import org.mortbay.xml.XmlParser;
-import org.xml.sax.SAXException;
+public class Jetty6GoWebXmlConfiguration extends WebXmlConfiguration {
+    private static String webdefaultXml = "WEB-INF/webdefault-jetty6.xml";
 
-public class GoWebXmlConfiguration extends WebXmlConfiguration {
     public void initialize(String warFileLocation) throws IOException, SAXException, UnavailableException, ClassNotFoundException {
         super.initialize(configuration(WebXmlConfiguration.webXmlParser(), warFileLocation));
     }
 
     private XmlParser.Node configuration(XmlParser parser, String warFile) throws IOException, SAXException {
         XmlParser.Node node;
         if (new File(warFile).isDirectory()) {
-            FileInputStream in = new FileInputStream(new File(warFile, "WEB-INF/webdefault.xml"));
+            FileInputStream in = new FileInputStream(new File(warFile, webdefaultXml));
             node = parser.parse(in);
             in.close();
         }
         else {
             ZipFile file = new ZipFile(warFile);
-            node = parser.parse(file.getInputStream(new ZipEntry("WEB-INF/webdefault.xml")));
+            node = parser.parse(file.getInputStream(new ZipEntry(webdefaultXml)));
             file.close();
         }
         return node;

--- jetty6/src/com/thoughtworks/go/server/Jetty6Server.java (added) ---
additions: 232, deletions: 0, changes: 232
@@ -0,0 +1,232 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server;
+
+import com.thoughtworks.go.server.util.GoJetty6CipherSuite;
+import com.thoughtworks.go.server.util.GoJetty6SslSocketConnector;
+import com.thoughtworks.go.util.GoConstants;
+import com.thoughtworks.go.util.SystemEnvironment;
+import org.apache.log4j.Logger;
+import org.mortbay.jetty.Connector;
+import org.mortbay.jetty.HttpMethods;
+import org.mortbay.jetty.HttpStatus;
+import org.mortbay.jetty.Server;
+import org.mortbay.jetty.handler.ContextHandler;
+import org.mortbay.jetty.nio.SelectChannelConnector;
+import org.mortbay.jetty.servlet.ServletHolder;
+import org.mortbay.jetty.webapp.WebAppContext;
+import org.mortbay.management.MBeanContainer;
+import org.mortbay.xml.XmlConfiguration;
+import org.xml.sax.SAXException;
+
+import javax.management.MBeanServer;
+import javax.net.ssl.SSLSocketFactory;
+import javax.servlet.ServletException;
+import javax.servlet.UnavailableException;
+import javax.servlet.http.HttpServletRequest;
+import javax.servlet.http.HttpServletResponse;
+import java.io.File;
+import java.io.FileInputStream;
+import java.io.IOException;
+import java.io.PrintWriter;
+import java.lang.management.ManagementFactory;
+import java.util.Map;
+
+public class Jetty6Server extends AppServer {
+
+    private final Server server;
+    private final GoJetty6CipherSuite goCipherSuite;
+    private Jetty6GoWebXmlConfiguration configuration;
+    private WebAppContext webAppContext;
+    private static final Logger LOG = Logger.getLogger(Jetty6Server.class);
+
+    public Jetty6Server(SystemEnvironment systemEnvironment, String password, SSLSocketFactory sslSocketFactory) {
+        this(systemEnvironment, password, sslSocketFactory, new Server(), new GoJetty6CipherSuite(sslSocketFactory), new Jetty6GoWebXmlConfiguration());
+    }
+
+    Jetty6Server(SystemEnvironment systemEnvironment, String password, SSLSocketFactory sslSocketFactory, Server server, GoJetty6CipherSuite goJetty6CipherSuite, Jetty6GoWebXmlConfiguration configuration) {
+        super(systemEnvironment, password, sslSocketFactory);
+        this.server = server;
+        this.goCipherSuite = goJetty6CipherSuite;
+        this.configuration = configuration;
+    }
+
+    @Override
+    void addExtraJarsToClasspath(String extraClasspath) {
+        webAppContext.setExtraClasspath(extraClasspath);
+    }
+
+    @Override
+    void setCookieExpirePeriod(int cookieExpirePeriod) {
+        webAppContext.getSessionHandler().getSessionManager().setMaxCookieAge(cookieExpirePeriod);
+    }
+
+    @Override
+    void setInitParameter(String name, String value) {
+        Map existingParams = webAppContext.getInitParams();
+        existingParams.put(name, value);
+        webAppContext.setInitParams(existingParams);
+    }
+
+    @Override
+    void addStopServlet() {
+        ServletHolder holder = new ServletHolder();
+        holder.setServlet(new StopJettyFromLocalhostServlet(this));
+        webAppContext.addServlet(holder, "/jetty/stop");
+    }
+
+    @Override
+    Throwable getUnavailableException() {
+        return webAppContext.getUnavailableException();
+    }
+
+    @Override
+    void configure() throws Exception {
+        server.getContainer().addEventListener(mbeans());
+
+        server.addConnector(selectChannelConnector());
+        server.addConnector(sslConnector());
+
+        server.addHandler(welcomeFileHandler());
+        server.addHandler(legacyRequestHandler());
+        WebAppContext webAppContext = webApp();
+        addResourceHandler(webAppContext);
+        server.addHandler(webAppContext);
+        this.webAppContext = webAppContext;
+        performCustomConfiguration();
+        server.setStopAtShutdown(true);
+    }
+
+    private void addResourceHandler(WebAppContext webAppContext) throws IOException {
+        if (!systemEnvironment.useCompressedJs())
+            return;
+        Jetty6AssetsContextHandler handler = new Jetty6AssetsContextHandler(systemEnvironment);
+        server.addHandler(handler);
+        webAppContext.addLifeCycleListener(new Jetty6AssetsContextHandlerInitializer(handler, webAppContext));
+    }
+
+    private void performCustomConfiguration() throws Exception {
+        File jettyConfig = new File(systemEnvironment.getConfigDir(), "jetty6.xml");
+        if (jettyConfig.exists()) {
+            LOG.info("Configuring Jetty using " + jettyConfig.getAbsolutePath());
+            FileInputStream serverConfiguration = new FileInputStream(jettyConfig);
+            XmlConfiguration configuration = new XmlConfiguration(serverConfiguration);
+            configuration.configure(server);
+        } else {
+            String message = String.format(
+                    "No custom jetty configuration (%s) found, using defaults.",
+                    jettyConfig.getAbsolutePath());
+            LOG.info(message);
+        }
+    }
+
+    private MBeanContainer mbeans() {
+        MBeanServer platformMBeanServer = ManagementFactory.getPlatformMBeanServer();
+        MBeanContainer mbeans = new MBeanContainer(platformMBeanServer);
+        mbeans.start();
+        return mbeans;
+    }
+
+    private Connector sslConnector() {
+        return new GoJetty6SslSocketConnector(password, systemEnvironment, goCipherSuite).sslConnector();
+    }
+
+    private SelectChannelConnector selectChannelConnector() {
+        SelectChannelConnector connector = new SelectChannelConnector();
+        connector.setPort(systemEnvironment.getServerPort());
+        connector.setHost(systemEnvironment.getListenHost());
+        return connector;
+    }
+
+    WebAppContext webApp() throws IOException, SAXException, ClassNotFoundException, UnavailableException {
+        WebAppContext wac = new WebAppContext();
+        configuration.setWebAppContext(wac);
+        configuration.initialize(systemEnvironment.getCruiseWar());
+
+        wac.setConfigurationClasses(new String[]{
+                "org.mortbay.jetty.webapp.WebInfConfiguration",
+                "org.mortbay.jetty.webapp.WebXmlConfiguration",
+                "org.mortbay.jetty.webapp.JettyWebXmlConfiguration",
+        });
+        wac.setContextPath(systemEnvironment.getWebappContextPath());
+        wac.setWar(systemEnvironment.getCruiseWar());
+        wac.setParentLoaderPriority(systemEnvironment.getParentLoaderPriority());
+        return wac;
+    }
+
+    ContextHandler welcomeFileHandler() {
+        return new GoServerWelcomeFileHandler();
+    }
+
+    ContextHandler legacyRequestHandler() {
+        return new LegacyUrlRequestHandler();
+    }
+
+    class LegacyUrlRequestHandler extends ContextHandler {
+
+        LegacyUrlRequestHandler() {
+            super(GoConstants.OLD_URL_CONTEXT);
+        }
+
+        public void handle(String target, HttpServletRequest request, HttpServletResponse response, int dispatch) throws IOException, ServletException {
+            if (target.startsWith(GoConstants.OLD_URL_CONTEXT + "/") || target.equals(GoConstants.OLD_URL_CONTEXT)) {
+                if (shouldRedirect(request)) {
+                    response.setHeader("Location", target.replaceFirst(GoConstants.OLD_URL_CONTEXT, GoConstants.GO_URL_CONTEXT));
+                    response.setStatus(HttpStatus.ORDINAL_301_Moved_Permanently);
+                } else {
+                    response.setStatus(HttpStatus.ORDINAL_404_Not_Found);
+                }
+                response.setHeader("Content-Type", "text/plain");
+                PrintWriter writer = response.getWriter();
+                writer.write(String.format("Url(s) starting in '%s' have been permanently moved to '%s', please use the new path.", GoConstants.OLD_URL_CONTEXT, GoConstants.GO_URL_CONTEXT));
+                writer.close();
+            }
+        }
+
+        boolean shouldRedirect(HttpServletRequest request) {
+            String method = request.getMethod();
+            return method.equals(HttpMethods.GET) || method.equals(HttpMethods.HEAD);
+        }
+    }
+
+    class GoServerWelcomeFileHandler extends ContextHandler {
+        GoServerWelcomeFileHandler() {
+            super("/");
+        }
+
+        public void handle(String target, HttpServletRequest request, HttpServletResponse response, int dispatch) throws IOException, ServletException {
+            if (target.equals("/")) {
+                response.setHeader("Location", GoConstants.GO_URL_CONTEXT + "/home");
+                response.setStatus(301);
+                response.setHeader("Content-Type", "text/html");
+                PrintWriter writer = response.getWriter();
+                writer.write("redirecting..");
+                writer.close();
+            }
+        }
+    }
+
+    @Override
+    void start() throws Exception {
+        server.start();
+    }
+
+    @Override
+    void stop() throws Exception {
+        server.stop();
+    }
+}

--- jetty6/src/com/thoughtworks/go/server/util/GoJetty6CipherSuite.java (renamed) ---
additions: 4, deletions: 4, changes: 8
@@ -1,5 +1,5 @@
 /*************************GO-LICENSE-START*********************************
- * Copyright 2014 ThoughtWorks, Inc.
+ * Copyright 2015 ThoughtWorks, Inc.
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -16,16 +16,16 @@
 
 package com.thoughtworks.go.server.util;
 
+import javax.net.ssl.SSLSocketFactory;
 import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.List;
-import javax.net.ssl.SSLSocketFactory;
 
-public class GoCipherSuite {
+public class GoJetty6CipherSuite {
     private final SSLSocketFactory socketFactory;
     private List cipherSuitesSupportedByGo = Arrays.asList("SSL_RSA_WITH_RC4_128_SHA", "SSL_RSA_EXPORT_WITH_RC4_40_MD5", "SSL_RSA_WITH_RC4_128_MD5");
 
-    public GoCipherSuite(SSLSocketFactory socketFactory) {
+    public GoJetty6CipherSuite(SSLSocketFactory socketFactory) {
         this.socketFactory = socketFactory;
     }
 

--- jetty6/src/com/thoughtworks/go/server/util/GoJetty6SslSocketConnector.java (renamed) ---
additions: 9, deletions: 9, changes: 18
@@ -1,5 +1,5 @@
 /*************************GO-LICENSE-START*********************************
- * Copyright 2014 ThoughtWorks, Inc.
+ * Copyright 2015 ThoughtWorks, Inc.
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -16,33 +16,33 @@
 
 package com.thoughtworks.go.server.util;
 
-import java.io.File;
-import java.net.InetAddress;
-import java.net.UnknownHostException;
-
 import com.thoughtworks.go.security.X509CertificateGenerator;
 import com.thoughtworks.go.util.SystemEnvironment;
 import org.apache.log4j.Logger;
 import org.mortbay.jetty.Connector;
 import org.mortbay.jetty.security.SslSelectChannelConnector;
 import org.mortbay.jetty.security.SslSocketConnector;
 
+import java.io.File;
+import java.net.InetAddress;
+import java.net.UnknownHostException;
+
 import static com.thoughtworks.go.util.ExceptionUtils.bomb;
 
-public class GoSslSocketConnector {
+public class GoJetty6SslSocketConnector {
 
-    private static Logger LOGGER = Logger.getLogger(GoSslSocketConnector.class);
+    private static Logger LOGGER = Logger.getLogger(GoJetty6SslSocketConnector.class);
 
     private final String password;
     private final SystemEnvironment systemEnvironment;
-    private final GoCipherSuite goCipherSuite;
+    private final GoJetty6CipherSuite goCipherSuite;
     private final int sslPort;
     private final File keystore;
     private final File truststore;
     private final File agentKeystore;
     private static final int MAX_IDLE_TIME = 30000;
 
-    public GoSslSocketConnector(String password, SystemEnvironment systemEnvironment, GoCipherSuite goCipherSuite) {
+    public GoJetty6SslSocketConnector(String password, SystemEnvironment systemEnvironment, GoJetty6CipherSuite goCipherSuite) {
         this.password = password;
         this.systemEnvironment = systemEnvironment;
         this.goCipherSuite = goCipherSuite;

--- jetty6/src/com/thoughtworks/go/server/util/Jetty6Request.java (added) ---
additions: 47, deletions: 0, changes: 47
@@ -0,0 +1,47 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+import org.mortbay.jetty.Request;
+
+public class Jetty6Request implements ServletRequest {
+    private Request request;
+
+    public Jetty6Request(javax.servlet.ServletRequest request) {
+        this.request = (Request) request;
+    }
+
+    @Override
+    public String getUrl() {
+        return request.getRootURL().append(getUriAsString()).toString();
+    }
+
+    @Override
+    public String getUriPath() {
+        return request.getUri().getPath();
+    }
+
+    @Override
+    public String getUriAsString() {
+        return request.getUri().toString();
+    }
+
+    @Override
+    public void setRequestURI(String uri) {
+        request.setRequestURI(uri);
+    }
+}

--- jetty6/src/com/thoughtworks/go/server/util/Jetty6Response.java (added) ---
additions: 37, deletions: 0, changes: 37
@@ -0,0 +1,37 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+import org.mortbay.jetty.Response;
+
+public class Jetty6Response implements ServletResponse {
+    private javax.servlet.ServletResponse servletResponse;
+
+    public Jetty6Response(javax.servlet.ServletResponse servletResponse) {
+        this.servletResponse = servletResponse;
+    }
+
+    @Override
+    public int getStatus() {
+        return ((Response) servletResponse).getStatus();
+    }
+
+    @Override
+    public long getContentCount() {
+        return ((Response) servletResponse).getContentCount();
+    }
+}

--- jetty6/src/com/thoughtworks/go/server/util/Jetty6ServletHelper.java (added) ---
additions: 39, deletions: 0, changes: 39
@@ -0,0 +1,39 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+import org.mortbay.util.UrlEncoded;
+
+//Do not delete. Invoked using reflection
+public class Jetty6ServletHelper extends ServletHelper {
+    @Override
+    public ServletRequest getRequest(javax.servlet.ServletRequest servletRequest) {
+        return new Jetty6Request(servletRequest);
+    }
+
+    @Override
+    public ServletResponse getResponse(javax.servlet.ServletResponse servletResponse) {
+        return new Jetty6Response(servletResponse);
+    }
+
+    @Override
+    public String encodeString(String string) {
+        return UrlEncoded.encodeString(string);
+    }
+
+}
+

--- jetty6/test/integration/com/thoughtworks/go/server/GoServerContextHandlersTest.java (added) ---
additions: 109, deletions: 0, changes: 109
@@ -0,0 +1,109 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server;
+
+import com.thoughtworks.go.server.util.GoJetty6CipherSuite;
+import com.thoughtworks.go.util.SystemEnvironment;
+import org.junit.Before;
+import org.junit.experimental.theories.DataPoint;
+import org.junit.experimental.theories.Theories;
+import org.junit.experimental.theories.Theory;
+import org.junit.runner.RunWith;
+import org.mortbay.jetty.*;
+
+import javax.net.ssl.SSLSocketFactory;
+import javax.servlet.ServletException;
+import javax.servlet.http.HttpServletRequest;
+import javax.servlet.http.HttpServletResponse;
+import java.io.ByteArrayOutputStream;
+import java.io.IOException;
+import java.io.PrintWriter;
+
+import static org.hamcrest.CoreMatchers.is;
+import static org.junit.Assert.assertThat;
+import static org.mockito.Mockito.*;
+
+@RunWith(Theories.class)
+public class GoServerContextHandlersTest {
+    private Handler legacyHandler;
+
+    @Before
+    public void setUp() throws Exception {
+        Jetty6Server jettyServer = new Jetty6Server(mock(SystemEnvironment.class), "pwd", mock(SSLSocketFactory.class), new Server(), mock(GoJetty6CipherSuite.class), mock(Jetty6GoWebXmlConfiguration.class));
+        legacyHandler = jettyServer.legacyRequestHandler();
+    }
+
+    static class HttpCall {
+        final String url;
+        final String method;
+        final int expectedResponse;
+        final boolean shouldRedirect;
+
+        HttpCall(String url, String method, int expectedResponse, boolean shouldRedirect) {
+            this.url = url;
+            this.method = method;
+            this.expectedResponse = expectedResponse;
+            this.shouldRedirect = shouldRedirect;
+        }
+
+        @Override public String toString() {
+            return "HttpCall{" +
+                    "url='" + url + '\'' +
+                    ", method='" + method + '\'' +
+                    ", expectedResponse=" + expectedResponse +
+                    ", shouldRedirect=" + shouldRedirect +
+                    '}';
+        }
+    }
+
+    @DataPoint public static final HttpCall GET_CALL_TO_CRUISE = new HttpCall("/foo/bar?baz=quux", HttpMethods.GET, HttpStatus.ORDINAL_301_Moved_Permanently, true);
+    @DataPoint public static final HttpCall GET_CALL_TO_CRUISE_WITH_NO_SUBPATH = new HttpCall("", HttpMethods.GET, HttpStatus.ORDINAL_301_Moved_Permanently, true);
+    @DataPoint public static final HttpCall HEAD_CALL_TO_CRUISE = new HttpCall("/foo/bar?baz=quux", HttpMethods.HEAD, HttpStatus.ORDINAL_301_Moved_Permanently, true);
+    @DataPoint public static final HttpCall HEAD_CALL_TO_CRUISE_WITH_NO_SUBPATH = new HttpCall("", HttpMethods.HEAD, HttpStatus.ORDINAL_301_Moved_Permanently, true);
+
+    @DataPoint public static final HttpCall PUT_CALL_TO_CRUISE = new HttpCall("/foo/bar?baz=quux", HttpMethods.PUT, HttpStatus.ORDINAL_404_Not_Found, false);
+    @DataPoint public static final HttpCall POST_CALL_TO_CRUISE = new HttpCall("/foo/bar?baz=quux", HttpMethods.POST, HttpStatus.ORDINAL_404_Not_Found, false);
+    @DataPoint public static final HttpCall DELETE_CALL_TO_CRUISE = new HttpCall("/foo/bar?baz=quux", HttpMethods.DELETE, HttpStatus.ORDINAL_404_Not_Found, false);
+    @DataPoint public static final HttpCall OPTIONS_CALL_TO_CRUISE = new HttpCall("/foo/bar?baz=quux", HttpMethods.OPTIONS, HttpStatus.ORDINAL_404_Not_Found, false);
+    @DataPoint public static final HttpCall TRACE_CALL_TO_CRUISE = new HttpCall("/foo/bar?baz=quux", HttpMethods.TRACE, HttpStatus.ORDINAL_404_Not_Found, false);
+    @DataPoint public static final HttpCall CONNECT_CALL_TO_CRUISE = new HttpCall("/foo/bar?baz=quux", HttpMethods.CONNECT, HttpStatus.ORDINAL_404_Not_Found, false);
+    @DataPoint public static final HttpCall MOVE_CALL_TO_CRUISE = new HttpCall("/foo/bar?baz=quux", HttpMethods.MOVE, HttpStatus.ORDINAL_404_Not_Found, false);
+
+    @Theory
+    public void shouldRedirectCruiseContextTargetedRequestsToCorrespondingGoUrl(HttpCall httpCall) throws IOException, ServletException {
+        HttpServletResponse response = mock(HttpServletResponse.class);
+
+        ByteArrayOutputStream output = new ByteArrayOutputStream();
+        when(response.getWriter()).thenReturn(new PrintWriter(output));
+        HttpServletRequest request = mock(HttpServletRequest.class);
+        when(request.getMethod()).thenReturn(httpCall.method);
+        legacyHandler.handle("/cruise" + httpCall.url, request, response, Handler.REQUEST);
+
+        String responseBody = new String(output.toByteArray());
+        assertThat(responseBody, is("Url(s) starting in '/cruise' have been permanently moved to '/go', please use the new path."));
+
+        verify(response).setStatus(httpCall.expectedResponse);
+
+        if (httpCall.shouldRedirect) {
+            verify(response).setHeader("Location", "/go" + httpCall.url);
+        }
+
+        verify(response).setHeader(HttpHeaders.CONTENT_TYPE, "text/plain");
+        verify(response).getWriter();
+        verifyNoMoreInteractions(response);
+    }
+}

--- jetty6/test/unit/com/thoughtworks/go/server/Jetty6AssetsContextHandlerInitializerTest.java (added) ---
additions: 46, deletions: 0, changes: 46
@@ -0,0 +1,46 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server;
+
+import org.junit.Test;
+import org.mortbay.jetty.webapp.WebAppContext;
+
+import java.io.IOException;
+
+import static org.mockito.Mockito.*;
+
+public class Jetty6AssetsContextHandlerInitializerTest {
+    @Test
+    public void shouldInitializeHandlerOnWebappContextLifeCycleStarted() throws IOException {
+        Jetty6AssetsContextHandler handler = mock(Jetty6AssetsContextHandler.class);
+        WebAppContext webAppContext = mock(WebAppContext.class);
+        Jetty6AssetsContextHandlerInitializer initializer = new Jetty6AssetsContextHandlerInitializer(handler, webAppContext);
+        initializer.lifeCycleStarted(null);
+        verify(handler, times(1)).init(webAppContext);
+    }
+
+    @Test
+    public void shouldNotInitializeHandlerOnOtherWebappContextLifeCycleEvents() throws IOException {
+        Jetty6AssetsContextHandler handler = mock(Jetty6AssetsContextHandler.class);
+        WebAppContext webAppContext = mock(WebAppContext.class);
+        Jetty6AssetsContextHandlerInitializer initializer = new Jetty6AssetsContextHandlerInitializer(handler, webAppContext);
+        initializer.lifeCycleStarting(null);
+        verify(handler, never()).init(webAppContext);
+    }
+
+
+}
\ No newline at end of file

--- jetty6/test/unit/com/thoughtworks/go/server/Jetty6AssetsContextHandlerTest.java (renamed) ---
additions: 25, deletions: 6, changes: 31
@@ -1,3 +1,19 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
 package com.thoughtworks.go.server;
 
 import com.thoughtworks.go.util.OperatingSystem;
@@ -10,22 +26,25 @@
 import org.mortbay.jetty.handler.ResourceHandler;
 import org.mortbay.jetty.webapp.WebAppContext;
 import org.mortbay.resource.Resource;
+
 import javax.servlet.ServletException;
 import javax.servlet.http.HttpServletResponse;
 import java.io.File;
 import java.io.IOException;
+
 import static org.hamcrest.core.Is.is;
-import static org.junit.Assert.assertThat;
+import static org.junit.Assert.*;
 import static org.mockito.Mockito.*;
+import static org.mockito.Mockito.never;
 
-public class AssetsContextHandlerTest {
+public class Jetty6AssetsContextHandlerTest {
     @Test
     public void shouldSetHeadersAndBaseDirectory() throws IOException {
         SystemEnvironment systemEnvironment = mock(SystemEnvironment.class);
         WebAppContext webAppContext = mock(WebAppContext.class);
         when(webAppContext.getInitParameter("rails.root")).thenReturn("rails.root");
         when(webAppContext.getWebInf()).thenReturn(Resource.newResource("WEB-INF"));
-        AssetsContextHandler handler = new AssetsContextHandler(systemEnvironment);
+        Jetty6AssetsContextHandler handler = new Jetty6AssetsContextHandler(systemEnvironment);
         handler.init(webAppContext);
         assertThat(handler.getHandler() instanceof ResourceHandler, is(true));
         ResourceHandler resourceHandler = (ResourceHandler) handler.getHandler();
@@ -41,7 +60,7 @@ public void shouldHandleIfTargetMatchesContextPath() throws IOException, Servlet
         WebAppContext webAppContext = mock(WebAppContext.class);
         when(webAppContext.getInitParameter("rails.root")).thenReturn("rails.root");
         when(webAppContext.getWebInf()).thenReturn(Resource.newResource("WEB-INF"));
-        AssetsContextHandler handler = spy(new AssetsContextHandler(systemEnvironment));
+        Jetty6AssetsContextHandler handler = spy(new Jetty6AssetsContextHandler(systemEnvironment));
         handler.init(webAppContext);
         Request request = mock(Request.class);
         HttpServletResponse response = mock(HttpServletResponse.class);
@@ -58,7 +77,7 @@ public void shouldNotHandleOnlyIfTargetDoesNotMatcheContextPath() throws IOExcep
         WebAppContext webAppContext = mock(WebAppContext.class);
         when(webAppContext.getInitParameter("rails.root")).thenReturn("rails.root");
         when(webAppContext.getWebInf()).thenReturn(Resource.newResource("WEB-INF"));
-        AssetsContextHandler handler = spy(new AssetsContextHandler(systemEnvironment));
+        Jetty6AssetsContextHandler handler = spy(new Jetty6AssetsContextHandler(systemEnvironment));
         handler.init(webAppContext);
         Request request = mock(Request.class);
         HttpServletResponse response = mock(HttpServletResponse.class);
@@ -75,7 +94,7 @@ public void shouldNotHandleForRails4DevelopmentMode() throws IOException, Servle
         WebAppContext webAppContext = mock(WebAppContext.class);
         when(webAppContext.getInitParameter("rails.root")).thenReturn("rails.root");
         when(webAppContext.getWebInf()).thenReturn(Resource.newResource("WEB-INF"));
-        AssetsContextHandler handler = spy(new AssetsContextHandler(systemEnvironment));
+        Jetty6AssetsContextHandler handler = spy(new Jetty6AssetsContextHandler(systemEnvironment));
         handler.init(webAppContext);
         Request request = mock(Request.class);
         HttpServletResponse response = mock(HttpServletResponse.class);

--- jetty6/test/unit/com/thoughtworks/go/server/Jetty6ContextHandlerTest.java (added) ---
additions: 105, deletions: 0, changes: 105
@@ -0,0 +1,105 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server;
+
+import com.thoughtworks.go.server.util.GoJetty6CipherSuite;
+import com.thoughtworks.go.util.SystemEnvironment;
+import org.junit.Before;
+import org.junit.Test;
+import org.mortbay.jetty.*;
+
+import javax.net.ssl.SSLSocketFactory;
+import javax.servlet.ServletException;
+import javax.servlet.http.HttpServletRequest;
+import javax.servlet.http.HttpServletResponse;
+import java.io.ByteArrayOutputStream;
+import java.io.IOException;
+import java.io.PrintWriter;
+
+import static org.hamcrest.CoreMatchers.is;
+import static org.junit.Assert.assertThat;
+import static org.mockito.Mockito.*;
+
+public class Jetty6ContextHandlerTest {
+
+    private Jetty6Server jetty6Server;
+
+    @Before
+    public void setUp() throws Exception {
+        jetty6Server = new Jetty6Server(mock(SystemEnvironment.class), "pwd", mock(SSLSocketFactory.class), mock(Server.class), mock(GoJetty6CipherSuite.class), mock(Jetty6GoWebXmlConfiguration.class));
+    }
+
+    @Test
+    public void shouldGetWelcomeFileHandlerToHandleRequestsToRootUrl() throws IOException, ServletException {
+        Jetty6Server.GoServerWelcomeFileHandler welcomeFileHandler = (Jetty6Server.GoServerWelcomeFileHandler) jetty6Server.welcomeFileHandler();
+        HttpServletResponse response = mock(HttpServletResponse.class);
+        ByteArrayOutputStream output = new ByteArrayOutputStream();
+        when(response.getWriter()).thenReturn(new PrintWriter(output));
+
+        welcomeFileHandler.handle("/", mock(HttpServletRequest.class), response, 1);
+        String responseBody = new String(output.toByteArray());
+        assertThat(responseBody, is("redirecting.."));
+
+        verify(response).setHeader("Location", "/go/home");
+        verify(response).setStatus(HttpStatus.ORDINAL_301_Moved_Permanently);
+        verify(response).setHeader(HttpHeaders.CONTENT_TYPE, "text/html");
+        verify(response).getWriter();
+        verifyNoMoreInteractions(response);
+    }
+
+    @Test
+    public void shouldGetWelcomeFileHandlerToIgnoreRequestsToNonRootUrl() throws IOException, ServletException {
+        Jetty6Server.GoServerWelcomeFileHandler welcomeFileHandler = (Jetty6Server.GoServerWelcomeFileHandler) jetty6Server.welcomeFileHandler();
+        HttpServletResponse response = mock(HttpServletResponse.class);
+
+        welcomeFileHandler.handle("/foo", mock(HttpServletRequest.class), response, 1);
+        verifyNoMoreInteractions(response);
+    }
+
+    @Test
+    public void shouldGetLegacyRequestHandlerToHandleAllRequestSentToCruiseUrl() throws IOException, ServletException {
+        Jetty6Server.LegacyUrlRequestHandler legacyUrlRequestHandler = (Jetty6Server.LegacyUrlRequestHandler) jetty6Server.legacyRequestHandler();
+        HttpServletResponse response = mock(HttpServletResponse.class);
+        PrintWriter writer = mock(PrintWriter.class);
+        when(response.getWriter()).thenReturn(writer);
+        HttpServletRequest request = mock(HttpServletRequest.class);
+        when(request.getMethod()).thenReturn(HttpMethods.GET);
+
+        legacyUrlRequestHandler.handle("/cruise/foo", request, response, 1);
+        verify(response).setHeader("Location", "/go/foo");
+        verify(response).setStatus(HttpStatus.ORDINAL_301_Moved_Permanently);
+        verify(response).setHeader("Content-Type", "text/plain");
+        verify(writer).write(String.format("Url(s) starting in '/cruise' have been permanently moved to '/go', please use the new path."));
+        verify(writer).close();
+    }
+
+    @Test
+    public void shouldNotRedirectNonCruiseRequestsToGoPage() throws IOException, ServletException {
+        Handler legacyRequestHandler = jetty6Server.legacyRequestHandler();
+        HttpServletResponse response = mock(HttpServletResponse.class);
+
+        when(response.getWriter()).thenReturn(new PrintWriter(new ByteArrayOutputStream()));
+
+        HttpServletRequest req = mock(HttpServletRequest.class);
+        when(req.getMethod()).thenReturn(HttpMethods.GET);
+        legacyRequestHandler.handle("/cruise_but_not_quite", req, response, Handler.REQUEST);
+        verifyNoMoreInteractions(response);
+        legacyRequestHandler.handle("/something_totally_different", req, response, Handler.REQUEST);
+        verifyNoMoreInteractions(response);
+    }
+
+}

--- jetty6/test/unit/com/thoughtworks/go/server/Jetty6ServerTest.java (added) ---
additions: 233, deletions: 0, changes: 233
@@ -0,0 +1,233 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server;
+
+import com.thoughtworks.go.server.util.GoJetty6CipherSuite;
+import com.thoughtworks.go.util.ArrayUtil;
+import com.thoughtworks.go.util.ReflectionUtil;
+import com.thoughtworks.go.util.SystemEnvironment;
+import org.hamcrest.CoreMatchers;
+import org.junit.After;
+import org.junit.Before;
+import org.junit.Rule;
+import org.junit.Test;
+import org.junit.rules.TemporaryFolder;
+import org.mockito.ArgumentCaptor;
+import org.mortbay.component.Container;
+import org.mortbay.jetty.Connector;
+import org.mortbay.jetty.Server;
+import org.mortbay.jetty.handler.ContextHandler;
+import org.mortbay.jetty.nio.SelectChannelConnector;
+import org.mortbay.jetty.security.SslSelectChannelConnector;
+import org.mortbay.jetty.webapp.JettyWebXmlConfiguration;
+import org.mortbay.jetty.webapp.WebAppContext;
+import org.mortbay.jetty.webapp.WebInfConfiguration;
+import org.mortbay.jetty.webapp.WebXmlConfiguration;
+import org.mortbay.management.MBeanContainer;
+
+import javax.net.ssl.SSLSocketFactory;
+import java.util.Arrays;
+import java.util.List;
+
+import static org.hamcrest.core.Is.is;
+import static org.hamcrest.core.IsNot.not;
+import static org.hamcrest.core.IsNull.nullValue;
+import static org.junit.Assert.assertThat;
+import static org.junit.Assert.fail;
+import static org.mockito.Mockito.*;
+
+public class Jetty6ServerTest {
+
+    private Jetty6Server jetty6Server;
+    private Server server;
+    private SystemEnvironment systemEnvironment;
+    @Rule
+    public TemporaryFolder temporaryFolder = new TemporaryFolder();
+    private SSLSocketFactory sslSocketFactory;
+    private Container container;
+    private GoJetty6CipherSuite goJetty6CipherSuite;
+    private Jetty6GoWebXmlConfiguration configuration;
+
+
+    @Before
+    public void setUp() throws Exception {
+        server = mock(Server.class);
+        container = mock(Container.class);
+        when(server.getContainer()).thenReturn(container);
+        systemEnvironment = mock(SystemEnvironment.class);
+        when(systemEnvironment.getServerPort()).thenReturn(1234);
+        when(systemEnvironment.getSslServerPort()).thenReturn(4567);
+        when(systemEnvironment.keystore()).thenReturn(temporaryFolder.newFolder());
+        when(systemEnvironment.truststore()).thenReturn(temporaryFolder.newFolder());
+        when(systemEnvironment.getWebappContextPath()).thenReturn("context");
+        when(systemEnvironment.getCruiseWar()).thenReturn("cruise.war");
+        when(systemEnvironment.getParentLoaderPriority()).thenReturn(true);
+        when(systemEnvironment.useCompressedJs()).thenReturn(true);
+        when(systemEnvironment.useNioSslSocket()).thenReturn(true);
+        when(systemEnvironment.getListenHost()).thenReturn("localhost");
+        when(systemEnvironment.getParentLoaderPriority()).thenReturn(false);
+        when(systemEnvironment.get(SystemEnvironment.RESPONSE_BUFFER_SIZE)).thenReturn(1000);
+        when(systemEnvironment.get(SystemEnvironment.IDLE_TIMEOUT)).thenReturn(2000);
+
+        sslSocketFactory = mock(SSLSocketFactory.class);
+        when(sslSocketFactory.getSupportedCipherSuites()).thenReturn(new String[]{});
+        goJetty6CipherSuite = mock(GoJetty6CipherSuite.class);
+        when(goJetty6CipherSuite.getExcludedCipherSuites()).thenReturn(new String[]{"CS1", "CS2"});
+        configuration = mock(Jetty6GoWebXmlConfiguration.class);
+        jetty6Server = new Jetty6Server(systemEnvironment, "pwd", sslSocketFactory, server, goJetty6CipherSuite, configuration);
+    }
+
+    @After
+    public void tearDown() throws Exception {
+        verify(configuration).initialize(systemEnvironment.getCruiseWar());
+    }
+
+    @Test
+    public void shouldAddMBeanContainerAsEventListener() throws Exception {
+        ArgumentCaptor<MBeanContainer> captor = ArgumentCaptor.forClass(MBeanContainer.class);
+        jetty6Server.configure();
+
+        verify(container).addEventListener(captor.capture());
+        MBeanContainer mBeanContainer = captor.getValue();
+        assertThat(mBeanContainer.getMBeanServer(), is(not(nullValue())));
+    }
+
+    @Test
+    public void shouldAddHttpSocketConnector() throws Exception {
+        ArgumentCaptor<Connector> captor = ArgumentCaptor.forClass(Connector.class);
+        jetty6Server.configure();
+
+        verify(server, times(2)).addConnector(captor.capture());
+
+        List<Connector> connectors = captor.getAllValues();
+        Connector plainConnector = connectors.get(0);
+
+        assertThat(plainConnector instanceof SelectChannelConnector, is(true));
+        SelectChannelConnector connector = (SelectChannelConnector) plainConnector;
+        assertThat(connector.getPort(), is(1234));
+        assertThat(connector.getHost(), is("localhost"));
+    }
+
+    @Test
+    public void shouldAddSSLSocketConnector() throws Exception {
+        ArgumentCaptor<Connector> captor = ArgumentCaptor.forClass(Connector.class);
+        jetty6Server.configure();
+
+        verify(server, times(2)).addConnector(captor.capture());
+        List<Connector> connectors = captor.getAllValues();
+        Connector sslConnector = connectors.get(1);
+
+        assertThat(sslConnector instanceof SslSelectChannelConnector, is(true));
+        SslSelectChannelConnector connector = (SslSelectChannelConnector) sslConnector;
+
+
+        assertThat(connector.getPort(), is(4567));
+        assertThat(connector.getHost(), is("localhost"));
+        assertThat(connector.getMaxIdleTime(), is(30000));
+        assertThat(connector.getWantClientAuth(), is(true));
+        assertThat(connector.getExcludeCipherSuites(), is(new String[]{"CS1", "CS2"}));
+    }
+
+    @Test
+    public void shouldAddWelcomeRequestHandler() throws Exception {
+        ArgumentCaptor<ContextHandler> captor = ArgumentCaptor.forClass(ContextHandler.class);
+        jetty6Server.configure();
+
+        verify(server, times(4)).addHandler(captor.capture());
+        List<ContextHandler> handlers = captor.getAllValues();
+        assertThat(handlers.size(), is(4));
+        ContextHandler handler = handlers.get(0);
+        assertThat(handler instanceof Jetty6Server.GoServerWelcomeFileHandler, is(true));
+
+        Jetty6Server.GoServerWelcomeFileHandler welcomeFileHandler = (Jetty6Server.GoServerWelcomeFileHandler) handler;
+        assertThat(welcomeFileHandler.getContextPath(), is("/"));
+    }
+
+    @Test
+    public void shouldAddLegacyUrlRequestHandler() throws Exception {
+        ArgumentCaptor<ContextHandler> captor = ArgumentCaptor.forClass(ContextHandler.class);
+        jetty6Server.configure();
+
+        verify(server, times(4)).addHandler(captor.capture());
+        List<ContextHandler> handlers = captor.getAllValues();
+        assertThat(handlers.size(), is(4));
+        ContextHandler handler = handlers.get(1);
+        assertThat(handler instanceof Jetty6Server.LegacyUrlRequestHandler, is(true));
+        Jetty6Server.LegacyUrlRequestHandler legacyUrlRequestHandler = (Jetty6Server.LegacyUrlRequestHandler) handler;
+        assertThat(legacyUrlRequestHandler.getContextPath(), is("/cruise"));
+    }
+
+    @Test
+    public void shouldAddResourceHandlerForAssets() throws Exception {
+        ArgumentCaptor<ContextHandler> captor = ArgumentCaptor.forClass(ContextHandler.class);
+        jetty6Server.configure();
+
+        verify(server, times(4)).addHandler(captor.capture());
+        List<ContextHandler> handlers = captor.getAllValues();
+        assertThat(handlers.size(), is(4));
+        ContextHandler handler = handlers.get(2);
+        assertThat(handler instanceof Jetty6AssetsContextHandler, is(true));
+        Jetty6AssetsContextHandler assetsContextHandler = (Jetty6AssetsContextHandler) handler;
+        assertThat(assetsContextHandler.getContextPath(), is("context/assets"));
+    }
+
+    @Test
+    public void shouldAddWebAppContextHandler() throws Exception {
+        ArgumentCaptor<ContextHandler> captor = ArgumentCaptor.forClass(ContextHandler.class);
+        jetty6Server.configure();
+
+        verify(server, times(4)).addHandler(captor.capture());
+        List<ContextHandler> handlers = captor.getAllValues();
+        assertThat(handlers.size(), is(4));
+        ContextHandler handler = handlers.get(3);
+        assertThat(handler instanceof WebAppContext, is(true));
+        WebAppContext webAppContext = (WebAppContext) handler;
+        List<String> configClasses = ArrayUtil.asList(webAppContext.getConfigurationClasses());
+        assertThat(configClasses.contains(WebInfConfiguration.class.getCanonicalName()), is(true));
+        assertThat(configClasses.contains(WebXmlConfiguration.class.getCanonicalName()), is(true));
+        assertThat(configClasses.contains(JettyWebXmlConfiguration.class.getCanonicalName()), is(true));
+        assertThat(webAppContext.getContextPath(), is("context"));
+        assertThat(webAppContext.getWar(), is("cruise.war"));
+        assertThat(webAppContext.isParentLoaderPriority(), is(false));
+        assertThat(webAppContext.getDefaultsDescriptor(), is("org/mortbay/jetty/webapp/webdefault.xml"));
+    }
+
+    @Test
+    public void shouldSetStopAtShutdown() throws Exception {
+        jetty6Server.configure();
+        verify(server).setStopAtShutdown(true);
+    }
+
+    @Test
+    public void shouldAddExtraJarsIntoClassPath() throws Exception {
+        jetty6Server.configure();
+        jetty6Server.addExtraJarsToClasspath("test-addons/some-addon-dir/addon-1.JAR,test-addons/some-addon-dir/addon-2.jar");
+        assertThat(getWebAppContext(jetty6Server).getExtraClasspath(), is("test-addons/some-addon-dir/addon-1.JAR,test-addons/some-addon-dir/addon-2.jar"));
+    }
+
+    @Test
+    public void shouldSetInitParams() throws Exception {
+        jetty6Server.configure();
+        jetty6Server.setInitParameter("name", "value");
+
+        assertThat(getWebAppContext(jetty6Server).getInitParameter("name"), CoreMatchers.is("value"));
+    }
+
+    private WebAppContext getWebAppContext(Jetty6Server server) {
+        return (WebAppContext) ReflectionUtil.getField(server, "webAppContext");
+    }
+}

--- jetty6/test/unit/com/thoughtworks/go/server/util/GoJetty6CipherSuiteTest.java (renamed) ---
additions: 10, deletions: 11, changes: 21
@@ -1,5 +1,5 @@
 /*************************GO-LICENSE-START*********************************
- * Copyright 2014 ThoughtWorks, Inc.
+ * Copyright 2015 ThoughtWorks, Inc.
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -14,21 +14,19 @@
  * limitations under the License.
  *************************GO-LICENSE-END***********************************/
 
-package com.thoughtworks.go.server;
+package com.thoughtworks.go.server.util;
 
-import java.util.Arrays;
-import javax.net.ssl.SSLSocketFactory;
-
-import com.thoughtworks.go.server.util.GoCipherSuite;
 import org.junit.Test;
 
+import javax.net.ssl.SSLSocketFactory;
+import java.util.Arrays;
+
 import static org.hamcrest.core.Is.is;
-import static org.junit.Assert.assertThat;
-import static org.junit.Assert.assertTrue;
+import static org.junit.Assert.*;
 import static org.mockito.Mockito.mock;
 import static org.mockito.Mockito.when;
 
-public class GoCipherSuiteTest {
+public class GoJetty6CipherSuiteTest {
     @Test
     public void shouldExcludeEverySuiteOtherThanTheMagicThreeWhichAreSupportedByOurOldJetty() throws Exception {
         SSLSocketFactory socketFactory = mock(SSLSocketFactory.class);
@@ -46,7 +44,7 @@ public void shouldExcludeEverySuiteOtherThanTheMagicThreeWhichAreSupportedByOurO
                 ,"TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA"
                 ,"SSL_RSA_WITH_RC4_128_MD5"
                 ,"TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA"});
-        GoCipherSuite goCipherSuite = new GoCipherSuite(socketFactory);
+        GoJetty6CipherSuite goCipherSuite = new GoJetty6CipherSuite(socketFactory);
 
         assertThat(Arrays.asList(goCipherSuite.getExcludedCipherSuites()), is(Arrays.asList(
                 "TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256"
@@ -74,8 +72,9 @@ public void shouldNotExcludeAnySuiteIfTheMagicThreeDoNotExist() throws Exception
                 ,"TLS_DHE_DSS_WITH_AES_128_CBC_SHA256"
                 ,"TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA"
                 ,"TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA"});
-        GoCipherSuite goCipherSuite = new GoCipherSuite(socketFactory);
+        GoJetty6CipherSuite goCipherSuite = new GoJetty6CipherSuite(socketFactory);
 
         assertTrue(Arrays.asList(goCipherSuite.getExcludedCipherSuites()).isEmpty());
     }
+
 }
\ No newline at end of file

--- jetty6/test/unit/com/thoughtworks/go/server/util/GoJetty6SslSocketConnectorTest.java (added) ---
additions: 72, deletions: 0, changes: 72
@@ -0,0 +1,72 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+import com.thoughtworks.go.util.FileUtil;
+import com.thoughtworks.go.util.SystemEnvironment;
+import org.junit.Before;
+import org.junit.Rule;
+import org.junit.Test;
+import org.junit.rules.TemporaryFolder;
+import org.mortbay.jetty.security.SslSelectChannelConnector;
+
+import java.io.File;
+import java.io.IOException;
+
+import static org.hamcrest.core.Is.is;
+import static org.junit.Assert.assertThat;
+import static org.mockito.Mockito.mock;
+import static org.mockito.Mockito.when;
+
+public class GoJetty6SslSocketConnectorTest {
+    private SystemEnvironment systemEnvironment;
+    @Rule
+    public TemporaryFolder temporaryFolder = new TemporaryFolder();
+    private GoJetty6SslSocketConnector connector;
+
+    @Before
+    public void setUp() throws Exception {
+        systemEnvironment = mock(SystemEnvironment.class);
+        when(systemEnvironment.getServerPort()).thenReturn(1234);
+        when(systemEnvironment.getSslServerPort()).thenReturn(4567);
+        when(systemEnvironment.keystore()).thenReturn(temporaryFolder.newFolder());
+        when(systemEnvironment.truststore()).thenReturn(temporaryFolder.newFolder());
+        when(systemEnvironment.getWebappContextPath()).thenReturn("context");
+        when(systemEnvironment.getCruiseWar()).thenReturn("cruise.war");
+        when(systemEnvironment.getParentLoaderPriority()).thenReturn(true);
+        when(systemEnvironment.useCompressedJs()).thenReturn(true);
+        when(systemEnvironment.useNioSslSocket()).thenReturn(true);
+        when(systemEnvironment.getListenHost()).thenReturn("localhost");
+        when(systemEnvironment.getParentLoaderPriority()).thenReturn(false);
+        GoJetty6CipherSuite goJetty6CipherSuite = mock(GoJetty6CipherSuite.class);
+        connector = new GoJetty6SslSocketConnector("pwd", systemEnvironment, goJetty6CipherSuite);
+        when(goJetty6CipherSuite.getExcludedCipherSuites()).thenReturn(new String[]{"CS1", "CS2"});
+    }
+
+    @Test
+    public void shouldCreateSslConnector() throws IOException {
+        assertThat(connector.sslConnector() instanceof SslSelectChannelConnector, is(true));
+        SslSelectChannelConnector sslConnector = (SslSelectChannelConnector) connector.sslConnector();
+        assertThat(sslConnector.getPort(), is(4567));
+        assertThat(sslConnector.getHost(), is("localhost"));
+        assertThat(sslConnector.getMaxIdleTime(), is(30000));
+        assertThat(sslConnector.getWantClientAuth(), is(true));
+        assertThat(FileUtil.isChildOf(temporaryFolder.getRoot(), new File(sslConnector.getKeystore())), is(true));
+        assertThat(FileUtil.isChildOf(temporaryFolder.getRoot(), new File(sslConnector.getTruststore())), is(true));
+        assertThat(sslConnector.getExcludeCipherSuites(), is(new String[]{"CS1", "CS2"}));
+    }
+}
\ No newline at end of file

--- jetty6/test/unit/com/thoughtworks/go/server/util/Jetty6RequestTest.java (added) ---
additions: 62, deletions: 0, changes: 62
@@ -0,0 +1,62 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+import org.junit.Before;
+import org.junit.Test;
+import org.mortbay.jetty.HttpURI;
+import org.mortbay.jetty.Request;
+
+import static org.hamcrest.core.Is.is;
+import static org.junit.Assert.*;
+import static org.mockito.Mockito.mock;
+import static org.mockito.Mockito.verify;
+import static org.mockito.Mockito.when;
+
+public class Jetty6RequestTest {
+    private Jetty6Request jettyRequest;
+    private Request request;
+
+    @Before
+    public void setUp() throws Exception {
+        request = mock(Request.class);
+        jettyRequest = new Jetty6Request(request);
+        when(request.getUri()).thenReturn(new HttpURI("foo/bar/baz"));
+        when(request.getRootURL()).thenReturn(new StringBuffer("http://junk/"));
+    }
+
+    @Test
+    public void shouldGetUrl() {
+        assertThat(jettyRequest.getUrl(), is("http://junk/foo/bar/baz"));
+    }
+
+    @Test
+    public void shouldGetUriPath() {
+        assertThat(jettyRequest.getUriPath(), is("foo/bar/baz"));
+    }
+
+    @Test
+    public void shouldGetUriAsString() {
+        assertThat(jettyRequest.getUriAsString(), is("foo/bar/baz"));
+    }
+
+    @Test
+    public void shouldSetRequestUri() {
+        jettyRequest.setRequestURI("foo");
+        verify(request).setRequestURI("foo");
+    }
+}
\ No newline at end of file

--- jetty6/test/unit/com/thoughtworks/go/server/util/Jetty6ResponseTest.java (added) ---
additions: 49, deletions: 0, changes: 49
@@ -0,0 +1,49 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+import org.junit.Before;
+import org.junit.Test;
+import org.mortbay.jetty.Response;
+
+import static org.hamcrest.core.Is.is;
+import static org.junit.Assert.*;
+import static org.mockito.Mockito.mock;
+import static org.mockito.Mockito.when;
+
+public class Jetty6ResponseTest {
+    private Jetty6Response jetty6Response;
+    private Response response;
+
+    @Before
+    public void setUp() throws Exception {
+        response = mock(Response.class);
+        jetty6Response = new Jetty6Response(response);
+    }
+
+    @Test
+    public void shouldGetResponseStatus() {
+        when(response.getStatus()).thenReturn(200);
+        assertThat(jetty6Response.getStatus(), is(200));
+    }
+
+    @Test
+    public void shouldGetResponseContentCount() {
+        when(response.getContentCount()).thenReturn(2000l);
+        assertThat(jetty6Response.getContentCount(), is(2000l));
+    }
+}
\ No newline at end of file

--- jetty6/test/unit/com/thoughtworks/go/server/util/Jetty6ServletHelperTest.java (added) ---
additions: 45, deletions: 0, changes: 45
@@ -0,0 +1,45 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+import org.junit.Test;
+import org.mortbay.jetty.Request;
+import org.mortbay.jetty.Response;
+
+import static org.hamcrest.core.Is.is;
+import static org.junit.Assert.assertThat;
+import static org.mockito.Mockito.mock;
+
+public class Jetty6ServletHelperTest {
+    @Test
+    public void shouldGetInstanceOfServletHelper(){
+        ServletHelper.init(false);
+        assertThat(ServletHelper.getInstance() instanceof Jetty6ServletHelper, is(true));
+    }
+
+    @Test
+    public void shouldGetJetty6Request() {
+        ServletRequest request = new Jetty6ServletHelper().getRequest(mock(Request.class));
+        assertThat(request instanceof Jetty6Request, is(true));
+    }
+
+    @Test
+    public void shouldGetJetty6Response() {
+        ServletResponse response = new Jetty6ServletHelper().getResponse(mock(Response.class));
+        assertThat(response instanceof Jetty6Response, is(true));
+    }
+}
\ No newline at end of file

--- jetty9/pom.xml (added) ---
additions: 316, deletions: 0, changes: 316
@@ -0,0 +1,316 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- *************************GO-LICENSE-START******************************
+ * Copyright 2014 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END******************************* -->
+
+<project xmlns="http://maven.apache.org/POM/4.0.0"
+         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
+    <modelVersion>4.0.0</modelVersion>
+
+    <groupId>com.thoughtworks.go</groupId>
+    <artifactId>jetty9</artifactId>
+    <version>1.0</version>
+
+    <parent>
+        <groupId>com.thoughtworks.go</groupId>
+        <artifactId>gocd</artifactId>
+        <version>1.0</version>
+        <relativePath>../</relativePath>
+    </parent>
+
+    <properties>
+        <jetty.version>9.2.3.v20140905</jetty.version>
+    </properties>
+
+    <dependencies>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>database</artifactId>
+            <version>1.0</version>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>app-server</artifactId>
+            <version>1.0</version>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>licensing</artifactId>
+            <version>1.0</version>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>config-server</artifactId>
+            <version>1.0</version>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>common</artifactId>
+            <version>1.0</version>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>rack_hack</artifactId>
+            <version>1.0</version>
+        </dependency>
+
+        <!-- jetty -->
+        <dependency>
+            <groupId>org.eclipse.jetty</groupId>
+            <artifactId>jetty-server</artifactId>
+            <version>${jetty.version}</version>
+            <scope>provided</scope>
+        </dependency>
+        <dependency>
+            <groupId>org.eclipse.jetty</groupId>
+            <artifactId>jetty-plus</artifactId>
+            <version>${jetty.version}</version>
+            <scope>provided</scope>
+        </dependency>
+        <dependency>
+            <groupId>org.eclipse.jetty</groupId>
+            <artifactId>jetty-jmx</artifactId>
+            <version>${jetty.version}</version>
+            <scope>provided</scope>
+        </dependency>
+        <dependency>
+            <groupId>org.eclipse.jetty</groupId>
+            <artifactId>jetty-servlets</artifactId>
+            <version>${jetty.version}</version>
+            <scope>provided</scope>
+        </dependency>
+        <dependency>
+            <groupId>org.eclipse.jetty</groupId>
+            <artifactId>jetty-util</artifactId>
+            <version>${jetty.version}</version>
+            <scope>provided</scope>
+        </dependency>
+        <!-- jetty end -->
+
+        <!-- apache commons -->
+        <dependency>
+            <groupId>commons-beanutils</groupId>
+            <artifactId>commons-beanutils-core</artifactId>
+            <version>1.7.0</version>
+            <exclusions>
+                <exclusion>
+                    <groupId>commons-logging</groupId>
+                    <artifactId>commons-logging</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>commons-collections</groupId>
+                    <artifactId>commons-collections</artifactId>
+                </exclusion>
+            </exclusions>
+        </dependency>
+        <dependency>
+            <groupId>commons-validator</groupId>
+            <artifactId>commons-validator</artifactId>
+            <version>1.3.1</version>
+            <exclusions>
+                <exclusion>
+                    <groupId>commons-digester</groupId>
+                    <artifactId>commons-digester</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>commons-logging</groupId>
+                    <artifactId>commons-logging</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>junit</groupId>
+                    <artifactId>junit</artifactId>
+                </exclusion>
+            </exclusions>
+        </dependency>
+        <dependency>
+            <groupId>commons-dbcp</groupId>
+            <artifactId>commons-dbcp</artifactId>
+            <version>1.4</version>
+        </dependency>
+        <dependency>
+            <groupId>commons-pool</groupId>
+            <artifactId>commons-pool</artifactId>
+            <version>1.5.6</version>
+        </dependency>
+        <!-- apache commons end -->
+        <dependency>
+            <groupId>org.bouncycastle</groupId>
+            <artifactId>bcprov-jdk15on</artifactId>
+            <version>1.47</version>
+            <scope>provided</scope>
+        </dependency>
+
+        <dependency>
+            <groupId>org.slf4j</groupId>
+            <artifactId>slf4j-api</artifactId>
+            <version>1.7.2</version>
+        </dependency>
+        <dependency>
+            <groupId>org.slf4j</groupId>
+            <artifactId>slf4j-log4j12</artifactId>
+            <version>1.7.2</version>
+        </dependency>
+        <!-- test dependencies -->
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>common</artifactId>
+            <version>1.0</version>
+            <type>test-jar</type>
+            <scope>test</scope>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>config-server</artifactId>
+            <version>1.0</version>
+            <type>test-jar</type>
+            <scope>test</scope>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>config-api</artifactId>
+            <version>1.0</version>
+            <type>test-jar</type>
+            <scope>test</scope>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>metrics</artifactId>
+            <version>1.0</version>
+            <type>test-jar</type>
+            <scope>test</scope>
+        </dependency>
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>test-utils</artifactId>
+            <version>1.0</version>
+            <scope>test</scope>
+        </dependency>
+        <dependency>
+            <groupId>com.tlb</groupId>
+            <artifactId>tlb-java</artifactId>
+            <version>0.3.2-90-g6df47e3</version>
+            <scope>test</scope>
+            <exclusions>
+                <exclusion>
+                    <groupId>commons-io</groupId>
+                    <artifactId>commons-io</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>commons-codec</groupId>
+                    <artifactId>commons-codec</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>log4j</groupId>
+                    <artifactId>log4j</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>xalan</groupId>
+                    <artifactId>xalan</artifactId>
+                </exclusion>
+            </exclusions>
+        </dependency>
+
+        <dependency>
+            <groupId>net.sourceforge.cobertura</groupId>
+            <artifactId>cobertura</artifactId>
+            <version>2.0.3</version>
+            <scope>test</scope>
+            <exclusions>
+                <exclusion>
+                    <groupId>log4j</groupId>
+                    <artifactId>log4j</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>com.sun</groupId>
+                    <artifactId>tools</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>org.mortbay.jetty</groupId>
+                    <artifactId>servlet-api-2.5</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>org.mortbay.jetty</groupId>
+                    <artifactId>jetty</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>org.mortbay.jetty</groupId>
+                    <artifactId>jetty-util</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>org.mortbay.jetty</groupId>
+                    <artifactId>jetty-servlet-tester</artifactId>
+                </exclusion>
+            </exclusions>
+        </dependency>
+    </dependencies>
+
+    <build>
+        <sourceDirectory>src</sourceDirectory>
+        <plugins>
+            <plugin>
+                <groupId>org.codehaus.mojo</groupId>
+                <artifactId>build-helper-maven-plugin</artifactId>
+                <version>1.8</version>
+                <executions>
+                    <execution>
+                        <id>add-test-sources</id>
+                        <phase>generate-test-sources</phase>
+                        <goals>
+                            <goal>add-test-source</goal>
+                        </goals>
+                        <configuration>
+                            <sources>
+                                <source>${project.basedir}/test/unit</source>
+                                <source>${project.basedir}/test/integration</source>
+                            </sources>
+                        </configuration>
+                    </execution>
+                </executions>
+            </plugin>
+            <plugin>
+                <groupId>org.apache.maven.plugins</groupId>
+                <artifactId>maven-compiler-plugin</artifactId>
+                <version>3.1</version>
+                <configuration>
+                    <source>1.6</source>
+                    <target>1.6</target>
+                </configuration>
+            </plugin>
+            <plugin>
+                <groupId>org.apache.maven.plugins</groupId>
+                <artifactId>maven-dependency-plugin</artifactId>
+                <version>2.4</version>
+                <executions>
+                    <execution>
+                        <id>copy-dependencies</id>
+                        <phase>compile</phase>
+                        <goals>
+                            <goal>copy-dependencies</goal>
+                        </goals>
+                        <configuration>
+                            <outputDirectory>${project.build.directory}\lib</outputDirectory>
+                            <includeScope>provided</includeScope>
+                            <overWriteReleases>false</overWriteReleases>
+                            <overWriteSnapshots>false</overWriteSnapshots>
+                            <overWriteIfNewer>true</overWriteIfNewer>
+                        </configuration>
+                    </execution>
+                </executions>
+            </plugin>
+
+        </plugins>
+    </build>
+</project>
\ No newline at end of file

--- jetty9/src/com/thoughtworks/go/server/AssetsContextHandler.java (added) ---
additions: 70, deletions: 0, changes: 70
@@ -0,0 +1,70 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server;
+
+import com.thoughtworks.go.util.SystemEnvironment;
+import org.eclipse.jetty.server.HttpConnection;
+import org.eclipse.jetty.server.Request;
+import org.eclipse.jetty.server.handler.AbstractHandler;
+import org.eclipse.jetty.server.handler.ContextHandler;
+import org.eclipse.jetty.server.handler.ResourceHandler;
+import org.eclipse.jetty.webapp.WebAppContext;
+
+import javax.servlet.ServletException;
+import javax.servlet.http.HttpServletRequest;
+import javax.servlet.http.HttpServletResponse;
+import java.io.IOException;
+
+public class AssetsContextHandler extends ContextHandler {
+    private final AssetsHandler handler;
+    private SystemEnvironment systemEnvironment;
+
+    public AssetsContextHandler(SystemEnvironment systemEnvironment) throws IOException {
+        super(systemEnvironment.getWebappContextPath() + "/assets");
+        this.systemEnvironment = systemEnvironment;
+        handler = new AssetsHandler();
+        setHandler(handler);
+    }
+
+    public void init(WebAppContext webAppContext) throws IOException {
+        String railsRootDirName = webAppContext.getInitParameter("rails.root").replaceAll("/WEB-INF/", "");
+        String assetsDir = webAppContext.getWebInf().addPath(String.format("%s/public/assets/", railsRootDirName)).getName();
+        handler.setAssetsDir(assetsDir);
+    }
+
+    private boolean shouldNotHandle() {
+        return !systemEnvironment.useCompressedJs();
+    }
+
+    class AssetsHandler extends AbstractHandler {
+        private ResourceHandler resourceHandler = new ResourceHandler();
+
+        private AssetsHandler() {
+            resourceHandler.setCacheControl("max-age=31536000,public");
+        }
+
+        public void handle(String target, Request baseRequest, HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {
+            if (shouldNotHandle()) return;
+            this.resourceHandler.handle(target, baseRequest, request, response);
+        }
+
+        private void setAssetsDir(String assetsDir) {
+            resourceHandler.setResourceBase(assetsDir);
+        }
+    }
+
+}

--- jetty9/src/com/thoughtworks/go/server/AssetsContextHandlerInitializer.java (renamed) ---
additions: 19, deletions: 2, changes: 21
@@ -1,7 +1,24 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
 package com.thoughtworks.go.server;
 
-import org.mortbay.component.LifeCycle;
-import org.mortbay.jetty.webapp.WebAppContext;
+
+import org.eclipse.jetty.util.component.LifeCycle;
+import org.eclipse.jetty.webapp.WebAppContext;
 
 import java.io.IOException;
 

--- jetty9/src/com/thoughtworks/go/server/GoWebXmlConfiguration.java (added) ---
additions: 34, deletions: 0, changes: 34
@@ -0,0 +1,34 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server;
+
+import org.xml.sax.SAXException;
+
+import java.io.File;
+import java.io.IOException;
+
+public class GoWebXmlConfiguration {
+
+    private static String webdefaultXml = "WEB-INF/webdefault.xml";
+
+    public static String configuration(String warFile) throws IOException, SAXException {
+        if (new File(warFile).isDirectory()) {
+            return new File(warFile, webdefaultXml).getPath();
+        }
+        return "jar:file:" + warFile + "!/" + webdefaultXml;
+    }
+}

--- jetty9/src/com/thoughtworks/go/server/Jetty9Server.java (added) ---
additions: 205, deletions: 0, changes: 205
@@ -0,0 +1,205 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server;
+
+import com.thoughtworks.go.server.util.GoCipherSuite;
+import com.thoughtworks.go.server.util.GoPlainSocketConnector;
+import com.thoughtworks.go.server.util.GoSslSocketConnector;
+import com.thoughtworks.go.util.GoConstants;
+import com.thoughtworks.go.util.SystemEnvironment;
+import org.apache.log4j.Logger;
+import org.eclipse.jetty.jmx.MBeanContainer;
+import org.eclipse.jetty.server.Connector;
+import org.eclipse.jetty.server.Handler;
+import org.eclipse.jetty.server.Request;
+import org.eclipse.jetty.server.Server;
+import org.eclipse.jetty.server.handler.*;
+import org.eclipse.jetty.servlet.ServletHolder;
+import org.eclipse.jetty.util.component.Container;
+import org.eclipse.jetty.webapp.JettyWebXmlConfiguration;
+import org.eclipse.jetty.webapp.WebAppContext;
+import org.eclipse.jetty.webapp.WebInfConfiguration;
+import org.eclipse.jetty.webapp.WebXmlConfiguration;
+import org.eclipse.jetty.xml.XmlConfiguration;
+import org.xml.sax.SAXException;
+
+import javax.management.MBeanServer;
+import javax.net.ssl.SSLSocketFactory;
+import javax.servlet.ServletException;
+import javax.servlet.UnavailableException;
+import javax.servlet.http.HttpServletRequest;
+import javax.servlet.http.HttpServletResponse;
+import java.io.File;
+import java.io.FileInputStream;
+import java.io.IOException;
+import java.io.PrintWriter;
+import java.lang.management.ManagementFactory;
+
+public class Jetty9Server extends AppServer {
+    private Server server;
+    private WebAppContext webAppContext;
+    private static final Logger LOG = Logger.getLogger(Jetty9Server.class);
+    private GoCipherSuite goCipherSuite;
+
+    public Jetty9Server(SystemEnvironment systemEnvironment, String password, SSLSocketFactory sslSocketFactory) {
+        this(systemEnvironment, password, sslSocketFactory, new Server());
+    }
+
+    Jetty9Server(SystemEnvironment systemEnvironment, String password, SSLSocketFactory sslSocketFactory, Server server){
+        super(systemEnvironment, password, sslSocketFactory);
+        this.server = server;
+        goCipherSuite = new GoCipherSuite(sslSocketFactory);
+    }
+
+    @Override
+    public void configure() throws Exception {
+        server.addEventListener(mbeans());
+        server.addConnector(plainConnector());
+        server.addConnector(sslConnector());
+        HandlerCollection handlers = new HandlerCollection();
+        handlers.addHandler(welcomeFileHandler());
+        createWebAppContext();
+        addResourceHandler(handlers, webAppContext);
+        handlers.addHandler(webAppContext);
+        server.setHandler(handlers);
+        performCustomConfiguration();
+        server.setStopAtShutdown(true);
+    }
+
+    @Override
+    public void start() throws Exception {
+        server.start();
+    }
+
+    @Override
+    public void stop() throws Exception {
+        server.stop();
+    }
+
+    @Override
+    public void addExtraJarsToClasspath(String extraClasspath) {
+        webAppContext.setExtraClasspath(extraClasspath);
+    }
+
+    @Override
+    public void setCookieExpirePeriod(int cookieExpirePeriod) {
+        webAppContext.getSessionHandler().getSessionManager().getSessionCookieConfig().setMaxAge(cookieExpirePeriod);
+    }
+
+    @Override
+    public void setInitParameter(String name, String value) {
+        webAppContext.setInitParameter(name, value);
+    }
+
+    @Override
+    public void addStopServlet() {
+        ServletHolder holder = new ServletHolder();
+        holder.setServlet(new StopJettyFromLocalhostServlet(this));
+        webAppContext.addServlet(holder, "/jetty/stop");
+    }
+
+    @Override
+    public Throwable getUnavailableException() {
+        return webAppContext.getUnavailableException();
+    }
+
+    private MBeanContainer mbeans() {
+        MBeanServer platformMBeanServer = ManagementFactory.getPlatformMBeanServer();
+        MBeanContainer mbeans = new MBeanContainer(platformMBeanServer);
+        return mbeans;
+    }
+
+    ContextHandler welcomeFileHandler() {
+        return new GoServerWelcomeFileHandler();
+    }
+
+    private Connector plainConnector() {
+        return new GoPlainSocketConnector(this, systemEnvironment).getConnector();
+    }
+
+    private Connector sslConnector() {
+        return new GoSslSocketConnector(this, password, systemEnvironment, goCipherSuite).getConnector();
+    }
+
+    class GoServerWelcomeFileHandler extends ContextHandler {
+        public GoServerWelcomeFileHandler() {
+            setContextPath("/");
+            setHandler(new Handler());
+        }
+
+        private class Handler extends AbstractHandler {
+            public void handle(String target, Request baseRequest, HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {
+                if (target.equals("/")) {
+                    response.setHeader("Location", GoConstants.GO_URL_CONTEXT + "/home");
+                    response.setStatus(301);
+                    response.setHeader("Content-Type", "text/html");
+                    PrintWriter writer = response.getWriter();
+                    writer.write("redirecting..");
+                    writer.close();
+                }
+            }
+        }
+    }
+
+
+    private void performCustomConfiguration() throws Exception {
+        File jettyConfig = new File(systemEnvironment.getConfigDir(), "jetty.xml");
+
+        if (jettyConfig.exists()) {
+            LOG.info("Configuring Jetty using " + jettyConfig.getAbsolutePath());
+            FileInputStream serverConfiguration = new FileInputStream(jettyConfig);
+            XmlConfiguration configuration = new XmlConfiguration(serverConfiguration);
+            configuration.configure(server);
+        } else {
+            String message = String.format(
+                    "No custom jetty configuration (%s) found, using defaults.",
+                    jettyConfig.getAbsolutePath());
+            LOG.info(message);
+        }
+    }
+
+    private void addResourceHandler(HandlerCollection handlers, WebAppContext webAppContext) throws IOException {
+        if (!systemEnvironment.useCompressedJs()) return;
+        AssetsContextHandler handler = new AssetsContextHandler(systemEnvironment);
+        handlers.addHandler(handler);
+        webAppContext.addLifeCycleListener(new AssetsContextHandlerInitializer(handler, webAppContext));
+    }
+
+
+    private String getWarFile() {
+        return systemEnvironment.getCruiseWar();
+    }
+
+    WebAppContext createWebAppContext() throws IOException, SAXException, ClassNotFoundException, UnavailableException {
+        webAppContext = new WebAppContext();
+        webAppContext.setDefaultsDescriptor(GoWebXmlConfiguration.configuration(getWarFile()));
+
+        webAppContext.setConfigurationClasses(new String[]{
+                WebInfConfiguration.class.getCanonicalName(),
+                WebXmlConfiguration.class.getCanonicalName(),
+                JettyWebXmlConfiguration.class.getCanonicalName()
+        });
+        webAppContext.setContextPath(systemEnvironment.getWebappContextPath());
+        webAppContext.setWar(getWarFile());
+        webAppContext.setParentLoaderPriority(systemEnvironment.getParentLoaderPriority());
+        return webAppContext;
+    }
+
+    public Server getServer() {
+        return server;
+    }
+}

--- jetty9/src/com/thoughtworks/go/server/util/GoCipherSuite.java (added) ---
additions: 48, deletions: 0, changes: 48
@@ -0,0 +1,48 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+import javax.net.ssl.SSLSocketFactory;
+import java.util.ArrayList;
+import java.util.Arrays;
+import java.util.List;
+
+public class GoCipherSuite {
+    private final SSLSocketFactory socketFactory;
+    private List<String> cipherSuitesSupportedByGo = Arrays.asList("SSL_RSA_WITH_RC4_128_SHA", "SSL_RSA_EXPORT_WITH_RC4_40_MD5", "SSL_RSA_WITH_RC4_128_MD5");
+
+    public GoCipherSuite(SSLSocketFactory socketFactory) {
+        this.socketFactory = socketFactory;
+    }
+
+    public String[] getCipherSuitsToBeIncluded() {
+
+        String[] supportedCipherSuites = socketFactory.getSupportedCipherSuites();
+
+        ArrayList<String> suitesToBeIncluded = new ArrayList<String>();
+        for (String suite : supportedCipherSuites) {
+            if (cipherSuitesSupportedByGo.contains(suite)) {
+                suitesToBeIncluded.add(suite);
+            }
+        }
+
+        if (suitesToBeIncluded.size() == 0) {
+            return supportedCipherSuites;
+        }
+        return cipherSuitesSupportedByGo.toArray(new String[cipherSuitesSupportedByGo.size()]);
+    }
+}

--- jetty9/src/com/thoughtworks/go/server/util/GoPlainSocketConnector.java (added) ---
additions: 49, deletions: 0, changes: 49
@@ -0,0 +1,49 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+import com.thoughtworks.go.server.Jetty9Server;
+import com.thoughtworks.go.util.SystemEnvironment;
+import org.eclipse.jetty.server.*;
+import org.jruby.RubyProcess;
+
+import static com.thoughtworks.go.util.ExceptionUtils.bomb;
+
+public class GoPlainSocketConnector implements GoSocketConnector {
+    private final Connector httpConnector;
+    private final SystemEnvironment systemEnvironment;
+
+    public GoPlainSocketConnector(Jetty9Server server, SystemEnvironment systemEnvironment) {
+        this.systemEnvironment = systemEnvironment;
+        httpConnector = plainConnector(server);
+    }
+
+    private Connector plainConnector(Jetty9Server server) {
+        HttpConfiguration httpConfig = new HttpConfiguration();
+        httpConfig.setOutputBufferSize(systemEnvironment.get(SystemEnvironment.RESPONSE_BUFFER_SIZE));
+
+        ServerConnector httpConnector = new ServerConnector(server.getServer(), new HttpConnectionFactory(httpConfig));
+        httpConnector.setHost(systemEnvironment.getListenHost());
+        httpConnector.setPort(systemEnvironment.getServerPort());
+        httpConnector.setIdleTimeout(systemEnvironment.get(SystemEnvironment.IDLE_TIMEOUT));
+        return httpConnector;
+    }
+
+    public Connector getConnector() {
+        return httpConnector;
+    }
+}

--- jetty9/src/com/thoughtworks/go/server/util/GoSocketConnector.java (added) ---
additions: 23, deletions: 0, changes: 23
@@ -0,0 +1,23 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+import org.eclipse.jetty.server.Connector;
+
+public interface GoSocketConnector {
+    Connector getConnector();
+}

--- jetty9/src/com/thoughtworks/go/server/util/GoSslSocketConnector.java (added) ---
additions: 97, deletions: 0, changes: 97
@@ -0,0 +1,97 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+import com.thoughtworks.go.security.X509CertificateGenerator;
+import com.thoughtworks.go.server.Jetty9Server;
+import com.thoughtworks.go.util.ExceptionUtils;
+import com.thoughtworks.go.util.SystemEnvironment;
+import org.apache.log4j.Logger;
+import org.eclipse.jetty.http.HttpVersion;
+import org.eclipse.jetty.server.*;
+import org.eclipse.jetty.util.ssl.SslContextFactory;
+
+import java.io.File;
+import java.net.InetAddress;
+import java.net.UnknownHostException;
+
+public class GoSslSocketConnector implements GoSocketConnector {
+    private static Logger LOGGER = Logger.getLogger(GoSslSocketConnector.class);
+    private final String password;
+    private final SystemEnvironment systemEnvironment;
+    private final GoCipherSuite goCipherSuite;
+    private final File keystore;
+    private final File truststore;
+    private final File agentKeystore;
+    private final Connector connector;
+
+    public GoSslSocketConnector(Jetty9Server server, String password, SystemEnvironment systemEnvironment, GoCipherSuite goCipherSuite) {
+        this.password = password;
+        this.systemEnvironment = systemEnvironment;
+        this.goCipherSuite = goCipherSuite;
+        this.keystore = systemEnvironment.keystore();
+        this.truststore = systemEnvironment.truststore();
+        this.agentKeystore = systemEnvironment.agentkeystore();
+        connector = sslConnector(server.getServer());
+    }
+
+    private Connector sslConnector(Server server) {
+        if (!keystore.exists()) {
+            storeX509Certificate();
+        }
+
+        HttpConfiguration httpsConfig = new HttpConfiguration();
+        httpsConfig.setOutputBufferSize(systemEnvironment.get(SystemEnvironment.RESPONSE_BUFFER_SIZE));
+        httpsConfig.addCustomizer(new SecureRequestCustomizer());
+
+        SslContextFactory sslContextFactory = new SslContextFactory();
+        sslContextFactory.setKeyStorePath(keystore.getPath());
+        sslContextFactory.setKeyStorePassword(password);
+        sslContextFactory.setKeyManagerPassword(password);
+        sslContextFactory.setTrustStorePath(truststore.getPath());
+        sslContextFactory.setTrustStorePassword(password);
+        sslContextFactory.setWantClientAuth(true);
+        sslContextFactory.setIncludeCipherSuites(goCipherSuite.getCipherSuitsToBeIncluded());
+
+        ServerConnector https = new ServerConnector(server, new SslConnectionFactory(sslContextFactory, HttpVersion.HTTP_1_1.asString()), new HttpConnectionFactory(httpsConfig));
+        https.setHost(systemEnvironment.getListenHost());
+        https.setPort(systemEnvironment.getSslServerPort());
+        https.setIdleTimeout(systemEnvironment.get(SystemEnvironment.IDLE_TIMEOUT));
+
+        return https;
+    }
+
+    private void storeX509Certificate() {
+        String principalDn = "ou=Cruise server webserver certificate, cn=" + getHostname();
+
+        X509CertificateGenerator generator = new X509CertificateGenerator();
+        generator.createAndStoreX509Certificates(keystore, truststore, agentKeystore, password, principalDn);
+    }
+
+    private String getHostname() {
+        try {
+            return InetAddress.getLocalHost().getHostName();
+        } catch (UnknownHostException e) {
+            throw ExceptionUtils.bomb(e);
+        }
+    }
+
+    @Override
+    public Connector getConnector() {
+        return connector;
+    }
+}

--- jetty9/src/com/thoughtworks/go/server/util/Jetty9Request.java (added) ---
additions: 47, deletions: 0, changes: 47
@@ -0,0 +1,47 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+import org.eclipse.jetty.server.Request;
+
+public class Jetty9Request implements ServletRequest {
+    private Request request;
+
+    public Jetty9Request(javax.servlet.ServletRequest request) {
+        this.request = (Request) request;
+    }
+
+    @Override
+    public String getUrl() {
+        return request.getRootURL().append(getUriAsString()).toString();
+    }
+
+    @Override
+    public String getUriPath() {
+        return request.getUri().getPath();
+    }
+
+    @Override
+    public String getUriAsString() {
+        return request.getUri().toString();
+    }
+
+    @Override
+    public void setRequestURI(String uri) {
+        request.setRequestURI(uri);
+    }
+}

--- jetty9/src/com/thoughtworks/go/server/util/Jetty9Response.java (added) ---
additions: 38, deletions: 0, changes: 38
@@ -0,0 +1,38 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+import org.eclipse.jetty.server.Response;
+
+public class Jetty9Response implements ServletResponse {
+    private javax.servlet.ServletResponse servletResponse;
+
+    public Jetty9Response(javax.servlet.ServletResponse servletResponse) {
+
+        this.servletResponse = servletResponse;
+    }
+
+    @Override
+    public int getStatus() {
+        return ((Response) servletResponse).getStatus();
+    }
+
+    @Override
+    public long getContentCount() {
+        return ((Response) servletResponse).getContentCount();
+    }
+}

--- jetty9/src/com/thoughtworks/go/server/util/Jetty9ServletHelper.java (added) ---
additions: 40, deletions: 0, changes: 40
@@ -0,0 +1,40 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+import org.eclipse.jetty.util.UrlEncoded;
+
+import java.net.URLEncoder;
+
+//Do not delete. Invoked using reflection
+public class Jetty9ServletHelper extends ServletHelper {
+    @Override
+    public ServletRequest getRequest(javax.servlet.ServletRequest servletRequest) {
+        return new Jetty9Request(servletRequest);
+    }
+
+    @Override
+    public ServletResponse getResponse(javax.servlet.ServletResponse servletResponse) {
+        return new Jetty9Response(servletResponse);
+    }
+
+    @Override
+    public String encodeString(String string) {
+        return UrlEncoded.encodeString(string);
+    }
+}
+

--- jetty9/test/unit/com/thoughtworks/go/server/AssetsContextHandlerInitializerTest.java (renamed) ---
additions: 17, deletions: 1, changes: 18
@@ -1,7 +1,23 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
 package com.thoughtworks.go.server;
 
+import org.eclipse.jetty.webapp.WebAppContext;
 import org.junit.Test;
-import org.mortbay.jetty.webapp.WebAppContext;
 import java.io.IOException;
 import static org.mockito.Mockito.*;
 

--- jetty9/test/unit/com/thoughtworks/go/server/AssetsContextHandlerTest.java (added) ---
additions: 117, deletions: 0, changes: 117
@@ -0,0 +1,117 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server;
+
+import com.thoughtworks.go.util.OperatingSystem;
+import com.thoughtworks.go.util.ReflectionUtil;
+import com.thoughtworks.go.util.SystemEnvironment;
+import org.eclipse.jetty.server.Request;
+import org.eclipse.jetty.server.handler.ResourceHandler;
+import org.eclipse.jetty.util.resource.Resource;
+import org.eclipse.jetty.webapp.WebAppContext;
+import org.hamcrest.BaseMatcher;
+import org.hamcrest.Description;
+import org.hamcrest.Matcher;
+import org.junit.Before;
+import org.junit.Test;
+
+import javax.servlet.ServletException;
+import javax.servlet.http.HttpServletRequest;
+import javax.servlet.http.HttpServletResponse;
+import java.io.File;
+import java.io.IOException;
+
+import static org.hamcrest.core.Is.is;
+import static org.junit.Assert.assertThat;
+import static org.mockito.Mockito.*;
+
+public class AssetsContextHandlerTest {
+
+
+    private AssetsContextHandler handler;
+    private SystemEnvironment systemEnvironment;
+
+    @Before
+    public void setUp() throws Exception {
+        systemEnvironment = mock(SystemEnvironment.class);
+        when(systemEnvironment.getWebappContextPath()).thenReturn("/go");
+        WebAppContext webAppContext = mock(WebAppContext.class);
+        when(webAppContext.getInitParameter("rails.root")).thenReturn("/rails.root");
+        when(webAppContext.getWebInf()).thenReturn(Resource.newResource("WEB-INF"));
+        handler = new AssetsContextHandler(systemEnvironment);
+
+        handler.init(webAppContext);
+    }
+
+    @Test
+    public void shouldSetHeadersAndBaseDirectory() throws IOException {
+        assertThat(handler.getContextPath(), is("/go/assets"));
+        assertThat(handler.getHandler() instanceof AssetsContextHandler.AssetsHandler, is(true));
+        AssetsContextHandler.AssetsHandler assetsHandler = (AssetsContextHandler.AssetsHandler) handler.getHandler();
+        ResourceHandler resourceHandler = (ResourceHandler) ReflectionUtil.getField(assetsHandler, "resourceHandler");
+        assertThat(resourceHandler.getCacheControl(), is("max-age=31536000,public"));
+        assertThat(resourceHandler.getResourceBase(), isSameFileAs(new File("WEB-INF/rails.root/public/assets").toURI().toString()));
+    }
+
+    @Test
+    public void shouldPassOverHandlingToResourceHandler() throws IOException, ServletException {
+        when(systemEnvironment.useCompressedJs()).thenReturn(true);
+        String target = "/go/assets/junk";
+        Request request = mock(Request.class);
+        HttpServletResponse response = mock(HttpServletResponse.class);
+        Request baseRequest = mock(Request.class);
+        ResourceHandler resourceHandler = mock(ResourceHandler.class);
+        ReflectionUtil.setField(handler.getHandler(), "resourceHandler", resourceHandler);
+
+        handler.getHandler().handle(target, baseRequest, request, response);
+        verify(resourceHandler).handle(target, baseRequest, request, response);
+    }
+
+    @Test
+    public void shouldNotHandleForRails4DevelopmentMode() throws IOException, ServletException {
+        when(systemEnvironment.useCompressedJs()).thenReturn(false);
+
+        String target = "/go/assets/junk";
+        Request request = mock(Request.class);
+        HttpServletResponse response = mock(HttpServletResponse.class);
+        Request baseRequest = mock(Request.class);
+        ResourceHandler resourceHandler = mock(ResourceHandler.class);
+        ReflectionUtil.setField(handler.getHandler(), "resourceHandler", resourceHandler);
+
+        handler.getHandler().handle(target, baseRequest, request, response);
+        verify(resourceHandler, never()).handle(any(String.class), any(Request.class), any(HttpServletRequest.class), any(HttpServletResponse.class));
+    }
+
+    private Matcher<? super String> isSameFileAs(final String expected) {
+        return new BaseMatcher<String>() {
+            @Override
+            public boolean matches(Object o) {
+                String actualFile = (String) o;
+
+                if (OperatingSystem.WINDOWS.equals(new SystemEnvironment().getCurrentOperatingSystem())) {
+                    return expected.equalsIgnoreCase(actualFile);
+                }
+                return expected.equals(actualFile);
+            }
+
+            @Override
+            public void describeTo(Description description) {
+                description.appendText("     " + expected);
+            }
+        };
+    }
+}

--- jetty9/test/unit/com/thoughtworks/go/server/GoCipherSuiteTest.java (added) ---
additions: 76, deletions: 0, changes: 76
@@ -0,0 +1,76 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server;
+
+import com.thoughtworks.go.server.util.GoCipherSuite;
+import org.junit.Test;
+import javax.net.ssl.SSLSocketFactory;
+import java.util.Arrays;
+import java.util.List;
+import static org.hamcrest.core.Is.is;
+import static org.junit.Assert.assertThat;
+import static org.mockito.Mockito.mock;
+import static org.mockito.Mockito.when;
+
+public class GoCipherSuiteTest {
+    @Test
+    public void shouldIncludeTheMagicThreeWhichAreSupportedByOurJetty() throws Exception {
+        SSLSocketFactory socketFactory = mock(SSLSocketFactory.class);
+
+        when(socketFactory.getSupportedCipherSuites()).thenReturn(new String[]{
+                "TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256"
+                , "TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256"
+                , "TLS_RSA_WITH_AES_128_CBC_SHA256"
+                , "SSL_RSA_WITH_RC4_128_SHA"
+                , "TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256"
+                , "TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256"
+                , "TLS_DHE_RSA_WITH_AES_128_CBC_SHA256"
+                , "SSL_RSA_EXPORT_WITH_RC4_40_MD5"
+                , "TLS_DHE_DSS_WITH_AES_128_CBC_SHA256"
+                , "TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA"
+                , "SSL_RSA_WITH_RC4_128_MD5"
+                , "TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA"});
+        GoCipherSuite goCipherSuite = new GoCipherSuite(socketFactory);
+
+        assertThat(Arrays.asList(goCipherSuite.getCipherSuitsToBeIncluded()), is(Arrays.asList("SSL_RSA_WITH_RC4_128_SHA", "SSL_RSA_EXPORT_WITH_RC4_40_MD5", "SSL_RSA_WITH_RC4_128_MD5")));
+    }
+
+    @Test
+    public void shouldIncludeAllSuitesIfTheMagicThreeDoNotExist() throws Exception {
+        SSLSocketFactory socketFactory = mock(SSLSocketFactory.class);
+
+        String[] supportedSuites = {
+                "TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256"
+                , "TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256"
+                , "TLS_RSA_WITH_AES_128_CBC_SHA256"
+                , "TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256"
+                , "TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256"
+                , "TLS_DHE_RSA_WITH_AES_128_CBC_SHA256"
+                , "TLS_DHE_DSS_WITH_AES_128_CBC_SHA256"
+                , "TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA"
+                , "TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA"};
+        when(socketFactory.getSupportedCipherSuites()).thenReturn(supportedSuites);
+        GoCipherSuite goCipherSuite = new GoCipherSuite(socketFactory);
+
+        List<String> includedSuites = Arrays.asList(goCipherSuite.getCipherSuitsToBeIncluded());
+        assertThat(includedSuites.size(), is(supportedSuites.length));
+
+        for (String cipherSuite : includedSuites) {
+            assertThat(Arrays.asList(supportedSuites).contains(cipherSuite), is(true));
+        }
+    }
+}
\ No newline at end of file

--- jetty9/test/unit/com/thoughtworks/go/server/Jetty9ServerTest.java (added) ---
additions: 201, deletions: 0, changes: 201
@@ -0,0 +1,201 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server;
+
+import com.thoughtworks.go.util.ArrayUtil;
+import com.thoughtworks.go.util.ReflectionUtil;
+import com.thoughtworks.go.util.SystemEnvironment;
+import org.eclipse.jetty.jmx.MBeanContainer;
+import org.eclipse.jetty.server.*;
+import org.eclipse.jetty.server.handler.HandlerCollection;
+import org.eclipse.jetty.webapp.JettyWebXmlConfiguration;
+import org.eclipse.jetty.webapp.WebAppContext;
+import org.eclipse.jetty.webapp.WebInfConfiguration;
+import org.eclipse.jetty.webapp.WebXmlConfiguration;
+import org.hamcrest.CoreMatchers;
+import org.junit.Before;
+import org.junit.Rule;
+import org.junit.Test;
+import org.junit.rules.TemporaryFolder;
+import org.mockito.ArgumentCaptor;
+
+import javax.net.ssl.SSLSocketFactory;
+import java.util.Iterator;
+import java.util.List;
+
+import static org.hamcrest.core.Is.is;
+import static org.hamcrest.core.IsNot.not;
+import static org.hamcrest.core.IsNull.nullValue;
+import static org.junit.Assert.assertThat;
+import static org.mockito.Mockito.*;
+
+public class Jetty9ServerTest {
+
+    private Jetty9Server jetty9Server;
+    private Server server;
+    private SystemEnvironment systemEnvironment;
+    @Rule
+    public TemporaryFolder temporaryFolder = new TemporaryFolder();
+    private SSLSocketFactory sslSocketFactory;
+
+
+    @Before
+    public void setUp() throws Exception {
+        server = mock(Server.class);
+        systemEnvironment = mock(SystemEnvironment.class);
+        when(systemEnvironment.getServerPort()).thenReturn(1234);
+        when(systemEnvironment.keystore()).thenReturn(temporaryFolder.newFolder());
+        when(systemEnvironment.truststore()).thenReturn(temporaryFolder.newFolder());
+        when(systemEnvironment.getWebappContextPath()).thenReturn("context");
+        when(systemEnvironment.getCruiseWar()).thenReturn("cruise.war");
+        when(systemEnvironment.getParentLoaderPriority()).thenReturn(true);
+        when(systemEnvironment.useCompressedJs()).thenReturn(true);
+        when(systemEnvironment.get(SystemEnvironment.RESPONSE_BUFFER_SIZE)).thenReturn(1000);
+        when(systemEnvironment.get(SystemEnvironment.IDLE_TIMEOUT)).thenReturn(2000);
+
+        sslSocketFactory = mock(SSLSocketFactory.class);
+        when(sslSocketFactory.getSupportedCipherSuites()).thenReturn(new String[]{});
+        jetty9Server = new Jetty9Server(systemEnvironment, "pwd", sslSocketFactory, server);
+    }
+
+    @Test
+    public void shouldAddMBeanContainerAsEventListener() throws Exception {
+        ArgumentCaptor<MBeanContainer> captor = ArgumentCaptor.forClass(MBeanContainer.class);
+        jetty9Server.configure();
+
+        verify(server).addEventListener(captor.capture());
+        MBeanContainer mBeanContainer = captor.getValue();
+        assertThat(mBeanContainer.getMBeanServer(), is(not(nullValue())));
+    }
+
+    @Test
+    public void shouldAddHttpSocketConnector() throws Exception {
+        ArgumentCaptor<Connector> captor = ArgumentCaptor.forClass(Connector.class);
+        jetty9Server.configure();
+
+        verify(server, times(2)).addConnector(captor.capture());
+
+        List<Connector> connectors = captor.getAllValues();
+        Connector plainConnector = connectors.get(0);
+
+        assertThat(plainConnector instanceof ServerConnector, is(true));
+        ServerConnector connector = (ServerConnector) plainConnector;
+        assertThat(connector.getServer(), is(server));
+        assertThat(connector.getConnectionFactories().size(), is(1));
+        ConnectionFactory connectionFactory = connector.getConnectionFactories().iterator().next();
+        assertThat(connectionFactory instanceof HttpConnectionFactory, is(true));
+    }
+
+    @Test
+    public void shouldAddSSLSocketConnector() throws Exception {
+        ArgumentCaptor<Connector> captor = ArgumentCaptor.forClass(Connector.class);
+        jetty9Server.configure();
+
+        verify(server, times(2)).addConnector(captor.capture());
+        List<Connector> connectors = captor.getAllValues();
+        Connector sslConnector = connectors.get(1);
+
+        assertThat(sslConnector instanceof ServerConnector, is(true));
+        ServerConnector connector = (ServerConnector) sslConnector;
+        assertThat(connector.getServer(), is(server));
+        assertThat(connector.getConnectionFactories().size(), is(2));
+        Iterator<ConnectionFactory> iterator = connector.getConnectionFactories().iterator();
+        ConnectionFactory first = iterator.next();
+        ConnectionFactory second = iterator.next();
+        assertThat(first instanceof SslConnectionFactory, is(true));
+        SslConnectionFactory sslConnectionFactory = (SslConnectionFactory) first;
+        assertThat(sslConnectionFactory.getProtocol(), is("SSL-HTTP/1.1"));
+        assertThat(second instanceof HttpConnectionFactory, is(true));
+    }
+
+    @Test
+    public void shouldAddWelcomeRequestHandler() throws Exception {
+        ArgumentCaptor<HandlerCollection> captor = ArgumentCaptor.forClass(HandlerCollection.class);
+        jetty9Server.configure();
+
+        verify(server, times(1)).setHandler(captor.capture());
+        HandlerCollection handlerCollection = captor.getValue();
+        assertThat(handlerCollection.getHandlers().length, is(3));
+        Handler handler = handlerCollection.getHandlers()[0];
+        assertThat(handler instanceof Jetty9Server.GoServerWelcomeFileHandler, is(true));
+
+        Jetty9Server.GoServerWelcomeFileHandler welcomeFileHandler = (Jetty9Server.GoServerWelcomeFileHandler) handler;
+        assertThat(welcomeFileHandler.getContextPath(), is("/"));
+    }
+
+    @Test
+    public void shouldAddResourceHandlerForAssets() throws Exception {
+        ArgumentCaptor<HandlerCollection> captor = ArgumentCaptor.forClass(HandlerCollection.class);
+        jetty9Server.configure();
+
+        verify(server, times(1)).setHandler(captor.capture());
+        HandlerCollection handlerCollection = captor.getValue();
+        assertThat(handlerCollection.getHandlers().length, is(3));
+
+        Handler handler = handlerCollection.getHandlers()[1];
+        assertThat(handler instanceof AssetsContextHandler, is(true));
+        AssetsContextHandler assetsContextHandler = (AssetsContextHandler) handler;
+        assertThat(assetsContextHandler.getContextPath(), is("context/assets"));
+    }
+
+    @Test
+    public void shouldAddWebAppContextHandler() throws Exception {
+        ArgumentCaptor<HandlerCollection> captor = ArgumentCaptor.forClass(HandlerCollection.class);
+        jetty9Server.configure();
+
+        verify(server, times(1)).setHandler(captor.capture());
+        HandlerCollection handlerCollection = captor.getValue();
+        assertThat(handlerCollection.getHandlers().length, is(3));
+
+        Handler handler = handlerCollection.getHandlers()[2];
+        assertThat(handler instanceof WebAppContext, is(true));
+        WebAppContext webAppContext = (WebAppContext) handler;
+        List<String> configClasses = ArrayUtil.asList(webAppContext.getConfigurationClasses());
+        assertThat(configClasses.contains(WebInfConfiguration.class.getCanonicalName()), is(true));
+        assertThat(configClasses.contains(WebXmlConfiguration.class.getCanonicalName()), is(true));
+        assertThat(configClasses.contains(JettyWebXmlConfiguration.class.getCanonicalName()), is(true));
+        assertThat(webAppContext.getContextPath(), is("context"));
+        assertThat(webAppContext.getWar(), is("cruise.war"));
+        assertThat(webAppContext.isParentLoaderPriority(), is(true));
+        assertThat(webAppContext.getDefaultsDescriptor(), is("jar:file:cruise.war!/WEB-INF/webdefault.xml"));
+    }
+
+    @Test
+    public void shouldSetStopAtShutdown() throws Exception {
+        jetty9Server.configure();
+        verify(server).setStopAtShutdown(true);
+    }
+
+    @Test
+    public void shouldAddExtraJarsIntoClassPath() throws Exception {
+        jetty9Server.configure();
+        jetty9Server.addExtraJarsToClasspath("test-addons/some-addon-dir/addon-1.JAR,test-addons/some-addon-dir/addon-2.jar");
+        assertThat(getWebAppContext(jetty9Server).getExtraClasspath(), is("test-addons/some-addon-dir/addon-1.JAR,test-addons/some-addon-dir/addon-2.jar"));
+    }
+
+    @Test
+    public void shouldSetInitParams() throws Exception {
+        jetty9Server.configure();
+        jetty9Server.setInitParameter("name", "value");
+
+        assertThat(getWebAppContext(jetty9Server).getInitParameter("name"), CoreMatchers.is("value"));
+    }
+
+    private WebAppContext getWebAppContext(Jetty9Server server) {
+        return (WebAppContext) ReflectionUtil.getField(server, "webAppContext");
+    }
+}
\ No newline at end of file

--- jetty9/test/unit/com/thoughtworks/go/server/util/GoPlainSocketConnectorTest.java (added) ---
additions: 49, deletions: 0, changes: 49
@@ -0,0 +1,49 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+import com.thoughtworks.go.server.Jetty9Server;
+import com.thoughtworks.go.util.SystemEnvironment;
+import org.eclipse.jetty.server.*;
+import org.junit.Test;
+
+import javax.net.ssl.SSLSocketFactory;
+
+import static org.hamcrest.core.Is.is;
+import static org.junit.Assert.*;
+import static org.mockito.Mockito.mock;
+import static org.mockito.Mockito.when;
+
+public class GoPlainSocketConnectorTest {
+    @Test
+    public void shouldCreateAServerConnectorWithConfiguredPortAndBuffersize() throws Exception {
+        SystemEnvironment systemEnvironment = mock(SystemEnvironment.class);
+        when(systemEnvironment.getServerPort()).thenReturn(1234);
+        when(systemEnvironment.get(SystemEnvironment.RESPONSE_BUFFER_SIZE)).thenReturn(100);
+        when(systemEnvironment.get(SystemEnvironment.IDLE_TIMEOUT)).thenReturn(200);
+        when(systemEnvironment.getListenHost()).thenReturn("foo");
+        Jetty9Server server = new Jetty9Server(mock(SystemEnvironment.class), null, mock(SSLSocketFactory.class));
+
+        ServerConnector connector = (ServerConnector) new GoPlainSocketConnector(server, systemEnvironment).getConnector();
+
+        assertThat(connector.getPort(), is(1234));
+        assertThat(connector.getHost(), is("foo"));
+        assertThat(connector.getIdleTimeout(), is(200l));
+        HttpConnectionFactory connectionFactory = (HttpConnectionFactory) connector.getDefaultConnectionFactory();
+        assertThat(connectionFactory.getHttpConfiguration().getOutputBufferSize(), is(100));
+    }
+}
\ No newline at end of file

--- jetty9/test/unit/com/thoughtworks/go/server/util/GoSslSocketConnectorTest.java (added) ---
additions: 124, deletions: 0, changes: 124
@@ -0,0 +1,124 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+import com.thoughtworks.go.server.Jetty9Server;
+import com.thoughtworks.go.util.ArrayUtil;
+import com.thoughtworks.go.util.ListUtil;
+import com.thoughtworks.go.util.SystemEnvironment;
+import org.eclipse.jetty.server.*;
+import org.eclipse.jetty.util.ssl.SslContextFactory;
+import org.junit.Before;
+import org.junit.Rule;
+import org.junit.Test;
+import org.junit.rules.TemporaryFolder;
+
+import java.io.File;
+import java.util.Collection;
+import java.util.List;
+
+import static org.hamcrest.core.Is.is;
+import static org.junit.Assert.*;
+import static org.mockito.Mockito.mock;
+import static org.mockito.Mockito.when;
+
+public class GoSslSocketConnectorTest {
+    @Rule
+    public TemporaryFolder folder = new TemporaryFolder();
+    private File truststore;
+    private File keystore;
+    private GoSslSocketConnector sslSocketConnector;
+
+    @Before
+    public void setUp() throws Exception {
+        keystore = folder.newFile("keystore");
+        truststore = folder.newFile("truststore");
+        GoCipherSuite cipherSuite = mock(GoCipherSuite.class);
+        String[] cipherSuitesToBeIncluded = {"FOO"};
+        when(cipherSuite.getCipherSuitsToBeIncluded()).thenReturn(cipherSuitesToBeIncluded);
+        SystemEnvironment systemEnvironment = mock(SystemEnvironment.class);
+        when(systemEnvironment.getSslServerPort()).thenReturn(1234);
+        when(systemEnvironment.keystore()).thenReturn(keystore);
+        when(systemEnvironment.truststore()).thenReturn(truststore);
+        when(systemEnvironment.get(SystemEnvironment.RESPONSE_BUFFER_SIZE)).thenReturn(100);
+        when(systemEnvironment.get(SystemEnvironment.IDLE_TIMEOUT)).thenReturn(200);
+        when(systemEnvironment.getListenHost()).thenReturn("foo");
+
+        Jetty9Server jettyServer = mock(Jetty9Server.class);
+        when(jettyServer.getServer()).thenReturn(new Server());
+        sslSocketConnector = new GoSslSocketConnector(jettyServer, "password", systemEnvironment, cipherSuite);
+    }
+
+    @Test
+    public void shouldCreateSslConnectorWithRelevantPortAndTimeout() {
+        assertThat(sslSocketConnector.getConnector() instanceof ServerConnector, is(true));
+        ServerConnector connector = (ServerConnector) sslSocketConnector.getConnector();
+        assertThat(connector.getPort(), is(1234));
+        assertThat(connector.getHost(), is("foo"));
+        assertThat(connector.getIdleTimeout(), is(200l));
+    }
+
+    @Test
+    public void shouldSetupSslContextWithKeystoreAndTruststore() {
+        ServerConnector connector = (ServerConnector) sslSocketConnector.getConnector();
+        Collection<ConnectionFactory> connectionFactories = connector.getConnectionFactories();
+        SslContextFactory sslContextFactory = findSslContextFactory(connectionFactories);
+        assertThat(sslContextFactory.getKeyStorePath(), is(keystore.getAbsolutePath()));
+        assertThat(sslContextFactory.getTrustStore(), is(truststore.getAbsolutePath()));
+        assertThat(sslContextFactory.getWantClientAuth(), is(true));
+    }
+
+    @Test
+    public void shouldSetupCipherSuitesToBeIncluded() {
+        ServerConnector connector = (ServerConnector) sslSocketConnector.getConnector();
+        Collection<ConnectionFactory> connectionFactories = connector.getConnectionFactories();
+        SslContextFactory sslContextFactory = findSslContextFactory(connectionFactories);
+
+        List<String> includedCipherSuites = ArrayUtil.asList(sslContextFactory.getIncludeCipherSuites());
+        assertThat(includedCipherSuites.size(), is(1));
+        assertThat(includedCipherSuites.contains("FOO"), is(true));
+    }
+
+    @Test
+    public void shouldSetupHttpConnectionFactory() {
+        ServerConnector connector = (ServerConnector) sslSocketConnector.getConnector();
+        Collection<ConnectionFactory> connectionFactories = connector.getConnectionFactories();
+
+        HttpConnectionFactory httpConnectionFactory = (HttpConnectionFactory) ListUtil.find(connectionFactories, new ListUtil.Condition() {
+            @Override
+            public <T> boolean isMet(T item) {
+                ConnectionFactory factory = (ConnectionFactory) item;
+                return factory instanceof HttpConnectionFactory;
+            }
+        });
+        assertThat(httpConnectionFactory.getHttpConfiguration().getOutputBufferSize(), is(100));
+        assertThat(httpConnectionFactory.getHttpConfiguration().getCustomizers().size(), is(1));
+        assertThat(httpConnectionFactory.getHttpConfiguration().getCustomizers().get(0) instanceof SecureRequestCustomizer, is(true));
+    }
+
+    private SslContextFactory findSslContextFactory(Collection<ConnectionFactory> connectionFactories) {
+        return ((SslConnectionFactory) ListUtil.find(connectionFactories, new ListUtil.Condition() {
+            @Override
+            public <T> boolean isMet(T item) {
+                ConnectionFactory factory = (ConnectionFactory) item;
+                return factory instanceof SslConnectionFactory;
+            }
+        })).getSslContextFactory();
+    }
+
+
+}
\ No newline at end of file

--- jetty9/test/unit/com/thoughtworks/go/server/util/Jetty9RequestTest.java (added) ---
additions: 62, deletions: 0, changes: 62
@@ -0,0 +1,62 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+import org.eclipse.jetty.http.HttpURI;
+import org.eclipse.jetty.server.Request;
+import org.junit.Before;
+import org.junit.Test;
+
+import static org.hamcrest.core.Is.is;
+import static org.junit.Assert.assertThat;
+import static org.mockito.Mockito.mock;
+import static org.mockito.Mockito.verify;
+import static org.mockito.Mockito.when;
+
+public class Jetty9RequestTest {
+    private Jetty9Request jetty9Request;
+    private Request request;
+
+    @Before
+    public void setUp() throws Exception {
+        request = mock(Request.class);
+        jetty9Request = new Jetty9Request(request);
+        when(request.getUri()).thenReturn(new HttpURI("foo/bar/baz"));
+        when(request.getRootURL()).thenReturn(new StringBuilder("http://junk/"));
+    }
+
+    @Test
+    public void shouldGetUrl() {
+        assertThat(jetty9Request.getUrl(), is("http://junk/foo/bar/baz"));
+    }
+
+    @Test
+    public void shouldGetUriPath() {
+        assertThat(jetty9Request.getUriPath(), is("foo/bar/baz"));
+    }
+
+    @Test
+    public void shouldGetUriAsString() {
+        assertThat(jetty9Request.getUriAsString(), is("foo/bar/baz"));
+    }
+
+    @Test
+    public void shouldSetRequestUri() {
+        jetty9Request.setRequestURI("foo");
+        verify(request).setRequestURI("foo");
+    }
+}
\ No newline at end of file

--- jetty9/test/unit/com/thoughtworks/go/server/util/Jetty9ResponseTest.java (added) ---
additions: 49, deletions: 0, changes: 49
@@ -0,0 +1,49 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+import org.eclipse.jetty.server.Response;
+import org.junit.Before;
+import org.junit.Test;
+
+import static org.hamcrest.core.Is.is;
+import static org.junit.Assert.*;
+import static org.mockito.Mockito.mock;
+import static org.mockito.Mockito.when;
+
+public class Jetty9ResponseTest {
+    private Jetty9Response jetty9Response;
+    private Response response;
+
+    @Before
+    public void setUp() throws Exception {
+        response = mock(Response.class);
+        jetty9Response = new Jetty9Response(response);
+    }
+
+    @Test
+    public void shouldGetResponseStatus() {
+        when(response.getStatus()).thenReturn(200);
+        assertThat(jetty9Response.getStatus(), is(200));
+    }
+
+    @Test
+    public void shouldGetResponseContentCount() {
+        when(response.getContentCount()).thenReturn(2000l);
+        assertThat(jetty9Response.getContentCount(), is(2000l));
+    }
+}
\ No newline at end of file

--- jetty9/test/unit/com/thoughtworks/go/server/util/Jetty9ServletHelperTest.java (added) ---
additions: 45, deletions: 0, changes: 45
@@ -0,0 +1,45 @@
+/*************************GO-LICENSE-START*********************************
+ * Copyright 2015 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END***********************************/
+
+package com.thoughtworks.go.server.util;
+
+import org.eclipse.jetty.server.Request;
+import org.eclipse.jetty.server.Response;
+import org.junit.Test;
+
+import static org.hamcrest.core.Is.is;
+import static org.junit.Assert.*;
+import static org.mockito.Mockito.mock;
+
+public class Jetty9ServletHelperTest {
+    @Test
+    public void shouldGetInstanceOfServletHelper(){
+        ServletHelper.init(true);
+        assertThat(ServletHelper.getInstance() instanceof Jetty9ServletHelper, is(true));
+    }
+
+    @Test
+    public void shouldGetJetty6Request() {
+        ServletRequest request = new Jetty9ServletHelper().getRequest(mock(Request.class));
+        assertThat(request instanceof Jetty9Request, is(true));
+    }
+
+    @Test
+    public void shouldGetJetty6Response() {
+        ServletResponse response = new Jetty9ServletHelper().getResponse(mock(Response.class));
+        assertThat(response instanceof Jetty9Response, is(true));
+    }
+}
\ No newline at end of file

--- plugin-infra/go-plugin-infra/pom.xml (modified) ---
additions: 1, deletions: 1, changes: 2
@@ -75,7 +75,7 @@
 		<dependency>
 			<groupId>org.slf4j</groupId>
 			<artifactId>slf4j-log4j12</artifactId>
-			<version>1.5.8</version>
+			<version>1.7.2</version>
 		</dependency>
 
         <!-- test dependencies -->

--- pom.xml (modified) ---
additions: 4, deletions: 2, changes: 6
@@ -55,7 +55,6 @@
 
         <spring.version>3.1.3.RELEASE</spring.version>
         <spring-security.version>2.0.3</spring-security.version>
-        <jetty.version>6.1.23</jetty.version>
         <commons.io.version>2.4</commons.io.version>
 
         <jmock.version>2.4.0</jmock.version>
@@ -98,9 +97,12 @@
         <module>rack_hack</module>
         <module>server</module>
         <module>server-launcher</module>
-
+        <module>app-server</module>
+        <module>jetty9</module>
+        <module>jetty6</module>
         <module>development-utility/development-agent</module>
         <module>development-utility/development-server</module>
+        <module>development-utility/development-server-with-jetty6</module>
     </modules>
     <profiles>
             <profile>

--- rack_hack/pom.xml (modified) ---
additions: 5, deletions: 7, changes: 12
@@ -39,16 +39,14 @@
     <dependencies>
         <dependency>
             <groupId>javax.servlet</groupId>
-            <artifactId>servlet-api</artifactId>
-            <version>2.5</version>
+            <artifactId>javax.servlet-api</artifactId>
+            <version>3.1.0</version>
             <scope>provided</scope>
         </dependency>
-
         <dependency>
-            <groupId>org.mortbay.jetty</groupId>
-            <artifactId>jetty</artifactId>
-            <version>${jetty.version}</version>
-            <scope>provided</scope>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>app-server</artifactId>
+            <version>1.0</version>
         </dependency>
 
         <!-- test dependencies -->

--- rack_hack/src/com/thoughtworks/go/rackhack/DelegatingServlet.java (modified) ---
additions: 6, deletions: 3, changes: 9
@@ -16,7 +16,7 @@
 
 package com.thoughtworks.go.rackhack;
 
-import org.mortbay.jetty.Request;
+import com.thoughtworks.go.server.util.ServletHelper;
 
 import javax.servlet.ServletConfig;
 import javax.servlet.ServletException;
@@ -26,9 +26,11 @@
 import javax.servlet.http.HttpServletRequest;
 import javax.servlet.http.HttpServletResponse;
 import java.io.IOException;
+import java.lang.reflect.Method;
 
 public class DelegatingServlet extends HttpServlet {
     private HttpServlet rackServlet;
+    private ServletHelper servletHelper;
 
     public DelegatingServlet() {
     }
@@ -37,12 +39,13 @@ public DelegatingServlet() {
     public void init(ServletConfig config) throws ServletException {
         rackServlet = (HttpServlet) config.getServletContext().getAttribute(DelegatingListener.DELEGATE_SERVLET);
         rackServlet.init(config);
+        servletHelper = ServletHelper.getInstance();
     }
 
     @Override
     public void service(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
-        Request req = (Request) request;
-        req.setRequestURI(req.getRequestURI().replaceAll("^/go/rails/", "/go/"));
+        String url = request.getRequestURI().replaceAll("^/go/rails/", "/go/");
+        servletHelper.getRequest(request).setRequestURI(url);
         rackServlet.service(request, response);
     }
 

--- rack_hack/test/com/thoughtworks/go/rackhack/DelegatingServletTest.java (modified) ---
additions: 22, deletions: 23, changes: 45
@@ -16,24 +16,40 @@
 
 package com.thoughtworks.go.rackhack;
 
+import com.thoughtworks.go.server.util.ServletHelper;
+import com.thoughtworks.go.util.ReflectionUtil;
+import org.junit.Before;
 import org.junit.Test;
-import org.mortbay.jetty.Request;
 import org.springframework.mock.web.MockHttpServletResponse;
 import org.springframework.mock.web.MockServletConfig;
 import org.springframework.mock.web.MockServletContext;
 
 import javax.servlet.ServletContextEvent;
 import javax.servlet.ServletException;
+import javax.servlet.http.HttpServletRequest;
 import java.io.IOException;
 
 import static org.hamcrest.CoreMatchers.is;
 import static org.hamcrest.CoreMatchers.isA;
 import static org.junit.Assert.assertThat;
+import static org.mockito.Matchers.any;
+import static org.mockito.Mockito.mock;
+import static org.mockito.Mockito.verify;
+import static org.mockito.Mockito.when;
 
 public class DelegatingServletTest {
-    public String uri = "/go/rails/stuff/action";
-    public String attrName;
-    public String attrValue;
+    private com.thoughtworks.go.server.util.ServletRequest servletRequestWrapper;
+    private HttpServletRequest httpServletRequest;
+
+    @Before
+    public void setUp() throws Exception {
+        ServletHelper servletHelper = mock(ServletHelper.class);
+        ReflectionUtil.setStaticField(ServletHelper.class, "instance", servletHelper);
+        servletRequestWrapper = mock(com.thoughtworks.go.server.util.ServletRequest.class);
+        httpServletRequest = mock(HttpServletRequest.class);
+        when(httpServletRequest.getRequestURI()).thenReturn("/go/rails/stuff/action");
+        when(servletHelper.getRequest(httpServletRequest)).thenReturn(servletRequestWrapper);
+    }
 
     @Test
     public void shouldDelegateToTheGivenServlet() throws IOException, ServletException {
@@ -45,25 +61,8 @@ public void shouldDelegateToTheGivenServlet() throws IOException, ServletExcepti
         assertThat((DummyServlet) ctx.getAttribute(DelegatingListener.DELEGATE_SERVLET), isA(DummyServlet.class));
         DelegatingServlet servlet = new DelegatingServlet();
         servlet.init(new MockServletConfig(ctx));
-        Request request = new Request() {
-            @Override
-            public String getRequestURI() {
-                return uri;
-            }
-
-            @Override
-            public void setRequestURI(String newUri) {
-                uri = newUri;
-            }
 
-            @Override
-            public void setAttribute(String name, Object value) {
-                attrName = name;
-                attrValue = value.toString();
-            }
-        };
-        servlet.service(request, new MockHttpServletResponse());
-        assertThat(attrName, is(DummyServlet.URI_ATTRIBUTE));
-        assertThat(attrValue, is("/go/stuff/action"));
+        servlet.service(httpServletRequest, new MockHttpServletResponse());
+        verify(servletRequestWrapper).setRequestURI("/go/stuff/action");
     }
 }

--- server-launcher/pom.xml (modified) ---
additions: 12, deletions: 43, changes: 55
@@ -35,45 +35,9 @@
     <dependencies>
         <dependency>
             <groupId>javax.servlet</groupId>
-            <artifactId>servlet-api</artifactId>
-            <version>2.5</version>
+            <artifactId>javax.servlet-api</artifactId>
+            <version>3.1.0</version>
         </dependency>
-
-		<!-- jetty -->
-		<dependency>
-			<groupId>org.mortbay.jetty</groupId>
-			<artifactId>jetty-management</artifactId>
-			<version>${jetty.version}</version>
-            <exclusions>
-                <exclusion>
-                    <groupId>org.mortbay.jetty</groupId>
-                    <artifactId>servlet-api</artifactId>
-                </exclusion>
-            </exclusions>
-		</dependency>
-		<dependency>
-			<groupId>org.mortbay.jetty</groupId>
-			<artifactId>jetty-naming</artifactId>
-			<version>${jetty.version}</version>
-		</dependency>
-		<dependency>
-			<groupId>org.mortbay.jetty</groupId>
-			<artifactId>jetty-sslengine</artifactId>
-			<version>${jetty.version}</version>
-            <exclusions>
-                <exclusion>
-                    <groupId>org.mortbay.jetty</groupId>
-                    <artifactId>servlet-api</artifactId>
-                </exclusion>
-            </exclusions>
-		</dependency>
-		<dependency>
-			<groupId>org.mortbay.jetty</groupId>
-			<artifactId>jetty-plus</artifactId>
-			<version>${jetty.version}</version>
-		</dependency>
-		<!-- jetty end -->
-
 		<dependency>
 			<groupId>org.bouncycastle</groupId>
 			<artifactId>bcprov-jdk15on</artifactId>
@@ -98,11 +62,16 @@
 			<version>1.2.12</version>
 		</dependency>
 
-		<dependency>
-			<groupId>org.slf4j</groupId>
-			<artifactId>slf4j-log4j12</artifactId>
-			<version>1.5.8</version>
-		</dependency>
+        <dependency>
+            <groupId>org.slf4j</groupId>
+            <artifactId>slf4j-api</artifactId>
+            <version>1.7.2</version>
+        </dependency>
+        <dependency>
+            <groupId>org.slf4j</groupId>
+            <artifactId>slf4j-log4j12</artifactId>
+            <version>1.7.2</version>
+        </dependency>
 
 		<dependency>
 			<groupId>com.jezhumble</groupId>

--- server/config/jetty.xml (modified) ---
additions: 27, deletions: 21, changes: 48
@@ -15,43 +15,49 @@
  * limitations under the License.
  *************************GO-LICENSE-END******************************* -->
 
-<!DOCTYPE Configure PUBLIC "-//Mort Bay Consulting//DTD Configure//EN" "http://jetty.mortbay.org/configure.dtd">
+<!DOCTYPE Configure PUBLIC "-//Jetty//Configure//EN" "http://www.eclipse.org/jetty/configure.dtd">
 
-<Configure id="Server" class="org.mortbay.jetty.Server">
+<Configure id="Server" class="org.eclipse.jetty.server.Server">
 
     <!-- =========================================================== -->
     <!-- Server Thread Pool                                          -->
     <!-- =========================================================== -->
-    <Set name="ThreadPool">
-      <New class="org.mortbay.thread.QueuedThreadPool">
+    <Get name="ThreadPool">
         <Set name="minThreads">20</Set>
         <Set name="maxThreads">300</Set>
+        <!-- New Jetty QTP does not have these two properties below.
         <Set name="lowThreads">10</Set>
         <Set name="SpawnOrShrinkAt">2</Set>
-      </New>
-    </Set>
+        -->
+    </Get>
+    <Call name="setAttribute">
+        <Arg>org.eclipse.jetty.server.Request.maxFormContentSize</Arg>
+        <Arg>30000000</Arg>
+    </Call>
 
     <!-- =========================================================== -->
     <!-- Logging                                                     -->
     <!-- =========================================================== -->
     <!-- Note: Please create the weblogs directory if not exist -->
     <!--
+    <Get name="handler">
         <Call name="addHandler">
-        <Arg>
-            <New class="org.mortbay.jetty.handler.RequestLogHandler">
-              <Set name="requestLog">
-                <New class="org.mortbay.jetty.NCSARequestLog">
-                    <Arg><SystemProperty name="jetty.logs" default="./weblogs"/>/jetty-yyyy_mm_dd.request.log</Arg>
-                    <Set name="filenameDateFormat">yyyy_MM_dd</Set>
-                    <Set name="retainDays">7</Set>
-                    <Set name="append">true</Set>
-                    <Set name="extended">false</Set>
-                    <Set name="logCookies">false</Set>
-                    <Set name="logLatency">false</Set>
+            <Arg>
+                <New class="org.eclipse.jetty.server.handler.RequestLogHandler">
+                    <Set name="requestLog">
+                        <New class="org.eclipse.jetty.server.NCSARequestLog">
+                            <Arg><SystemProperty name="jetty.logs" default="./weblogs"/>/jetty-yyyy_mm_dd.request.log</Arg>
+                            <Set name="filenameDateFormat">yyyy_MM_dd</Set>
+                            <Set name="retainDays">7</Set>
+                            <Set name="append">true</Set>
+                            <Set name="extended">false</Set>
+                            <Set name="logCookies">false</Set>
+                            <Set name="logLatency">false</Set>
+                        </New>
+                    </Set>
                 </New>
-              </Set>
-            </New>
-        </Arg>
-      </Call>
+            </Arg>
+        </Call>
+    </Get>
     -->
 </Configure>

--- server/config/jetty6.xml (added) ---
additions: 61, deletions: 0, changes: 61
@@ -0,0 +1,61 @@
+<?xml version="1.0"?>
+<!-- *************************GO-LICENSE-START******************************
+ * Copyright 2014 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END******************************* -->
+
+<!DOCTYPE Configure PUBLIC "-//Mort Bay Consulting//DTD Configure//EN" "http://jetty.mortbay.org/configure.dtd">
+
+<Configure id="Server" class="org.mortbay.jetty.Server">
+
+    <!-- =========================================================== -->
+    <!-- Server Thread Pool                                          -->
+    <!-- =========================================================== -->
+    <Set name="ThreadPool">
+      <New class="org.mortbay.thread.QueuedThreadPool">
+        <Set name="minThreads">20</Set>
+        <Set name="maxThreads">300</Set>
+        <Set name="lowThreads">10</Set>
+        <Set name="SpawnOrShrinkAt">2</Set>
+      </New>
+    </Set>
+
+    <Call class="java.lang.System" name="setProperty">
+        <Arg>org.mortbay.jetty.Request.maxFormContentSize</Arg>
+        <Arg>30000000</Arg>
+    </Call>
+    <!-- =========================================================== -->
+    <!-- Logging                                                     -->
+    <!-- =========================================================== -->
+    <!-- Note: Please create the weblogs directory if not exist -->
+    <!--
+        <Call name="addHandler">
+        <Arg>
+            <New class="org.mortbay.jetty.handler.RequestLogHandler">
+              <Set name="requestLog">
+                <New class="org.mortbay.jetty.NCSARequestLog">
+                    <Arg><SystemProperty name="jetty.logs" default="./weblogs"/>/jetty-yyyy_mm_dd.request.log</Arg>
+                    <Set name="filenameDateFormat">yyyy_MM_dd</Set>
+                    <Set name="retainDays">7</Set>
+                    <Set name="append">true</Set>
+                    <Set name="extended">false</Set>
+                    <Set name="logCookies">false</Set>
+                    <Set name="logLatency">false</Set>
+                </New>
+              </Set>
+            </New>
+        </Arg>
+      </Call>
+    -->
+</Configure>

--- server/jsunit/logging.properties (modified) ---
additions: 12, deletions: 12, changes: 24
@@ -14,15 +14,15 @@
 # limitations under the License.
 ##########################GO-LICENSE-END##################################
 
-.level=INFO
-
-handlers=java.util.logging.ConsoleHandler
-
-java.util.logging.ConsoleHandler.level=ALL
-java.util.logging.ConsoleHandler.formatter=java.util.logging.SimpleFormatter
-
-net.jsunit.level=INFO
-org.mortbay.level=WARNING
-com.opensymphony.webwork.level=SEVERE
-com.opensymphony.xwork.level=SEVERE
-
+.level=INFO
+
+handlers=java.util.logging.ConsoleHandler
+
+java.util.logging.ConsoleHandler.level=ALL
+java.util.logging.ConsoleHandler.formatter=java.util.logging.SimpleFormatter
+
+net.jsunit.level=INFO
+org.eclipse.jetty.level=WARNING
+com.opensymphony.webwork.level=SEVERE
+com.opensymphony.xwork.level=SEVERE
+

--- server/pom.xml (modified) ---
additions: 89, deletions: 91, changes: 180
@@ -70,44 +70,12 @@
             <version>1.0</version>
         </dependency>
 
-        <!-- jetty -->
         <dependency>
-            <groupId>org.mortbay.jetty</groupId>
-            <artifactId>jetty</artifactId>
-            <version>${jetty.version}</version>
-            <scope>provided</scope>
-        </dependency>
-        <dependency>
-            <groupId>org.mortbay.jetty</groupId>
-            <artifactId>jetty-util</artifactId>
-            <version>${jetty.version}</version>
-            <scope>provided</scope>
-        </dependency>
-        <dependency>
-            <groupId>org.mortbay.jetty</groupId>
-            <artifactId>jetty-management</artifactId>
-            <version>${jetty.version}</version>
-            <scope>provided</scope>
-        </dependency>
-        <dependency>
-            <groupId>org.mortbay.jetty</groupId>
-            <artifactId>jetty-naming</artifactId>
-            <version>${jetty.version}</version>
-            <scope>provided</scope>
-        </dependency>
-        <dependency>
-            <groupId>org.mortbay.jetty</groupId>
-            <artifactId>jetty-sslengine</artifactId>
-            <version>${jetty.version}</version>
-            <scope>provided</scope>
-        </dependency>
-        <dependency>
-            <groupId>org.mortbay.jetty</groupId>
-            <artifactId>jetty-plus</artifactId>
-            <version>${jetty.version}</version>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>app-server</artifactId>
+            <version>1.0</version>
             <scope>provided</scope>
         </dependency>
-        <!-- jetty end -->
 
         <!-- apache commons -->
         <dependency>
@@ -565,6 +533,16 @@
             <scope>provided</scope>
         </dependency>
 
+        <dependency>
+            <groupId>org.slf4j</groupId>
+            <artifactId>slf4j-api</artifactId>
+            <version>1.7.2</version>
+        </dependency>
+        <dependency>
+            <groupId>org.slf4j</groupId>
+            <artifactId>slf4j-log4j12</artifactId>
+            <version>1.7.2</version>
+        </dependency>
         <!-- test dependencies -->
         <dependency>
             <groupId>com.thoughtworks.go</groupId>
@@ -600,7 +578,12 @@
             <version>1.0</version>
             <scope>test</scope>
         </dependency>
-
+        <dependency>
+            <groupId>com.thoughtworks.go</groupId>
+            <artifactId>jetty9</artifactId>
+            <version>1.0</version>
+            <scope>test</scope>
+        </dependency>
         <dependency>
             <groupId>com.tlb</groupId>
             <artifactId>tlb-java</artifactId>
@@ -640,6 +623,22 @@
                     <groupId>com.sun</groupId>
                     <artifactId>tools</artifactId>
                 </exclusion>
+                <exclusion>
+                    <groupId>org.mortbay.jetty</groupId>
+                    <artifactId>servlet-api-2.5</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>org.mortbay.jetty</groupId>
+                    <artifactId>jetty</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>org.mortbay.jetty</groupId>
+                    <artifactId>jetty-util</artifactId>
+                </exclusion>
+                <exclusion>
+                    <groupId>org.mortbay.jetty</groupId>
+                    <artifactId>jetty-servlet-tester</artifactId>
+                </exclusion>
             </exclusions>
         </dependency>
     </dependencies>
@@ -744,6 +743,44 @@
                 <artifactId>maven-antrun-plugin</artifactId>
                 <version>1.7</version>
                 <executions>
+                    <execution>
+                        <id>store-server-test-classpath</id>
+                        <phase>test</phase>
+                        <goals>
+                            <goal>run</goal>
+                        </goals>
+                        <configuration>
+                            <tasks>
+                                <property name="test_classpath" refid="maven.test.classpath"/>
+                                <echo file="target/server-test-dependencies" append="false">${test_classpath}</echo>
+                            </tasks>
+                        </configuration>
+                    </execution>
+                    <execution>
+                        <id>prepare-webapp</id>
+                        <phase>prepare-package</phase>
+                        <goals>
+                            <goal>run</goal>
+                        </goals>
+                        <configuration>
+                            <tasks>
+                                <exec executable="${main.dir}\tools\bin\go.jruby.bat" failonerror="true" osfamily="windows">
+                                    <arg value="-S"></arg>
+                                    <arg value="rake"></arg>
+                                    <arg value="--rakefile"></arg>
+                                    <arg value="prepare_go_server_webapp.rake"></arg>
+                                    <arg value="prepare_webapp"></arg>
+                                </exec>
+                                <exec executable="${main.dir}/tools/bin/go.jruby" failonerror="true" osfamily="unix">
+                                    <arg value="-S"></arg>
+                                    <arg value="rake"></arg>
+                                    <arg value="--rakefile"></arg>
+                                    <arg value="prepare_go_server_webapp.rake"></arg>
+                                    <arg value="prepare_webapp"></arg>
+                                </exec>
+                            </tasks>
+                        </configuration>
+                    </execution>
                     <execution>
                         <id>ant.test.tlb</id>
                         <phase>test</phase>
@@ -829,65 +866,26 @@
                                 <groupId>com.sun</groupId>
                                 <artifactId>tools</artifactId>
                             </exclusion>
+                            <exclusion>
+                                <groupId>org.mortbay.jetty</groupId>
+                                <artifactId>servlet-api-2.5</artifactId>
+                            </exclusion>
+                            <exclusion>
+                                <groupId>org.mortbay.jetty</groupId>
+                                <artifactId>jetty</artifactId>
+                            </exclusion>
+                            <exclusion>
+                                <groupId>org.mortbay.jetty</groupId>
+                                <artifactId>jetty-util</artifactId>
+                            </exclusion>
+                            <exclusion>
+                                <groupId>org.mortbay.jetty</groupId>
+                                <artifactId>jetty-servlet-tester</artifactId>
+                            </exclusion>
                         </exclusions>
                     </dependency>
                 </dependencies>
             </plugin>
-
-            <plugin>
-                <groupId>org.apache.maven.plugins</groupId>
-                <artifactId>maven-antrun-plugin</artifactId>
-                <version>1.7</version>
-                <executions>
-                    <execution>
-                        <id>store-server-test-classpath</id>
-                        <phase>test</phase>
-                        <goals>
-                            <goal>run</goal>
-                        </goals>
-                        <configuration>
-                            <tasks>
-                                <property name="test_classpath" refid="maven.test.classpath"/>
-                                <echo file="target/server-test-dependencies" append="false">${test_classpath}</echo>
-                            </tasks>
-                        </configuration>
-                    </execution>
-                </executions>
-            </plugin>
-
-            <plugin>
-                <groupId>org.apache.maven.plugins</groupId>
-                <artifactId>maven-antrun-plugin</artifactId>
-                <version>1.7</version>
-                <executions>
-                    <execution>
-                        <id>prepare-webapp</id>
-                        <phase>prepare-package</phase>
-                        <goals>
-                            <goal>run</goal>
-                        </goals>
-                        <configuration>
-                            <tasks>
-                                <exec executable="${main.dir}\tools\bin\go.jruby.bat" failonerror="true" osfamily="windows">
-                                    <arg value="-S"></arg>
-                                    <arg value="rake"></arg>
-                                    <arg value="--rakefile"></arg>
-                                    <arg value="prepare_go_server_webapp.rake"></arg>
-                                    <arg value="prepare_webapp"></arg>
-                                </exec>
-                                <exec executable="${main.dir}/tools/bin/go.jruby" failonerror="true" osfamily="unix">
-                                    <arg value="-S"></arg>
-                                    <arg value="rake"></arg>
-                                    <arg value="--rakefile"></arg>
-                                    <arg value="prepare_go_server_webapp.rake"></arg>
-                                    <arg value="prepare_webapp"></arg>
-                                </exec>
-                            </tasks>
-                        </configuration>
-                    </execution>
-                </executions>
-            </plugin>
-
             <plugin>
                 <groupId>org.apache.maven.plugins</groupId>
                 <artifactId>maven-war-plugin</artifactId>

--- server/src/com/thoughtworks/go/server/GoServer.java (modified) ---
additions: 36, deletions: 204, changes: 240
@@ -16,9 +16,6 @@
 
 package com.thoughtworks.go.server;
 
-import com.thoughtworks.go.server.util.GoCipherSuite;
-import com.thoughtworks.go.server.util.GoSslSocketConnector;
-import com.thoughtworks.go.util.GoConstants;
 import com.thoughtworks.go.util.SubprocessLogger;
 import com.thoughtworks.go.util.SystemEnvironment;
 import com.thoughtworks.go.util.validators.*;
@@ -27,54 +24,32 @@
 import org.apache.commons.io.filefilter.FalseFileFilter;
 import org.apache.commons.io.filefilter.SuffixFileFilter;
 import org.apache.log4j.Logger;
-import org.mortbay.jetty.Connector;
-import org.mortbay.jetty.HttpMethods;
-import org.mortbay.jetty.HttpStatus;
-import org.mortbay.jetty.Server;
-import org.mortbay.jetty.handler.ContextHandler;
-import org.mortbay.jetty.nio.SelectChannelConnector;
-import org.mortbay.jetty.servlet.ServletHolder;
-import org.mortbay.jetty.webapp.WebAppContext;
-import org.mortbay.management.MBeanContainer;
-import org.mortbay.xml.XmlConfiguration;
-import org.xml.sax.SAXException;
 
-import javax.management.MBeanServer;
 import javax.net.ssl.SSLSocketFactory;
-import javax.servlet.ServletException;
-import javax.servlet.UnavailableException;
-import javax.servlet.http.HttpServletRequest;
-import javax.servlet.http.HttpServletResponse;
 import java.io.File;
-import java.io.FileInputStream;
-import java.io.IOException;
-import java.io.PrintWriter;
-import java.lang.management.ManagementFactory;
+import java.lang.reflect.Constructor;
 import java.util.ArrayList;
 import java.util.List;
-import java.util.Map;
 
 public class GoServer {
 
     private static final Logger LOG = Logger.getLogger(GoServer.class);
     public static final String GO_FORCE_LOAD_PAGE_HEADER = "X-GO-FORCE-LOAD-PAGE";
 
     private SystemEnvironment systemEnvironment;
+    private SSLSocketFactory sslSocketFactory;
     private final String password = "serverKeystorepa55w0rd";
-    private JettyServer server;
+    private AppServer server;
     protected SubprocessLogger subprocessLogger;
-    private GoCipherSuite goCipherSuite;
-    private GoWebXmlConfiguration configuration;
 
     public GoServer() {
-        this(new SystemEnvironment(), new GoCipherSuite((SSLSocketFactory) SSLSocketFactory.getDefault()), new GoWebXmlConfiguration());
+        this(new SystemEnvironment(), (SSLSocketFactory) SSLSocketFactory.getDefault());
     }
 
-    protected GoServer(SystemEnvironment systemEnvironment, GoCipherSuite goCipherSuite, GoWebXmlConfiguration goWebXmlConfiguration) {
+    protected GoServer(SystemEnvironment systemEnvironment, SSLSocketFactory sslSocketFactory) {
         this.systemEnvironment = systemEnvironment;
+        this.sslSocketFactory = sslSocketFactory;
         subprocessLogger = new SubprocessLogger();
-        this.goCipherSuite = goCipherSuite;
-        this.configuration = goWebXmlConfiguration;
     }
 
     public void go() throws Exception {
@@ -91,134 +66,55 @@ protected void startServer() throws Exception {
         server = configureServer();
         server.start();
 
-        Throwable exceptionAtServerStart = server.webAppContext().getUnavailableException();
+        Throwable exceptionAtServerStart = server.getUnavailableException();
         if (exceptionAtServerStart != null) {
             server.stop();
             LOG.error("ERROR: Failed to start Go server.", exceptionAtServerStart);
             throw new RuntimeException("Failed to start Go server.", exceptionAtServerStart);
         }
     }
 
-    JettyServer configureServer() throws Exception {
-        JettyServer server = createServer();
-
-        server.getContainer().addEventListener(mbeans());
-
-        server.addConnector(selectChannelConnector());
-        server.addConnector(sslConnector());
-
-        server.addHandler(welcomeFileHandler());
-        server.addHandler(legacyRequestHandler());
-        WebAppContext webAppContext = webApp();
-        addResourceHandler(server, webAppContext);
-        server.addWebAppHandler(webAppContext);
-        performCustomConfiguration(server);
-
-        server.setStopAtShutdown(true);
+    AppServer configureServer() throws Exception {
+        Constructor<?> constructor = Class.forName(systemEnvironment.get(SystemEnvironment.APP_SERVER)).getConstructor(SystemEnvironment.class, String.class, SSLSocketFactory.class);
+        AppServer server = ((AppServer) constructor.newInstance(systemEnvironment, password, sslSocketFactory));
+        server.configure();
+        server.addExtraJarsToClasspath(getExtraJarsToBeAddedToClasspath());
+        server.setCookieExpirePeriod(twoWeeks());
+        server.setInitParameter("rails.root", "/WEB-INF/rails.new");
+        server.addStopServlet();
         return server;
     }
 
-    private void addResourceHandler(JettyServer server, WebAppContext webAppContext) throws IOException {
-        if (!systemEnvironment.useCompressedJs())
-            return;
-        AssetsContextHandler handler = new AssetsContextHandler(systemEnvironment);
-        server.addHandler(handler);
-        webAppContext.addLifeCycleListener(new AssetsContextHandlerInitializer(handler, webAppContext));
-    }
-
-    JettyServer createServer() {
-        return new JettyServer(new Server());
-    }
-
-    private void performCustomConfiguration(JettyServer server) throws Exception {
-        File jettyConfig = systemEnvironment.getJettyConfigFile();
-        if (jettyConfig.exists()) {
-            LOG.info("Configuring Jetty using " + jettyConfig.getAbsolutePath());
-            FileInputStream serverConfiguration = new FileInputStream(jettyConfig);
-            XmlConfiguration configuration = new XmlConfiguration(serverConfiguration);
-            configuration.configure(server.getServer());
-        } else {
-            String message = String.format(
-                    "No custom jetty configuration (%s) found, using defaults.",
-                    jettyConfig.getAbsolutePath());
-            LOG.info(message);
-        }
-    }
-
-    private MBeanContainer mbeans() {
-        MBeanServer platformMBeanServer = ManagementFactory.getPlatformMBeanServer();
-        MBeanContainer mbeans = new MBeanContainer(platformMBeanServer);
-        mbeans.start();
-        return mbeans;
-    }
-
-    private Connector sslConnector() {
-        return new GoSslSocketConnector(password, systemEnvironment, goCipherSuite).sslConnector();
-    }
-
-    private SelectChannelConnector selectChannelConnector() {
-        SelectChannelConnector connector = new SelectChannelConnector();
-        connector.setPort(systemEnvironment.getServerPort());
-        connector.setHost(systemEnvironment.getListenHost());
-        return connector;
-    }
-
-    WebAppContext webApp() throws IOException, SAXException, ClassNotFoundException, UnavailableException {
-        WebAppContext wac = new WebAppContext();
-        configuration.setWebAppContext(wac);
-        configuration.initialize(getWarFile());
-
-        wac.setConfigurationClasses(new String[]{
-                "org.mortbay.jetty.webapp.WebInfConfiguration",
-                "org.mortbay.jetty.webapp.WebXmlConfiguration",
-                "org.mortbay.jetty.webapp.JettyWebXmlConfiguration",
-        });
-        wac.setContextPath(new SystemEnvironment().getWebappContextPath());
-        wac.setWar(getWarFile());
-        wac.setParentLoaderPriority(new SystemEnvironment().getParentLoaderPriority());
-        setCookieExpireIn2Weeks(wac);
-        addExtraJarsToClasspath(wac);
-        addJRubyContextInitParams(wac);
-        addStopServlet(wac);
-        return wac;
-    }
-
-    private void addJRubyContextInitParams(WebAppContext wac) {
-        Map existingParams = wac.getInitParams();
-        existingParams.put("rails.root", "/WEB-INF/rails.new");
-        wac.setInitParams(existingParams);
+    private int twoWeeks() {
+        return 60 * 60 * 24 * 14;
     }
 
-    private void addExtraJarsToClasspath(WebAppContext wac) {
+    private String getExtraJarsToBeAddedToClasspath() {
         ArrayList<File> extraClassPathFiles = new ArrayList<File>();
         extraClassPathFiles.addAll(getAddonJarFiles());
         String extraClasspath = convertToClasspath(extraClassPathFiles);
         LOG.info("Including addons: " + extraClasspath);
-        wac.setExtraClasspath(extraClasspath);
-    }
-
-    ContextHandler welcomeFileHandler() {
-        return new GoServerWelcomeFileHandler();
-    }
-
-    ContextHandler legacyRequestHandler() {
-        return new LegacyUrlRequestHandler();
+        return extraClasspath;
     }
+    private String convertToClasspath(List<File> addonJars) {
+        if (addonJars.size() == 0) {
+            return "";
+        }
 
-
-    private void setCookieExpireIn2Weeks(WebAppContext wac) {
-        int sixMonths = 60 * 60 * 24 * 14;
-        wac.getSessionHandler().getSessionManager().setMaxCookieAge(sixMonths);
+        StringBuilder addonJarClassPath = new StringBuilder(addonJars.get(0).getPath());
+        for (int i = 1; i < addonJars.size(); i++) {
+            addonJarClassPath.append(",").append(addonJars.get(i));
+        }
+        return addonJarClassPath.toString();
     }
 
-    private void addStopServlet(WebAppContext wac) {
-        ServletHolder holder = new ServletHolder();
-        holder.setServlet(new StopJettyFromLocalhostServlet(this));
-        wac.addServlet(holder, "/jetty/stop");
-    }
+    private List<File> getAddonJarFiles() {
+        File addonsPath = new File(systemEnvironment.get(SystemEnvironment.ADDONS_PATH));
+        if (!addonsPath.exists() || !addonsPath.canRead()) {
+            return new ArrayList<File>();
+        }
 
-    private String getWarFile() {
-        return systemEnvironment.getCruiseWar();
+        return new ArrayList<File>(FileUtils.listFiles(addonsPath, new SuffixFileFilter("jar", IOCase.INSENSITIVE), FalseFileFilter.INSTANCE));
     }
 
     public void stop() throws Exception {
@@ -233,27 +129,6 @@ Validation validate() {
         return validation;
     }
 
-    private List<File> getAddonJarFiles() {
-        File addonsPath = new File(systemEnvironment.get(SystemEnvironment.ADDONS_PATH));
-        if (!addonsPath.exists() || !addonsPath.canRead()) {
-            return new ArrayList<File>();
-        }
-
-        return new ArrayList<File>(FileUtils.listFiles(addonsPath, new SuffixFileFilter("jar", IOCase.INSENSITIVE), FalseFileFilter.INSTANCE));
-    }
-
-    private String convertToClasspath(List<File> addonJars) {
-        if (addonJars.size() == 0) {
-            return "";
-        }
-
-        StringBuilder addonJarClassPath = new StringBuilder(addonJars.get(0).getPath());
-        for (int i = 1; i < addonJars.size(); i++) {
-            addonJarClassPath.append(",").append(addonJars.get(i));
-        }
-        return addonJarClassPath.toString();
-    }
-
     ArrayList<Validator> validators() {
         ArrayList<Validator> validators = new ArrayList<Validator>();
         validators.add(new ServerPortValidator(systemEnvironment.getServerPort()));
@@ -267,54 +142,11 @@ ArrayList<Validator> validators() {
         validators.add(FileValidator.configFile("cruise-config.xml", systemEnvironment));
         validators.add(FileValidator.configFile("config.properties", systemEnvironment));
         validators.add(FileValidator.configFileAlwaysOverwrite("cruise-config.xsd", systemEnvironment));
-        validators.add(FileValidator.configFile("jetty.xml", systemEnvironment));
+		validators.add(FileValidator.configFileAlwaysOverwrite("jetty.xml", systemEnvironment));
+		validators.add(FileValidator.configFileAlwaysOverwrite("jetty6.xml", systemEnvironment));
         validators.add(new JettyWorkDirValidator());
         validators.add(new DatabaseValidator());
         validators.add(new LoggingValidator(systemEnvironment));
         return validators;
     }
-
-    class LegacyUrlRequestHandler extends ContextHandler {
-
-        LegacyUrlRequestHandler() {
-            super(GoConstants.OLD_URL_CONTEXT);
-        }
-
-        public void handle(String target, HttpServletRequest request, HttpServletResponse response, int dispatch) throws IOException, ServletException {
-            if (target.startsWith(GoConstants.OLD_URL_CONTEXT + "/") || target.equals(GoConstants.OLD_URL_CONTEXT)) {
-                if (shouldRedirect(request)) {
-                    response.setHeader("Location", target.replaceFirst(GoConstants.OLD_URL_CONTEXT, GoConstants.GO_URL_CONTEXT));
-                    response.setStatus(HttpStatus.ORDINAL_301_Moved_Permanently);
-                } else {
-                    response.setStatus(HttpStatus.ORDINAL_404_Not_Found);
-                }
-                response.setHeader("Content-Type", "text/plain");
-                PrintWriter writer = response.getWriter();
-                writer.write(String.format("Url(s) starting in '%s' have been permanently moved to '%s', please use the new path.", GoConstants.OLD_URL_CONTEXT, GoConstants.GO_URL_CONTEXT));
-                writer.close();
-            }
-        }
-
-        boolean shouldRedirect(HttpServletRequest request) {
-            String method = request.getMethod();
-            return method.equals(HttpMethods.GET) || method.equals(HttpMethods.HEAD);
-        }
-    }
-
-    class GoServerWelcomeFileHandler extends ContextHandler {
-        GoServerWelcomeFileHandler() {
-            super("/");
-        }
-
-        public void handle(String target, HttpServletRequest request, HttpServletResponse response, int dispatch) throws IOException, ServletException {
-            if (target.equals("/")) {
-                response.setHeader("Location", GoConstants.GO_URL_CONTEXT + "/home");
-                response.setStatus(301);
-                response.setHeader("Content-Type", "text/html");
-                PrintWriter writer = response.getWriter();
-                writer.write("redirecting..");
-                writer.close();
-            }
-        }
-    }
 }

--- server/src/com/thoughtworks/go/server/JettyServer.java (removed) ---
additions: 0, deletions: 71, changes: 71
@@ -1,71 +0,0 @@
-/*************************GO-LICENSE-START*********************************
- * Copyright 2014 ThoughtWorks, Inc.
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *    http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- *************************GO-LICENSE-END***********************************/
-
-package com.thoughtworks.go.server;
-
-import org.mortbay.component.Container;
-import org.mortbay.jetty.Connector;
-import org.mortbay.jetty.Handler;
-import org.mortbay.jetty.Request;
-import org.mortbay.jetty.Server;
-import org.mortbay.jetty.handler.ContextHandler;
-import org.mortbay.jetty.webapp.WebAppContext;
-
-public class JettyServer {
-    private Server server;
-    private WebAppContext webAppContext;
-
-    public JettyServer(Server server) {
-        this.server = server;
-    }
-
-    public Container getContainer() {
-        return server.getContainer();
-    }
-
-    public void addConnector(Connector selectChannelConnector) {
-        server.addConnector(selectChannelConnector);
-    }
-
-    public void addHandler(Handler handler) {
-        server.addHandler(handler);
-    }
-
-    public Server getServer() {
-        return server;
-    }
-
-    public void setStopAtShutdown(boolean stopAtShutdown) {
-        server.setStopAtShutdown(stopAtShutdown);
-    }
-
-    public void start() throws Exception {
-        server.start();
-    }
-
-    public void stop() throws Exception {
-        server.stop();
-    }
-
-    public void addWebAppHandler(WebAppContext webAppContext) {
-        addHandler(webAppContext);
-        this.webAppContext = webAppContext;
-    }
-
-    public WebAppContext webAppContext() {
-        return webAppContext;
-    }
-}

--- server/src/com/thoughtworks/go/server/initializers/ApplicationInitializer.java (modified) ---
additions: 3, deletions: 1, changes: 4
@@ -32,8 +32,10 @@
 import com.thoughtworks.go.server.service.*;
 import com.thoughtworks.go.server.service.support.toggle.FeatureToggleService;
 import com.thoughtworks.go.server.service.support.toggle.Toggles;
+import com.thoughtworks.go.server.util.ServletHelper;
 import com.thoughtworks.go.service.ConfigRepository;
 import com.thoughtworks.go.plugin.infra.monitor.DefaultPluginJarLocationMonitor;
+import com.thoughtworks.go.util.SystemEnvironment;
 import com.thoughtworks.studios.shine.cruise.stage.details.StageResourceImporter;
 import org.springframework.beans.factory.annotation.Autowired;
 import org.springframework.context.ApplicationContext;
@@ -123,7 +125,7 @@ public void onApplicationEvent(ContextRefreshedEvent contextRefreshedEvent) {
             backupService.initialize();
             railsAssetsService.initialize();
             ccTrayActivityListener.initialize();
-
+            ServletHelper.init(new SystemEnvironment().usingJetty9());
             // initialize static accessors
             Toggles.initializeWith(featureToggleService);
         } catch (Throwable throwable) {

--- server/src/com/thoughtworks/go/server/security/PerformanceLoggingFilter.java (modified) ---
additions: 13, deletions: 5, changes: 18
@@ -17,23 +17,28 @@
 package com.thoughtworks.go.server.security;
 
 import com.thoughtworks.go.server.perf.WebRequestPerformanceLogger;
+import com.thoughtworks.go.server.util.*;
 import com.thoughtworks.go.util.SystemEnvironment;
 import org.apache.commons.logging.Log;
 import org.apache.commons.logging.LogFactory;
-import org.mortbay.jetty.Response;
 
 import javax.servlet.*;
+import javax.servlet.ServletRequest;
+import javax.servlet.ServletResponse;
 import javax.servlet.http.HttpServletRequest;
 import java.io.IOException;
 
 public class PerformanceLoggingFilter implements Filter {
     private static final Log LOGGER = LogFactory.getLog(PerformanceLoggingFilter.class);
+    private final boolean usingJetty9;
     private boolean logRequestTimings;
     private WebRequestPerformanceLogger webRequestPerformanceLogger;
 
     public PerformanceLoggingFilter(WebRequestPerformanceLogger webRequestPerformanceLogger) {
         this.webRequestPerformanceLogger = webRequestPerformanceLogger;
-        logRequestTimings = new SystemEnvironment().getEnableRequestTimeLogging();
+        SystemEnvironment systemEnvironment = new SystemEnvironment();
+        logRequestTimings = systemEnvironment.getEnableRequestTimeLogging();
+        usingJetty9 = systemEnvironment.usingJetty9();
     }
 
     public void init(FilterConfig filterConfig) throws ServletException {
@@ -48,15 +53,18 @@ public void doFilter(ServletRequest servletRequest, ServletResponse servletRespo
                 long amountOfTimeItTookInMilliseconds = System.currentTimeMillis() - start;
                 String requestURI = ((HttpServletRequest) servletRequest).getRequestURI();
                 String requestor = servletRequest.getRemoteAddr();
-                int status = ((Response) servletResponse).getStatus();
-                long contentCount = ((Response) servletResponse).getContentCount();
+
+                com.thoughtworks.go.server.util.ServletResponse response = ServletHelper.getInstance().getResponse(servletResponse);
+                int status = response.getStatus();
+                long contentCount = response.getContentCount();
 
                 webRequestPerformanceLogger.logRequest(requestURI, requestor, status, contentCount, amountOfTimeItTookInMilliseconds);
                 LOGGER.warn(requestURI + " took: " + amountOfTimeItTookInMilliseconds + " ms");
             }
         }
     }
 
+
     public void destroy() {
     }
-}
+}
\ No newline at end of file

--- server/src/com/thoughtworks/go/server/web/DeploymentContextWriter.java (modified) ---
additions: 7, deletions: 8, changes: 15
@@ -16,15 +16,15 @@
 
 package com.thoughtworks.go.server.web;
 
-import java.net.URISyntaxException;
-import javax.servlet.http.HttpServletRequest;
-
+import com.thoughtworks.go.server.util.ServletHelper;
+import com.thoughtworks.go.server.util.ServletRequest;
 import com.thoughtworks.go.util.SystemEnvironment;
-import org.mortbay.jetty.HttpURI;
-import org.mortbay.jetty.Request;
 import org.springframework.web.context.WebApplicationContext;
 import org.springframework.web.context.support.WebApplicationContextUtils;
 
+import javax.servlet.http.HttpServletRequest;
+import java.net.URISyntaxException;
+
 /**
  * @understands sets https port the server is deployed on, in request attributes
  */
@@ -43,9 +43,8 @@ public void writeSecureSiteUrl(HttpServletRequest req) throws URISyntaxException
         if (provider == null) {
             throw new RuntimeException("Could not generate url. ServerConfigService not yet loaded.");
         }
-        Request request = (Request) req;
-        HttpURI uri = request.getUri();
-        String url = request.getRootURL().append(uri.toString()).toString();
+        ServletRequest request = ServletHelper.getInstance().getRequest(req);
+        String url = request.getUrl();
         if (provider.hasAnyUrlConfigured()) {
             try {
                 String newUrl = provider.siteUrlFor(url, true);

--- server/src/com/thoughtworks/go/server/web/RedirectDuringBackup.java (modified) ---
additions: 17, deletions: 13, changes: 30
@@ -16,12 +16,12 @@
 
 package com.thoughtworks.go.server.web;
 
-import javax.servlet.http.HttpServletRequest;
-
-import org.mortbay.jetty.Request;
-import org.mortbay.util.UrlEncoded;
+import com.thoughtworks.go.server.util.ServletHelper;
+import com.thoughtworks.go.server.util.ServletRequest;
 import org.springframework.web.context.support.WebApplicationContextUtils;
 
+import javax.servlet.http.HttpServletRequest;
+
 /**
  * @understands redirecting all requests to a service unavailable page when the server is being backed up.
  */
@@ -31,33 +31,37 @@ public class RedirectDuringBackup {
     private static final String REFERER = "Referer";
 
     public void setServerBackupFlag(HttpServletRequest req) {
+        ServletHelper servletHelper = ServletHelper.getInstance();
         BackupStatusProvider backupStatusProvider = getBackupStatusProvider(req);
         boolean backingUp = backupStatusProvider.isBackingUp();
         req.setAttribute(BACKUP_IN_PROGRESS, String.valueOf(backingUp));
+
         if (backingUp) {
-            req.setAttribute("redirected_from", UrlEncoded.encodeString(getRedirectUri((Request) req)));
-            req.setAttribute("backup_started_at", UrlEncoded.encodeString(backupStatusProvider.backupRunningSinceISO8601()));
-            req.setAttribute("backup_started_by", UrlEncoded.encodeString(backupStatusProvider.backupStartedBy()));
+            req.setAttribute("redirected_from", servletHelper.encodeString(getRedirectUri(req, servletHelper)));
+            req.setAttribute("backup_started_at", servletHelper.encodeString(backupStatusProvider.backupRunningSinceISO8601()));
+            req.setAttribute("backup_started_by", servletHelper.encodeString(backupStatusProvider.backupStartedBy()));
         }
     }
 
-    private String getRedirectUri(Request req) {
-        if (isMessagesJson(req) || isMethod(req, "post") || isMethod(req, "put") || isMethod(req, "delete")) {
+    private String getRedirectUri(HttpServletRequest req, ServletHelper servletHelper) {
+        ServletRequest request = servletHelper.getRequest(req);
+
+        if (isMessagesJson(request) || isMethod(req, "post") || isMethod(req, "put") || isMethod(req, "delete")) {
             return getReferer(req);
         }
-        return req.getUri().toString();
+        return request.getUriAsString();
     }
 
-    private boolean isMessagesJson(Request req) {
-        return req.getUri().getPath().equals("/go/server/messages.json");
+    private boolean isMessagesJson(ServletRequest req) {
+        return req.getUriPath().equals("/go/server/messages.json");
     }
 
     private String getReferer(HttpServletRequest req) {
         String referer = req.getHeader(REFERER);
         return referer == null? "" : referer;
     }
 
-    private boolean isMethod(Request req, String method) {
+    private boolean isMethod(HttpServletRequest req, String method) {
         return req.getMethod().equalsIgnoreCase(method);
     }
 

--- server/test/common/com/thoughtworks/go/helpers/Localhost.java (modified) ---
additions: 21, deletions: 26, changes: 47
@@ -16,31 +16,26 @@
 
 package com.thoughtworks.go.helpers;
 
-import java.io.File;
-import java.io.IOException;
-import java.sql.SQLException;
-import java.util.Arrays;
-import java.util.List;
-import javax.sql.DataSource;
-
-import com.thoughtworks.go.domain.JobIdentifier;
-import com.thoughtworks.go.domain.JobInstance;
-import com.thoughtworks.go.domain.JobResult;
-import com.thoughtworks.go.domain.Pipeline;
-import com.thoughtworks.go.domain.Stage;
+import com.thoughtworks.go.domain.*;
 import com.thoughtworks.go.domain.exception.IllegalArtifactLocationException;
 import com.thoughtworks.go.helper.JobInstanceMother;
-import com.thoughtworks.go.server.dao.DatabaseAccessHelper;
-import com.thoughtworks.go.server.dao.JobInstanceDao;
-import com.thoughtworks.go.server.dao.PipelineDao;
-import com.thoughtworks.go.server.dao.PipelineSqlMapDao;
-import com.thoughtworks.go.server.dao.StageSqlMapDao;
+import com.thoughtworks.go.server.dao.*;
 import com.thoughtworks.go.util.SystemEnvironment;
 import org.apache.commons.io.FileUtils;
-import org.mortbay.jetty.Server;
-import org.mortbay.jetty.webapp.WebAppContext;
+import org.eclipse.jetty.server.Server;
+import org.eclipse.jetty.webapp.JettyWebXmlConfiguration;
+import org.eclipse.jetty.webapp.WebAppContext;
+import org.eclipse.jetty.webapp.WebInfConfiguration;
+import org.eclipse.jetty.webapp.WebXmlConfiguration;
 import org.springframework.context.support.ClassPathXmlApplicationContext;
 
+import javax.sql.DataSource;
+import java.io.File;
+import java.io.IOException;
+import java.sql.SQLException;
+import java.util.Arrays;
+import java.util.List;
+
 import static com.thoughtworks.go.helper.JobInstanceMother.completed;
 import static com.thoughtworks.go.helper.PipelineMother.completedPipelineWithStagesAndBuilds;
 
@@ -74,20 +69,20 @@ public class Localhost {
         server = new Server(port);
         WebAppContext context = new WebAppContext("webapp", "/go");
 
-        context.setConfigurationClasses(new String[]{
-                "org.mortbay.jetty.webapp.WebInfConfiguration",
-                "org.mortbay.jetty.webapp.WebXmlConfiguration",
-                "org.mortbay.jetty.webapp.JettyWebXmlConfiguration",
-        });
+		context.setConfigurationClasses(new String[]{
+				WebInfConfiguration.class.getCanonicalName(),
+				WebXmlConfiguration.class.getCanonicalName(),
+				JettyWebXmlConfiguration.class.getCanonicalName()
+		});
 
         context.setDefaultsDescriptor("webapp/WEB-INF/webdefault.xml");
-        server.addHandler(context);
+        server.setHandler(context);
         this.setCookieExpireIn6Months(context);
     }
 
     private void setCookieExpireIn6Months(WebAppContext wac) {
         int sixMonths = 60 * 60 * 24 * 180;
-        wac.getSessionHandler().getSessionManager().setMaxCookieAge(sixMonths);
+		wac.getSessionHandler().getSessionManager().getSessionCookieConfig().setMaxAge(sixMonths);
     }
 
     public static void main(String[] args) throws Exception {

--- server/test/integration/com/thoughtworks/go/server/web/UrlRewriterIntegrationTest.java (modified) ---
additions: 9, deletions: 5, changes: 14
@@ -19,6 +19,7 @@
 import com.thoughtworks.go.domain.ServerSiteUrlConfig;
 import com.thoughtworks.go.server.GoServer;
 import com.thoughtworks.go.server.util.HttpTestUtil;
+import com.thoughtworks.go.server.util.ServletHelper;
 import com.thoughtworks.go.util.SystemEnvironment;
 import org.apache.commons.httpclient.Header;
 import org.apache.commons.httpclient.HttpClient;
@@ -29,23 +30,25 @@
 import org.apache.commons.httpclient.params.HttpClientParams;
 import org.apache.commons.httpclient.protocol.Protocol;
 import org.apache.commons.httpclient.protocol.ProtocolSocketFactory;
+import org.eclipse.jetty.util.UrlEncoded;
+import org.eclipse.jetty.util.resource.Resource;
+import org.eclipse.jetty.webapp.WebAppContext;
 import org.joda.time.DateTime;
 import org.junit.After;
 import org.junit.Before;
 import org.junit.experimental.theories.DataPoint;
 import org.junit.experimental.theories.Theories;
 import org.junit.experimental.theories.Theory;
 import org.junit.runner.RunWith;
-import org.mortbay.jetty.servlet.Context;
-import org.mortbay.resource.Resource;
-import org.mortbay.util.UrlEncoded;
 import org.springframework.web.context.WebApplicationContext;
 import org.tuckey.web.filters.urlrewrite.UrlRewriteFilter;
 
+import javax.servlet.DispatcherType;
 import java.io.File;
 import java.io.IOException;
 import java.net.URISyntaxException;
 import java.net.URL;
+import java.util.EnumSet;
 import java.util.HashMap;
 import java.util.Map;
 
@@ -68,8 +71,9 @@ public class UrlRewriterIntegrationTest {
     public String originalSslPort;
 
     public UrlRewriterIntegrationTest() throws Exception {
+        ServletHelper.init(true);
         httpUtil = new HttpTestUtil(new HttpTestUtil.ContextCustomizer() {
-            public void customize(Context ctx) throws Exception {
+            public void customize(WebAppContext ctx) throws Exception {
                 wac = mock(WebApplicationContext.class);
                 ctx.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, wac);
 
@@ -79,7 +83,7 @@ public void customize(Context ctx) throws Exception {
                 }
 
                 ctx.setBaseResource(Resource.newResource(new File(resource.getFile()).getParent()));
-                ctx.addFilter(UrlRewriteFilter.class, "/*", 1).setInitParameter("confPath", "/urlrewrite.xml");
+				ctx.addFilter(UrlRewriteFilter.class, "/*", EnumSet.of(DispatcherType.REQUEST)).setInitParameter("confPath", "/urlrewrite.xml");
                 ctx.addServlet(HttpTestUtil.EchoServlet.class, "/*");
             }
         });

--- server/test/unit/com/thoughtworks/go/server/AppServerStub.java (added) ---
additions: 58, deletions: 0, changes: 58
@@ -0,0 +1,58 @@
+package com.thoughtworks.go.server;
+
+import com.thoughtworks.go.util.SystemEnvironment;
+
+import javax.net.ssl.SSLSocketFactory;
+import java.util.HashMap;
+
+public class AppServerStub extends AppServer {
+
+    public HashMap<String, Object> calls = new HashMap<String, Object>();
+    public HashMap<String, String> initparams = new HashMap<String, String>();
+
+    public AppServerStub(SystemEnvironment systemEnvironment, String password, SSLSocketFactory sslSocketFactory) {
+        super(systemEnvironment, password, sslSocketFactory);
+    }
+
+    @Override
+    void addExtraJarsToClasspath(String extraClasspath) {
+        calls.put("addExtraJarsToClasspath", extraClasspath);
+    }
+
+    @Override
+    void setCookieExpirePeriod(int cookieExpirePeriod) {
+        calls.put("setCookieExpirePeriod", cookieExpirePeriod);
+    }
+
+    @Override
+    void setInitParameter(String name, String value) {
+        initparams.put(name, value);
+    }
+
+    @Override
+    void addStopServlet() {
+        calls.put("addStopServlet", true);
+    }
+
+    @Override
+    Throwable getUnavailableException() {
+        calls.put("getUnavailableException", true);
+        return null;
+    }
+
+    @Override
+    void configure() throws Exception {
+        calls.put("configure", true);
+    }
+
+    @Override
+    void start() throws Exception {
+        calls.put("start", true);
+    }
+
+    @Override
+    void stop() throws Exception {
+        calls.put("stop", true);
+
+    }
+}

--- server/test/unit/com/thoughtworks/go/server/GoServerContextHandlersTest.java (removed) ---
additions: 0, deletions: 335, changes: 335
@@ -1,335 +0,0 @@
-/*************************GO-LICENSE-START*********************************
- * Copyright 2014 ThoughtWorks, Inc.
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *    http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- *************************GO-LICENSE-END***********************************/
-
-package com.thoughtworks.go.server;
-
-import com.thoughtworks.go.helpers.FileSystemUtils;
-import com.thoughtworks.go.server.util.GoCipherSuite;
-import com.thoughtworks.go.util.SystemEnvironment;
-import com.thoughtworks.go.util.validators.Validation;
-import org.apache.commons.io.FileUtils;
-import org.junit.After;
-import org.junit.Before;
-import org.junit.Test;
-import org.junit.experimental.theories.DataPoint;
-import org.junit.experimental.theories.Theories;
-import org.junit.experimental.theories.Theory;
-import org.junit.runner.RunWith;
-import org.mockito.InOrder;
-import org.mortbay.component.Container;
-import org.mortbay.jetty.*;
-import org.mortbay.jetty.handler.ContextHandler;
-import org.mortbay.jetty.webapp.WebAppContext;
-import org.xml.sax.SAXException;
-
-import javax.net.ssl.SSLSocketFactory;
-import javax.servlet.ServletException;
-import javax.servlet.UnavailableException;
-import javax.servlet.http.HttpServletRequest;
-import javax.servlet.http.HttpServletResponse;
-import java.io.ByteArrayOutputStream;
-import java.io.File;
-import java.io.IOException;
-import java.io.PrintWriter;
-import java.util.Arrays;
-import java.util.List;
-
-import static org.hamcrest.CoreMatchers.is;
-import static org.hamcrest.CoreMatchers.sameInstance;
-import static org.junit.Assert.*;
-import static org.mockito.Mockito.*;
-
-@RunWith(Theories.class)
-public class GoServerContextHandlersTest {
-    private SSLSocketFactory sslSocketFactory;
-    private File addonDir = new File("test-addons");
-
-    @Before
-    public void setUp() throws Exception {
-        sslSocketFactory = mock(SSLSocketFactory.class);
-        when(sslSocketFactory.getSupportedCipherSuites()).thenReturn(new String[0]);
-
-        addonDir.mkdirs();
-    }
-
-    @After
-    public void tearDown() throws Exception {
-        FileUtils.deleteDirectory(addonDir);
-    }
-
-    @Test
-    public void shouldRegisterAllHandlers() throws Exception {
-        final JettyServer server = mock(JettyServer.class);
-        when(server.getContainer()).thenReturn(new Container());
-        when(server.getServer()).thenReturn(mock(Server.class));
-        SystemEnvironment environment = spy(new SystemEnvironment());
-        final WebAppContext mainWebapp = mock(WebAppContext.class);
-        final GoServer.GoServerWelcomeFileHandler welcomeHandler = mock(GoServer.GoServerWelcomeFileHandler.class);
-        final GoServer.LegacyUrlRequestHandler legacyRequestHandler = mock(GoServer.LegacyUrlRequestHandler.class);
-
-        GoServer goServer = new GoServer(environment, new GoCipherSuite(sslSocketFactory), null) {
-            @Override JettyServer createServer() {
-                return server;
-            }
-
-            @Override WebAppContext webApp() throws IOException, SAXException, ClassNotFoundException, UnavailableException {
-                return mainWebapp;
-            }
-
-            @Override ContextHandler welcomeFileHandler() {
-                return welcomeHandler;
-            }
-
-            @Override public ContextHandler legacyRequestHandler() {
-                return legacyRequestHandler;
-            }
-
-            @Override
-            Validation validate() {
-                return Validation.SUCCESS;
-            }
-        };
-        assertThat(goServer.configureServer(), sameInstance(server));
-        verify(server).addHandler(welcomeHandler);
-        verify(server).addHandler(legacyRequestHandler);
-        verify(server).addWebAppHandler(mainWebapp);
-    }
-
-    @Test
-    public void shouldStopServerAndThrowExceptionWhenServerFailsToStartWithAnUnhandledException() throws Exception {
-        final JettyServer server = mock(JettyServer.class);
-        final WebAppContext webAppContext = mock(WebAppContext.class);
-
-        when(server.getContainer()).thenReturn(new Container());
-        when(server.getServer()).thenReturn(mock(Server.class));
-
-        GoServer goServer = new GoServer() {
-            @Override
-            WebAppContext webApp() throws IOException, SAXException, ClassNotFoundException, UnavailableException {
-                return webAppContext;
-            }
-
-            @Override
-            JettyServer createServer() {
-                return server;
-            }
-        };
-
-        doNothing().when(server).start();
-        doNothing().when(server).stop();
-        doReturn(webAppContext).when(server).webAppContext();
-        when(webAppContext.getUnavailableException()).thenReturn(new RuntimeException("Some unhandled server startup exception"));
-
-        try {
-            goServer.startServer();
-            fail("Should have thrown an exception");
-        } catch (RuntimeException e) {
-            assertThat(e.getMessage(), is("Failed to start Go server."));
-            assertThat(e.getCause().getMessage(), is("Some unhandled server startup exception"));
-        }
-
-        InOrder inOrder = inOrder(server, webAppContext);
-        inOrder.verify(server).start();
-        inOrder.verify(webAppContext).getUnavailableException();
-        inOrder.verify(server).stop();
-    }
-
-    @Test
-    public void shouldRedirectRootRequestsToWelcomePage() throws IOException, ServletException {
-        GoServer goServer = new GoServer(new SystemEnvironment(), new GoCipherSuite(sslSocketFactory), mock(GoWebXmlConfiguration.class));
-        Handler welcomeHandler = goServer.welcomeFileHandler();
-        HttpServletResponse response = mock(HttpServletResponse.class);
-
-        ByteArrayOutputStream output = new ByteArrayOutputStream();
-        when(response.getWriter()).thenReturn(new PrintWriter(output));
-        welcomeHandler.handle("/", mock(HttpServletRequest.class), response, Handler.REQUEST);
-
-        String responseBody = new String(output.toByteArray());
-        assertThat(responseBody, is("redirecting.."));
-
-        verify(response).setHeader("Location", "/go/home");
-        verify(response).setStatus(HttpStatus.ORDINAL_301_Moved_Permanently);
-        verify(response).setHeader(HttpHeaders.CONTENT_TYPE, "text/html");
-        verify(response).getWriter();
-        verifyNoMoreInteractions(response);
-    }
-
-    @Test
-    public void shouldMatchRootUrlAsHandlerContextForWelcomePage() {
-        GoServer goServer = new GoServer(new SystemEnvironment(), new GoCipherSuite(sslSocketFactory), mock(GoWebXmlConfiguration.class));
-        ContextHandler handler = goServer.welcomeFileHandler();
-        assertThat(handler.getContextPath(), is("/"));
-    }
-    
-    @Test
-    public void shouldMatchCruiseUrlContextAsHandlerContextForLegacyRequestHandler() {
-        GoServer goServer = new GoServer(new SystemEnvironment(), new GoCipherSuite(sslSocketFactory), mock(GoWebXmlConfiguration.class));
-        ContextHandler handler = goServer.legacyRequestHandler();
-        assertThat(handler.getContextPath(), is("/cruise"));
-    }
-
-    @Test
-    public void shouldNotRedirectNonRootRequestsToWelcomePage() throws IOException, ServletException {
-        GoServer goServer = new GoServer(new SystemEnvironment(), new GoCipherSuite(sslSocketFactory), mock(GoWebXmlConfiguration.class));
-        Handler welcomeHandler = goServer.welcomeFileHandler();
-        HttpServletResponse response = mock(HttpServletResponse.class);
-
-        welcomeHandler.handle("/foo", mock(HttpServletRequest.class), response, Handler.REQUEST);
-        verifyNoMoreInteractions(response);
-    }
-
-    @Test
-    public void shouldNotRedirectNonCruiseRequestsToGoPage() throws IOException, ServletException {
-        GoServer goServer = new GoServer(new SystemEnvironment(), new GoCipherSuite(sslSocketFactory), mock(GoWebXmlConfiguration.class));
-        Handler legacyRequestHandler = goServer.legacyRequestHandler();
-        HttpServletResponse response = mock(HttpServletResponse.class);
-
-        when(response.getWriter()).thenReturn(new PrintWriter(new ByteArrayOutputStream()));
-
-        HttpServletRequest req = mock(HttpServletRequest.class);
-        when(req.getMethod()).thenReturn(HttpMethods.GET);
-        legacyRequestHandler.handle("/cruise_but_not_quite", req, response, Handler.REQUEST);
-        verifyNoMoreInteractions(response);
-        legacyRequestHandler.handle("/something_totally_different", req, response, Handler.REQUEST);
-        verifyNoMoreInteractions(response);
-    }
-
-
-    @Test
-    public void shouldLoadAllJarsInTheAddonsDirectoryIntoClassPath() throws Exception {
-        File addonsDirectory = createInAddonDir("some-addon-dir");
-        FileSystemUtils.createFile("addon-1.JAR", addonsDirectory);
-        FileSystemUtils.createFile("addon-2.jar", addonsDirectory);
-        FileSystemUtils.createFile("addon-3.jAR", addonsDirectory);
-        FileSystemUtils.createFile("some-file-which-does-not-end-with-dot-jar.txt", addonsDirectory);
-
-        File oneAddonDirectory = createInAddonDir("one-addon-dir");
-        FileSystemUtils.createFile("addon-1.jar", oneAddonDirectory);
-
-        File noAddonDirectory = createInAddonDir("no-addon-dir");
-
-        GoServer goServerWithMultipleAddons = new GoServer(setJRubyJarsTo(setAddonsPathTo(addonsDirectory)), new GoCipherSuite(sslSocketFactory), mock(GoWebXmlConfiguration.class));
-        assertExtraClasspath(goServerWithMultipleAddons.webApp(), "test-addons/some-addon-dir/addon-1.JAR", "test-addons/some-addon-dir/addon-2.jar", "test-addons/some-addon-dir/addon-3.jAR");
-
-        GoServer goServerWithOneAddon = new GoServer(setJRubyJarsTo(setAddonsPathTo(oneAddonDirectory)), new GoCipherSuite(sslSocketFactory), mock(GoWebXmlConfiguration.class));
-        assertExtraClasspath(goServerWithOneAddon.webApp(), "test-addons/one-addon-dir/addon-1.jar");
-
-        GoServer goServerWithNoAddon = new GoServer(setJRubyJarsTo(setAddonsPathTo(noAddonDirectory)), new GoCipherSuite(sslSocketFactory), mock(GoWebXmlConfiguration.class));
-        assertThat(goServerWithNoAddon.webApp().getExtraClasspath(), is(""));
-
-        GoServer goServerWithInaccessibleAddonDir = new GoServer(setJRubyJarsTo(setAddonsPathTo(new File("non-existent-directory"))), new GoCipherSuite(sslSocketFactory), mock(GoWebXmlConfiguration.class));
-        assertThat(goServerWithInaccessibleAddonDir.webApp().getExtraClasspath(), is(""));
-    }
-
-    @Test
-    public void shouldToggleRailsToOldOneWhenTheNewOneIsSpecified() throws Exception {
-        SystemEnvironment systemEnvironment = mock(SystemEnvironment.class);
-        when(systemEnvironment.get(SystemEnvironment.ADDONS_PATH)).thenReturn("some-non-existent-directory");
-        GoServer goServer = new GoServer(systemEnvironment, new GoCipherSuite(sslSocketFactory), mock(GoWebXmlConfiguration.class));
-
-        WebAppContext webApp = goServer.webApp();
-
-        assertThat(webApp.getInitParameter("rails.root"), is("/WEB-INF/rails.new"));
-    }
-
-    private void assertExtraClasspath(WebAppContext context, String... expectedClassPathJars) {
-        List<String> actualExtraClassPath = Arrays.asList(context.getExtraClasspath().split(","));
-
-        assertEquals("Number of jars wrong. Expected: " + Arrays.asList(expectedClassPathJars) + ". Actual: " + actualExtraClassPath, expectedClassPathJars.length, actualExtraClassPath.size());
-        for (String expectedClassPathJar : expectedClassPathJars) {
-            String platformIndependantNameOfExpectedJar = expectedClassPathJar.replace("/", File.separator);
-            assertTrue("Expected " + context.getExtraClasspath() + " to contain: " + platformIndependantNameOfExpectedJar, actualExtraClassPath.contains(platformIndependantNameOfExpectedJar));
-        }
-    }
-
-    private File createInAddonDir(String dirInsideAddonDir) {
-        File dirWhichWillContainAddons = new File(addonDir, dirInsideAddonDir);
-        dirWhichWillContainAddons.mkdirs();
-        return dirWhichWillContainAddons;
-    }
-
-    private SystemEnvironment setAddonsPathTo(File path) {
-        SystemEnvironment systemEnvironment = mock(SystemEnvironment.class);
-        doReturn(path.getPath()).when(systemEnvironment).get(SystemEnvironment.ADDONS_PATH);
-        return systemEnvironment;
-    }
-
-    static class HttpCall {
-        final String url;
-        final String method;
-        final int expectedResponse;
-        final boolean shouldRedirect;
-
-        HttpCall(String url, String method, int expectedResponse, boolean shouldRedirect) {
-            this.url = url;
-            this.method = method;
-            this.expectedResponse = expectedResponse;
-            this.shouldRedirect = shouldRedirect;
-        }
-
-        @Override public String toString() {
-            return "HttpCall{" +
-                    "url='" + url + '\'' +
-                    ", method='" + method + '\'' +
-                    ", expectedResponse=" + expectedResponse +
-                    ", shouldRedirect=" + shouldRedirect +
-                    '}';
-        }
-    }
-
-    @DataPoint public static final HttpCall GET_CALL_TO_CRUISE = new HttpCall("/foo/bar?baz=quux", HttpMethods.GET, HttpStatus.ORDINAL_301_Moved_Permanently, true);
-    @DataPoint public static final HttpCall GET_CALL_TO_CRUISE_WITH_NO_SUBPATH = new HttpCall("", HttpMethods.GET, HttpStatus.ORDINAL_301_Moved_Permanently, true);
-    @DataPoint public static final HttpCall HEAD_CALL_TO_CRUISE = new HttpCall("/foo/bar?baz=quux", HttpMethods.HEAD, HttpStatus.ORDINAL_301_Moved_Permanently, true);
-    @DataPoint public static final HttpCall HEAD_CALL_TO_CRUISE_WITH_NO_SUBPATH = new HttpCall("", HttpMethods.HEAD, HttpStatus.ORDINAL_301_Moved_Permanently, true);
-
-    @DataPoint public static final HttpCall PUT_CALL_TO_CRUISE = new HttpCall("/foo/bar?baz=quux", HttpMethods.PUT, HttpStatus.ORDINAL_404_Not_Found, false);
-    @DataPoint public static final HttpCall POST_CALL_TO_CRUISE = new HttpCall("/foo/bar?baz=quux", HttpMethods.POST, HttpStatus.ORDINAL_404_Not_Found, false);
-    @DataPoint public static final HttpCall DELETE_CALL_TO_CRUISE = new HttpCall("/foo/bar?baz=quux", HttpMethods.DELETE, HttpStatus.ORDINAL_404_Not_Found, false);
-    @DataPoint public static final HttpCall OPTIONS_CALL_TO_CRUISE = new HttpCall("/foo/bar?baz=quux", HttpMethods.OPTIONS, HttpStatus.ORDINAL_404_Not_Found, false);
-    @DataPoint public static final HttpCall TRACE_CALL_TO_CRUISE = new HttpCall("/foo/bar?baz=quux", HttpMethods.TRACE, HttpStatus.ORDINAL_404_Not_Found, false);
-    @DataPoint public static final HttpCall CONNECT_CALL_TO_CRUISE = new HttpCall("/foo/bar?baz=quux", HttpMethods.CONNECT, HttpStatus.ORDINAL_404_Not_Found, false);
-    @DataPoint public static final HttpCall MOVE_CALL_TO_CRUISE = new HttpCall("/foo/bar?baz=quux", HttpMethods.MOVE, HttpStatus.ORDINAL_404_Not_Found, false);
-
-    @Theory
-    public void shouldRedirectCruiseContextTargetedRequestsToCorrespondingGoUrl(HttpCall httpCall) throws IOException, ServletException {
-        GoServer goServer = new GoServer(new SystemEnvironment(), new GoCipherSuite(sslSocketFactory), mock(GoWebXmlConfiguration.class));
-        Handler legacyHandler = goServer.legacyRequestHandler();
-        HttpServletResponse response = mock(HttpServletResponse.class);
-
-        ByteArrayOutputStream output = new ByteArrayOutputStream();
-        when(response.getWriter()).thenReturn(new PrintWriter(output));
-        HttpServletRequest request = mock(HttpServletRequest.class);
-        when(request.getMethod()).thenReturn(httpCall.method);
-        legacyHandler.handle("/cruise" + httpCall.url, request, response, Handler.REQUEST);
-
-        String responseBody = new String(output.toByteArray());
-        assertThat(responseBody, is("Url(s) starting in '/cruise' have been permanently moved to '/go', please use the new path."));
-
-        verify(response).setStatus(httpCall.expectedResponse);
-
-        if (httpCall.shouldRedirect) {
-            verify(response).setHeader("Location", "/go" + httpCall.url);
-        }
-
-        verify(response).setHeader(HttpHeaders.CONTENT_TYPE, "text/plain");
-        verify(response).getWriter();
-        verifyNoMoreInteractions(response);
-    }
-
-    private SystemEnvironment setJRubyJarsTo(SystemEnvironment mockSystemEnvironment) {
-        return mockSystemEnvironment;
-    }
-}

--- server/test/unit/com/thoughtworks/go/server/GoServerTest.java (modified) ---
additions: 132, deletions: 7, changes: 139
@@ -16,29 +16,40 @@
 
 package com.thoughtworks.go.server;
 
-import java.io.File;
-
+import com.thoughtworks.go.helpers.FileSystemUtils;
 import com.thoughtworks.go.util.ClassMockery;
 import com.thoughtworks.go.util.SubprocessLogger;
 import com.thoughtworks.go.util.SystemEnvironment;
 import com.thoughtworks.go.util.TestFileUtil;
 import com.thoughtworks.go.util.validators.Validation;
+import org.hamcrest.CoreMatchers;
 import org.jmock.Expectations;
 import org.jmock.Mockery;
+import org.junit.Before;
 import org.junit.Test;
 import org.junit.runner.RunWith;
 
+import javax.net.ssl.SSLSocketFactory;
+import java.io.File;
+import java.util.Arrays;
+import java.util.List;
+
 import static org.hamcrest.CoreMatchers.is;
 import static org.hamcrest.core.IsNot.not;
 import static org.hamcrest.core.IsNull.nullValue;
-import static org.junit.Assert.assertThat;
-import static org.mockito.Mockito.mock;
-import static org.mockito.Mockito.verify;
-import static org.mockito.Mockito.when;
+import static org.junit.Assert.*;
+import static org.mockito.Mockito.*;
 
 @RunWith(org.jmock.integration.junit4.JMock.class)
 public class GoServerTest {
     Mockery context = new ClassMockery();
+    private SystemEnvironment systemEnvironment;
+
+    @Before
+    public void setUp() throws Exception {
+        systemEnvironment = new SystemEnvironment();
+        systemEnvironment.set(SystemEnvironment.APP_SERVER, AppServerStub.class.getCanonicalName());
+    }
 
     @Test
     public void shouldValidateOnServerStartup() throws Exception {
@@ -94,12 +105,126 @@ public void shouldNotStartServerIfValidationFails() throws Exception {
         assertThat(goServer.wasStarted(), is(false));
     }
 
+    @Test
+    public void shouldStartAppServer() throws Exception {
+        SystemEnvironment systemEnvironment = new SystemEnvironment();
+        systemEnvironment.set(SystemEnvironment.APP_SERVER, AppServerStub.class.getCanonicalName());
+        GoServer goServer = new GoServer();
+
+        goServer.startServer();
+        AppServer appServer = (AppServer) com.thoughtworks.go.util.ReflectionUtil.getField(goServer, "server");
+        assertThat(appServer instanceof AppServerStub, is(true));
+        AppServerStub appServerStub = (AppServerStub) appServer;
+
+        assertThat((String) appServerStub.calls.get("addExtraJarsToClasspath"), is(""));
+        assertThat((Integer) appServerStub.calls.get("setCookieExpirePeriod"), is(1209600));
+        assertThat(appServerStub.initparams.get("rails.root"), is("/WEB-INF/rails.new"));
+        assertThat((Boolean) appServerStub.calls.get("addStopServlet"), is(true));
+        assertThat((Boolean) appServerStub.calls.get("getUnavailableException"), is(true));
+        assertThat((Boolean) appServerStub.calls.get("configure"), is(true));
+        assertThat((Boolean) appServerStub.calls.get("start"), is(true));
+        assertThat(appServerStub.calls.get("stop"), is(CoreMatchers.nullValue()));
+
+        goServer.stop();
+        assertThat((Boolean) appServerStub.calls.get("stop"), is(true));
+    }
+
+    @Test
+    public void shouldStopServerAndThrowExceptionWhenServerFailsToStartWithAnUnhandledException() throws Exception {
+        final AppServer server = mock(AppServer.class);
+        when(server.getUnavailableException()).thenReturn(new RuntimeException("Some unhandled server startup exception"));
+
+        GoServer goServer = new GoServer(){
+            @Override
+            AppServer configureServer() throws Exception {
+                return server;
+            }
+        };
+        doNothing().when(server).start();
+        doNothing().when(server).stop();
+
+        try {
+            goServer.startServer();
+            fail("Should have thrown an exception");
+        } catch (RuntimeException e) {
+            assertThat(e.getMessage(), is("Failed to start Go server."));
+            assertThat(e.getCause().getMessage(), is("Some unhandled server startup exception"));
+        }
+
+        verify(server).start();
+        verify(server).getUnavailableException();
+        verify(server).stop();
+    }
+
+    @Test
+    public void shouldLoadAllJarsInTheAddonsDirectoryIntoClassPath() throws Exception {
+        File addonsDirectory = createInAddonDir("some-addon-dir");
+        FileSystemUtils.createFile("addon-1.JAR", addonsDirectory);
+        FileSystemUtils.createFile("addon-2.jar", addonsDirectory);
+        FileSystemUtils.createFile("addon-3.jAR", addonsDirectory);
+        FileSystemUtils.createFile("some-file-which-does-not-end-with-dot-jar.txt", addonsDirectory);
+
+        File oneAddonDirectory = createInAddonDir("one-addon-dir");
+        FileSystemUtils.createFile("addon-1.jar", oneAddonDirectory);
+
+        File noAddonDirectory = createInAddonDir("no-addon-dir");
+        SSLSocketFactory sslSocketFactory = mock(SSLSocketFactory.class);
+        when(sslSocketFactory.getSupportedCipherSuites()).thenReturn(new String[0]);
+
+
+        GoServer goServerWithMultipleAddons = new GoServer(setAddonsPathTo(addonsDirectory), sslSocketFactory);
+        goServerWithMultipleAddons.startServer();
+        AppServerStub appServer = (AppServerStub) com.thoughtworks.go.util.ReflectionUtil.getField(goServerWithMultipleAddons, "server");
+        assertExtraClasspath(appServer, "test-addons/some-addon-dir/addon-1.JAR", "test-addons/some-addon-dir/addon-2.jar", "test-addons/some-addon-dir/addon-3.jAR");
+
+        GoServer goServerWithOneAddon = new GoServer(setAddonsPathTo(oneAddonDirectory), sslSocketFactory);
+        goServerWithOneAddon.startServer();
+        appServer = (AppServerStub) com.thoughtworks.go.util.ReflectionUtil.getField(goServerWithOneAddon, "server");
+        assertExtraClasspath(appServer, "test-addons/one-addon-dir/addon-1.jar");
+
+        GoServer goServerWithNoAddon = new GoServer(setAddonsPathTo(noAddonDirectory), sslSocketFactory);
+        goServerWithNoAddon.startServer();
+        appServer = (AppServerStub) com.thoughtworks.go.util.ReflectionUtil.getField(goServerWithNoAddon, "server");
+        assertExtraClasspath(appServer, "");
+
+        GoServer goServerWithInaccessibleAddonDir = new GoServer(setAddonsPathTo(new File("non-existent-directory")), sslSocketFactory);
+        goServerWithInaccessibleAddonDir.startServer();
+        appServer = (AppServerStub) com.thoughtworks.go.util.ReflectionUtil.getField(goServerWithNoAddon, "server");
+        assertExtraClasspath(appServer, "");
+    }
+
+    private void assertExtraClasspath(AppServerStub appServer, String... expectedClassPathJars) {
+        String extraJars = (String) appServer.calls.get("addExtraJarsToClasspath");
+        List<String> actualExtraClassPath = Arrays.asList(extraJars.split(","));
+
+        assertEquals("Number of jars wrong. Expected: " + Arrays.asList(expectedClassPathJars) + ". Actual: " + actualExtraClassPath, expectedClassPathJars.length, actualExtraClassPath.size());
+        for (String expectedClassPathJar : expectedClassPathJars) {
+            String platformIndependantNameOfExpectedJar = expectedClassPathJar.replace("/", File.separator);
+            assertTrue("Expected " + extraJars + " to contain: " + platformIndependantNameOfExpectedJar, actualExtraClassPath.contains(platformIndependantNameOfExpectedJar));
+        }
+    }
+
+    private File createInAddonDir(String dirInsideAddonDir) {
+        File addonDir = new File("test-addons");
+        File dirWhichWillContainAddons = new File(addonDir, dirInsideAddonDir);
+        dirWhichWillContainAddons.mkdirs();
+        return dirWhichWillContainAddons;
+    }
+
+    private SystemEnvironment setAddonsPathTo(File path) {
+        SystemEnvironment systemEnvironment = mock(SystemEnvironment.class);
+        when(systemEnvironment.get(SystemEnvironment.APP_SERVER)).thenReturn(AppServerStub.class.getCanonicalName());
+        doReturn(path.getPath()).when(systemEnvironment).get(SystemEnvironment.ADDONS_PATH);
+        return systemEnvironment;
+    }
+
+
     private class StubGoServer extends GoServer {
         private boolean wasStarted = false;
         private Validation validation;
 
         public StubGoServer(SystemEnvironment systemEnvironment, Validation validation) {
-            super(systemEnvironment,null, null);
+            super(systemEnvironment,null);
             this.validation = validation;
         }
 

--- server/test/unit/com/thoughtworks/go/server/util/HttpTestUtil.java (modified) ---
additions: 47, deletions: 43, changes: 90
@@ -16,16 +16,26 @@
 
 package com.thoughtworks.go.server.util;
 
+import org.apache.commons.io.IOUtils;
+import org.bouncycastle.jce.provider.BouncyCastleProvider;
+import org.bouncycastle.x509.X509V1CertificateGenerator;
+import org.eclipse.jetty.server.*;
+import org.eclipse.jetty.server.session.HashSessionManager;
+import org.eclipse.jetty.server.session.SessionHandler;
+import org.eclipse.jetty.util.ssl.SslContextFactory;
+import org.eclipse.jetty.webapp.WebAppContext;
+
+import javax.security.auth.x500.X500Principal;
+import javax.servlet.ServletException;
+import javax.servlet.http.HttpServlet;
+import javax.servlet.http.HttpServletRequest;
+import javax.servlet.http.HttpServletResponse;
 import java.io.File;
 import java.io.FileOutputStream;
 import java.io.IOException;
 import java.io.PrintWriter;
 import java.math.BigInteger;
-import java.security.KeyFactory;
-import java.security.KeyPair;
-import java.security.KeyPairGenerator;
-import java.security.KeyStore;
-import java.security.Security;
+import java.security.*;
 import java.security.cert.Certificate;
 import java.security.cert.X509Certificate;
 import java.security.interfaces.RSAPrivateKey;
@@ -34,23 +44,6 @@
 import java.security.spec.RSAPublicKeySpec;
 import java.util.Date;
 import java.util.GregorianCalendar;
-import javax.security.auth.x500.X500Principal;
-import javax.servlet.ServletException;
-import javax.servlet.http.HttpServlet;
-import javax.servlet.http.HttpServletRequest;
-import javax.servlet.http.HttpServletResponse;
-
-import org.apache.commons.io.IOUtils;
-import org.bouncycastle.jce.provider.BouncyCastleProvider;
-import org.bouncycastle.x509.X509V1CertificateGenerator;
-import org.mortbay.jetty.Request;
-import org.mortbay.jetty.Server;
-import org.mortbay.jetty.SessionManager;
-import org.mortbay.jetty.nio.SelectChannelConnector;
-import org.mortbay.jetty.security.SslSocketConnector;
-import org.mortbay.jetty.servlet.Context;
-import org.mortbay.jetty.servlet.HashSessionManager;
-import org.mortbay.jetty.servlet.SessionHandler;
 
 import static com.thoughtworks.go.util.TestFileUtil.createTempFile;
 
@@ -67,6 +60,9 @@ public class HttpTestUtil {
     private Thread blocker;
     private File serverKeyStore;
 
+	private static final int MAX_IDLE_TIME = 30000;
+	private static final int RESPONSE_BUFFER_SIZE = 32768;
+
     public static class EchoServlet extends HttpServlet {
         @Override protected void doGet(HttpServletRequest request, HttpServletResponse resp) throws ServletException, IOException {
             handleRequest((Request) request, resp);
@@ -102,50 +98,58 @@ private void handleRequest(HttpServletRequest request, HttpServletResponse resp)
     }
 
     public static interface ContextCustomizer {
-        void customize(Context ctx) throws Exception;
+        void customize(WebAppContext ctx) throws Exception;
     }
 
     public HttpTestUtil(final ContextCustomizer customizer) throws Exception {
         Security.addProvider(new BouncyCastleProvider());
         serverKeyStore = createTempFile("server.jks");
         prepareCertStore(serverKeyStore);
         server = new Server();
-        Context ctx = new Context();
+		WebAppContext ctx = new WebAppContext();
         SessionManager sm = new HashSessionManager();
         SessionHandler sh = new SessionHandler(sm);
         ctx.setSessionHandler(sh);
         customizer.customize(ctx);
         ctx.setContextPath("/go");
-        server.addHandler(ctx);
+		server.setHandler(ctx);
     }
 
     public void httpConnector(final int port) {
-        SelectChannelConnector connector = connectorWithPort(port);
+		ServerConnector connector = connectorWithPort(port);
         server.addConnector(connector);
     }
 
     public void httpConnector(final int port, final String host) {
-        SelectChannelConnector connector = connectorWithPort(port);
+		ServerConnector connector = connectorWithPort(port);
         connector.setHost(host);
         server.addConnector(connector);
     }
 
-    private SelectChannelConnector connectorWithPort(int port) {
-        SelectChannelConnector connector = new SelectChannelConnector();
-        connector.setPort(port);
-        return connector;
-    }
-
-    public void httpsConnector(final int port) {
-        SslSocketConnector socketConnector = new SslSocketConnector();
-        socketConnector.setPort(port);
-        socketConnector.setMaxIdleTime(30000);
-        socketConnector.setKeystore(serverKeyStore.getAbsolutePath());
-        socketConnector.setPassword(STORE_PASSWORD);
-        socketConnector.setKeyPassword(STORE_PASSWORD);
-        socketConnector.setWantClientAuth(false);
-        server.addConnector(socketConnector);
-    }
+	private ServerConnector connectorWithPort(int port) {
+		ServerConnector http = new ServerConnector(server);
+		http.setPort(port);
+		return http;
+	}
+
+	public void httpsConnector(final int port) {
+		HttpConfiguration httpsConfig = new HttpConfiguration();
+		httpsConfig.setOutputBufferSize(RESPONSE_BUFFER_SIZE); // 32 MB
+		httpsConfig.addCustomizer(new SecureRequestCustomizer());
+
+		SslContextFactory sslContextFactory = new SslContextFactory();
+		sslContextFactory.setKeyStorePath(serverKeyStore.getAbsolutePath());
+		sslContextFactory.setKeyStorePassword(STORE_PASSWORD);
+		sslContextFactory.setKeyManagerPassword(STORE_PASSWORD);
+		sslContextFactory.setWantClientAuth(true);
+
+		ServerConnector https = new ServerConnector(server, new SslConnectionFactory(sslContextFactory, "http/1.1"), new HttpConnectionFactory(httpsConfig));
+		// https.setHost(host);
+		https.setPort(port);
+		https.setIdleTimeout(MAX_IDLE_TIME);
+
+		server.addConnector(https);
+	}
 
     public synchronized void start() throws InterruptedException {
         if (blocker != null)

--- server/test/unit/com/thoughtworks/go/server/web/DeploymentContextWriterTest.java (modified) ---
additions: 14, deletions: 10, changes: 24
@@ -16,18 +16,21 @@
 
 package com.thoughtworks.go.server.web;
 
-import java.net.URISyntaxException;
-import javax.servlet.http.HttpServletRequest;
-
 import com.thoughtworks.go.server.service.ServerConfigService;
+import com.thoughtworks.go.server.util.ServletHelper;
 import com.thoughtworks.go.util.SystemEnvironment;
+import org.eclipse.jetty.http.HttpURI;
+import org.eclipse.jetty.server.HttpChannel;
+import org.eclipse.jetty.server.HttpInput;
+import org.eclipse.jetty.server.Request;
 import org.junit.After;
 import org.junit.Before;
 import org.junit.Test;
-import org.mortbay.jetty.HttpURI;
-import org.mortbay.jetty.Request;
 import org.springframework.mock.web.MockHttpServletRequest;
 
+import javax.servlet.http.HttpServletRequest;
+import java.net.URISyntaxException;
+
 import static org.hamcrest.core.Is.is;
 import static org.hamcrest.core.IsNull.nullValue;
 import static org.junit.Assert.assertThat;
@@ -41,6 +44,7 @@ public class DeploymentContextWriterTest {
     public void setUp() {
         originalSslPort = System.getProperty(SystemEnvironment.CRUISE_SERVER_SSL_PORT);
         System.setProperty(SystemEnvironment.CRUISE_SERVER_SSL_PORT, "5050");
+        ServletHelper.init(true);
     }
 
     @After
@@ -65,7 +69,7 @@ public void shouldSetSecureSiteURLWhenSiteUrlIsConfigured() throws URISyntaxExce
         when(serverConfigService.hasAnyUrlConfigured()).thenReturn(true);
         when(serverConfigService.siteUrlFor("http://url/go/admin?tab=oAuth", true)).thenReturn("https://url/go/admin?tab=oAuth");
 
-        Request request = new Request();
+        Request request = new Request(mock(HttpChannel.class), mock(HttpInput.class));
         request.setUri(new HttpURI("/go/admin?tab=oAuth"));
         request.setServerName("url");
 
@@ -84,11 +88,11 @@ public void shouldSkipRedirectWhenSiteUrlIsNotConfigured() throws URISyntaxExcep
         final ServerConfigService serverConfigService = mock(ServerConfigService.class);
         when(serverConfigService.hasAnyUrlConfigured()).thenReturn(false);
 
-        Request req = new Request();
+        Request req = new Request(mock(HttpChannel.class), mock(HttpInput.class));
         req.setUri(new HttpURI("/go/admin?tab=oAuth"));
         req.setServerName("url");
         req.setServerPort(8153);
-        req.setProtocol("http");
+        //req.setProtocol("http");
 
         DeploymentContextWriter writer = new DeploymentContextWriter() {
             @Override protected BaseUrlProvider getBaseUrlProvider(HttpServletRequest req) {
@@ -106,11 +110,11 @@ public void shouldSetShouldRedirectToFalseWhenSecureSiteURLIsNotSetAndSiteUrlIsN
         when(serverConfigService.hasAnyUrlConfigured()).thenReturn(true);
         when(serverConfigService.siteUrlFor("http://url:8153/go/admin?tab=oAuth", true)).thenReturn("http://url:8153/go/admin?tab=oAuth");
 
-        Request req = new Request();
+        Request req = new Request(mock(HttpChannel.class), mock(HttpInput.class));
         req.setUri(new HttpURI("/go/admin?tab=oAuth"));
         req.setServerName("url");
         req.setServerPort(8153);
-        req.setProtocol("http");
+        //req.setProtocol("http");
 
         DeploymentContextWriter writer = new DeploymentContextWriter() {
             @Override protected BaseUrlProvider getBaseUrlProvider(HttpServletRequest req) {

--- server/test/unit/com/thoughtworks/go/server/web/GoVelocityViewTest.java (modified) ---
additions: 1, deletions: 1, changes: 2
@@ -23,10 +23,10 @@
 import com.thoughtworks.go.util.SystemEnvironment;
 import org.apache.velocity.VelocityContext;
 import org.apache.velocity.context.Context;
+import org.eclipse.jetty.server.Request;
 import org.junit.Before;
 import org.junit.Test;
 import org.mockito.Mock;
-import org.mortbay.jetty.Request;
 import org.springframework.mock.web.MockHttpServletRequest;
 import org.springframework.security.GrantedAuthority;
 import org.springframework.security.GrantedAuthorityImpl;

--- server/test/unit/com/thoughtworks/go/server/web/RedirectDuringBackupTest.java (modified) ---
additions: 28, deletions: 21, changes: 49
@@ -16,18 +16,24 @@
 
 package com.thoughtworks.go.server.web;
 
-import java.io.UnsupportedEncodingException;
-import javax.servlet.http.HttpServletRequest;
-
+import com.thoughtworks.go.server.util.ServletHelper;
+import com.thoughtworks.go.server.util.ServletRequest;
+import com.thoughtworks.go.server.util.ServletResponse;
+import org.eclipse.jetty.http.HttpMethod;
+import org.eclipse.jetty.http.HttpURI;
+import org.eclipse.jetty.server.HttpChannel;
+import org.eclipse.jetty.server.HttpInput;
+import org.eclipse.jetty.server.Request;
+import org.eclipse.jetty.util.UrlEncoded;
 import org.junit.Before;
 import org.junit.Test;
 import org.junit.experimental.theories.DataPoint;
 import org.junit.experimental.theories.Theories;
 import org.junit.experimental.theories.Theory;
 import org.junit.runner.RunWith;
-import org.mortbay.jetty.HttpURI;
-import org.mortbay.jetty.Request;
-import org.mortbay.util.UrlEncoded;
+
+import javax.servlet.http.HttpServletRequest;
+import java.io.UnsupportedEncodingException;
 
 import static java.net.URLEncoder.encode;
 import static org.hamcrest.core.Is.is;
@@ -46,6 +52,7 @@ public class RedirectDuringBackupTest {
 
     @Before
     public void setUp() {
+        ServletHelper.init(true);
         provider = mock(BackupStatusProvider.class);
         this.redirectDuringBackup = new RedirectDuringBackup() {
             @Override protected BackupStatusProvider getBackupStatusProvider(HttpServletRequest req) {
@@ -57,23 +64,23 @@ public void setUp() {
     @Test
     public void shouldNotRedirectWhenBackupIsNotBeingTaken() {
         when(provider.isBackingUp()).thenReturn(false);
-        Request request = request("get", "", "/go/agents");
+        Request request = request(HttpMethod.GET, "", "/go/agents");
 
         redirectDuringBackup.setServerBackupFlag(request);
 
         assertThat((String) request.getAttribute("backupInProgress"), is(String.valueOf(false)));
         assertThat(request.getAttribute("redirected_from"), is(nullValue()));
     }
 
-    @DataPoint public static ResponseAssertion GET = new ResponseAssertion("get", "go/agents?order=DESC&col=status", "go/agents/edit", "go/agents/edit");
-    @DataPoint public static ResponseAssertion POST = new ResponseAssertion("post", "go/agents?order=DESC&col=status", "go/agents/edit", "go/agents?order=DESC&col=status");
-    @DataPoint public static ResponseAssertion PUT = new ResponseAssertion("put", "go/agents?order=DESC&col=status", "go/agents/edit", "go/agents?order=DESC&col=status");
-    @DataPoint public static ResponseAssertion DELETE = new ResponseAssertion("delete", "go/agents?order=DESC&col=status", "go/agents/edit", "go/agents?order=DESC&col=status");
-    @DataPoint public static ResponseAssertion HEAD = new ResponseAssertion("head", "go/agents?order=DESC&col=status", "go/agents/edit", "go/agents/edit");
-    @DataPoint public static ResponseAssertion OPTIONS = new ResponseAssertion("options", "go/agents?order=DESC&col=status", "go/agents/edit", "go/agents/edit");
-    @DataPoint public static ResponseAssertion CONNECT = new ResponseAssertion("connect", "go/agents?order=DESC&col=status", "go/agents/edit", "go/agents/edit");
-    @DataPoint public static ResponseAssertion TRACE = new ResponseAssertion("trace", "go/agents?order=DESC&col=status", "go/agents/edit", "go/agents/edit");
-    @DataPoint public static ResponseAssertion NO_REFERER = new ResponseAssertion("get", null, "go/agents/edit", "go/agents/edit");
+    @DataPoint public static ResponseAssertion GET = new ResponseAssertion(HttpMethod.GET, "go/agents?order=DESC&col=status", "go/agents/edit", "go/agents/edit");
+    @DataPoint public static ResponseAssertion POST = new ResponseAssertion(HttpMethod.POST, "go/agents?order=DESC&col=status", "go/agents/edit", "go/agents?order=DESC&col=status");
+    @DataPoint public static ResponseAssertion PUT = new ResponseAssertion(HttpMethod.PUT, "go/agents?order=DESC&col=status", "go/agents/edit", "go/agents?order=DESC&col=status");
+    @DataPoint public static ResponseAssertion DELETE = new ResponseAssertion(HttpMethod.DELETE, "go/agents?order=DESC&col=status", "go/agents/edit", "go/agents?order=DESC&col=status");
+    @DataPoint public static ResponseAssertion HEAD = new ResponseAssertion(HttpMethod.HEAD, "go/agents?order=DESC&col=status", "go/agents/edit", "go/agents/edit");
+    @DataPoint public static ResponseAssertion OPTIONS = new ResponseAssertion(HttpMethod.OPTIONS, "go/agents?order=DESC&col=status", "go/agents/edit", "go/agents/edit");
+    @DataPoint public static ResponseAssertion CONNECT = new ResponseAssertion(HttpMethod.CONNECT, "go/agents?order=DESC&col=status", "go/agents/edit", "go/agents/edit");
+    @DataPoint public static ResponseAssertion TRACE = new ResponseAssertion(HttpMethod.TRACE, "go/agents?order=DESC&col=status", "go/agents/edit", "go/agents/edit");
+    @DataPoint public static ResponseAssertion NO_REFERER = new ResponseAssertion(HttpMethod.GET, null, "go/agents/edit", "go/agents/edit");
 
     @Theory
     public void shouldRedirectWhenBackupIsInProgress(ResponseAssertion responseAssertion) throws UnsupportedEncodingException {
@@ -105,29 +112,29 @@ public void shouldRedirectWhenBackupIsInProgressWithParamsForBackupStartedAtAndB
         assertThat((String) request.getAttribute("backup_started_by"), is(responseAssertion.backupStartedBy));
     }
 
-    private Request request(String method, final String referer, String uri) {
-        Request request = new Request() {
+    private Request request(HttpMethod method, final String referer, String uri) {
+        Request request = new Request(mock(HttpChannel.class), mock(HttpInput.class)) {
             @Override public String getHeader(String name) {
                 if (name.equals("Referer")) {
                     return referer;
                 }
                 return super.getHeader(name);
             }
         };
-        request.setMethod(method);
+		request.setMethod(method, method.asString());
         request.setUri(new HttpURI(uri));
         return request;
     }
 
     private static class ResponseAssertion {
-        private String method;
+        private HttpMethod method;
         private String referer;
         private String uri;
         private String expectedRedirectedFrom;
         private String backupStartedAt;
         private String backupStartedBy;
 
-        public ResponseAssertion(String method, String referer, String uri, String expectedRedirectedFrom) {
+        public ResponseAssertion(HttpMethod method, String referer, String uri, String expectedRedirectedFrom) {
             this.method = method;
             this.referer = referer;
             this.uri = uri;

--- server/webapp/WEB-INF/webdefault-jetty6.xml (added) ---
additions: 174, deletions: 0, changes: 174
@@ -0,0 +1,174 @@
+<!-- *************************GO-LICENSE-START******************************
+ * Copyright 2014 ThoughtWorks, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ *************************GO-LICENSE-END******************************* -->
+
+<web-app xmlns="http://java.sun.com/xml/ns/j2ee"
+         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+         xsi:schemaLocation="http://java.sun.com/xml/ns/j2ee http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd"
+         version="2.4">
+
+    <context-param>
+        <param-name>org.mortbay.jetty.servlet.MaxAge</param-name>
+        <param-value>36000</param-value>
+    </context-param>
+
+
+    <filter-mapping>
+        <filter-name>gizFilter</filter-name>
+        <url-pattern>*.js</url-pattern>
+    </filter-mapping>
+
+    <filter-mapping>
+        <filter-name>gizFilter</filter-name>
+        <url-pattern>*.json</url-pattern>
+    </filter-mapping>
+
+    <filter-mapping>
+        <filter-name>gizFilter</filter-name>
+        <url-pattern>*.css</url-pattern>
+    </filter-mapping>
+
+    <!-- This is the older UI pages -->
+    <filter-mapping>
+        <filter-name>gizFilter</filter-name>
+        <url-pattern>/tab/*</url-pattern>
+    </filter-mapping>
+
+    <!-- New pages need to be added explicitly since
+        the old /tab/* approach won't work -->
+    <filter-mapping>
+        <filter-name>gizFilter</filter-name>
+        <url-pattern>/pipelines</url-pattern>
+    </filter-mapping>
+
+    <filter-mapping>
+        <filter-name>gizFilter</filter-name>
+        <url-pattern>/pipelines/*</url-pattern>
+    </filter-mapping>
+
+    <filter-mapping>
+        <filter-name>gizFilter</filter-name>
+        <url-pattern>/home</url-pattern>
+    </filter-mapping>
+
+    <filter-mapping>
+        <filter-name>gizFilter</filter-name>
+        <url-pattern>/agents</url-pattern>
+    </filter-mapping>
+
+    <filter-mapping>
+        <filter-name>gizFilter</filter-name>
+        <url-pattern>/environments</url-pattern>
+    </filter-mapping>
+
+    <filter-mapping>
+        <filter-name>gizFilter</filter-name>
+        <url-pattern>/stylesheets</url-pattern>
+    </filter-mapping>
+
+    <filter-mapping>
+        <filter-name>gizFilter</filter-name>
+        <url-pattern>/assets</url-pattern>
+    </filter-mapping>
+
+    <filter-mapping>
+        <filter-name>gizFilter</filter-name>
+        <url-pattern>/admin</url-pattern>
+    </filter-mapping>
+
+    <filter-mapping>
+        <filter-name>gizFilter</filter-name>
+        <url-pattern>/admin/*</url-pattern>
+    </filter-mapping>
+
+    <!-- This capturees logs which are served out frequently
+        e.g. on the console tab of the job page-->
+    <filter-mapping>
+        <filter-name>gizFilter</filter-name>
+        <url-pattern>*.log</url-pattern>
+    </filter-mapping>
+
+    <filter>
+        <filter-name>gizFilter</filter-name>
+        <filter-class>org.mortbay.servlet.GzipFilter</filter-class>
+    </filter>
+
+    <servlet>
+        <servlet-name>default</servlet-name>
+        <servlet-class>org.mortbay.jetty.servlet.DefaultServlet</servlet-class>
+        <init-param>
+            <param-name>cacheControl</param-name>
+            <param-value>max-age=36000,public</param-value>
+        </init-param>
+        <init-param>
+            <param-name>acceptRanges</param-name>
+            <param-value>true</param-value>
+        </init-param>
+        <init-param>
+            <param-name>dirAllowed</param-name>
+            <param-value>true</param-value>
+        </init-param>
+        <init-param>
+            <param-name>redirectWelcome</param-name>
+            <param-value>false</param-value>
+        </init-param>
+        <init-param>
+            <param-name>maxCacheSize</param-name>
+            <param-value>30000</param-value>
+        </init-param>
+        <init-param>
+            <param-name>maxCachedFileSize</param-name>
+            <param-value>254000</param-value>
+        </init-param>
+        <init-param>
+            <param-name>maxCachedFiles</param-name>
+            <param-value>1000</param-value>
+        </init-param>
+        <init-param>
+            <param-name>useFileMappedBuffer</param-name>
+            <param-value>true</param-value>
+        </init-param>
+        <load-on-startup>0</load-on-startup>
+    </servlet>
+
+    <servlet-mapping>
+        <servlet-name>default</servlet-name>
+        <url-pattern>/assets/*</url-pattern>
+    </servlet-mapping>
+    <servlet-mapping>
+        <servlet-name>default</servlet-name>
+        <url-pattern>/css/*</url-pattern>
+    </servlet-mapping>
+
+    <servlet-mapping>
+        <servlet-name>default</servlet-name>
+        <url-pattern>*.js</url-pattern>
+    </servlet-mapping>
+    <servlet-mapping>
+        <servlet-name>default</servlet-name>
+        <url-pattern>*.css</url-pattern>
+    </servlet-mapping>
+
+    <servlet-mapping>
+        <servlet-name>default</servlet-name>
+        <url-pattern>/images/*</url-pattern>
+    </servlet-mapping>
+
+    <servlet-mapping>
+        <servlet-name>default</servlet-name>
+        <url-pattern>/help/*</url-pattern>
+    </servlet-mapping>
+</web-app>
+

--- server/webapp/WEB-INF/webdefault.xml (modified) ---
additions: 6, deletions: 7, changes: 13
@@ -20,10 +20,14 @@
          version="2.4">
 
     <context-param>
-        <param-name>org.mortbay.jetty.servlet.MaxAge</param-name>
+        <param-name>org.eclipse.jetty.servlet.MaxAge</param-name>
         <param-value>36000</param-value>
     </context-param>
 
+    <filter>
+        <filter-name>gizFilter</filter-name>
+        <filter-class>org.eclipse.jetty.servlets.GzipFilter</filter-class>
+    </filter>
 
     <filter-mapping>
         <filter-name>gizFilter</filter-name>
@@ -100,14 +104,9 @@
         <url-pattern>*.log</url-pattern>
     </filter-mapping>
 
-    <filter>
-        <filter-name>gizFilter</filter-name>
-        <filter-class>org.mortbay.servlet.GzipFilter</filter-class>
-    </filter>
-
     <servlet>
         <servlet-name>default</servlet-name>
-        <servlet-class>org.mortbay.jetty.servlet.DefaultServlet</servlet-class>
+        <servlet-class>org.eclipse.jetty.servlet.DefaultServlet</servlet-class>
         <init-param>
             <param-name>cacheControl</param-name>
             <param-value>max-age=36000,public</param-value>

--- tasks/jars.rake (modified) ---
additions: 5, deletions: 0, changes: 5
@@ -36,6 +36,11 @@ def server_launcher_dependencies
   jars = Dir.glob($PROJECT_BASE + '/server-launcher/target/libs/*.jar')
   jars
 end
+def jetty_jars
+  jetty9_dependencies = Dir.glob($PROJECT_BASE + '/jetty9/target/lib/*.jar')
+  jetty6_dependencies = Dir.glob($PROJECT_BASE + '/jetty6/target/lib/*.jar')
+  jetty9_dependencies + jetty6_dependencies
+end
 
 def maven_dependency(groupid, artifactid, version, maven_repository = File.expand_path('~') + '/.m2/repository')
   groupid.gsub!('.', '/')

--- test-utils/pom.xml (modified) ---
additions: 20, deletions: 2, changes: 22
@@ -34,6 +34,7 @@
     <properties>
         <main.dir>${project.basedir}/..</main.dir>
         <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
+        <jetty.version>9.2.3.v20140905</jetty.version>
     </properties>
 
     <dependencies>
@@ -85,11 +86,28 @@
             <version>${spring.version}</version>
         </dependency>
 
+        <!-- jetty -->
         <dependency>
-            <groupId>org.mortbay.jetty</groupId>
-            <artifactId>jetty</artifactId>
+            <groupId>org.eclipse.jetty</groupId>
+            <artifactId>jetty-server</artifactId>
             <version>${jetty.version}</version>
         </dependency>
+        <dependency>
+            <groupId>org.eclipse.jetty</groupId>
+            <artifactId>jetty-plus</artifactId>
+            <version>${jetty.version}</version>
+        </dependency>
+        <dependency>
+            <groupId>org.eclipse.jetty</groupId>
+            <artifactId>jetty-jmx</artifactId>
+            <version>${jetty.version}</version>
+        </dependency>
+        <dependency>
+            <groupId>org.eclipse.jetty</groupId>
+            <artifactId>jetty-util</artifactId>
+            <version>${jetty.version}</version>
+        </dependency>
+        <!-- jetty end -->
 
         <dependency>
             <groupId>com.sun.mail</groupId>

--- test-utils/src/com/thoughtworks/go/agent/testhelper/FakeBootstrapperServer.java (modified) ---
additions: 15, deletions: 19, changes: 34
@@ -16,27 +16,23 @@
 
 package com.thoughtworks.go.agent.testhelper;
 
-import java.io.ByteArrayOutputStream;
-import java.io.File;
-import java.io.IOException;
-import java.util.Properties;
-import javax.servlet.Filter;
-import javax.servlet.FilterChain;
-import javax.servlet.FilterConfig;
-import javax.servlet.ServletException;
-import javax.servlet.ServletRequest;
-import javax.servlet.ServletResponse;
-import javax.servlet.http.HttpServlet;
-import javax.servlet.http.HttpServletRequest;
-import javax.servlet.http.HttpServletResponse;
-
+import org.eclipse.jetty.server.Server;
+import org.eclipse.jetty.servlet.ServletHolder;
+import org.eclipse.jetty.webapp.WebAppContext;
 import org.junit.internal.runners.InitializationError;
 import org.junit.internal.runners.JUnit4ClassRunner;
 import org.junit.runner.notification.Failure;
 import org.junit.runner.notification.RunNotifier;
-import org.mortbay.jetty.Server;
-import org.mortbay.jetty.servlet.ServletHolder;
-import org.mortbay.jetty.webapp.WebAppContext;
+
+import javax.servlet.*;
+import javax.servlet.http.HttpServlet;
+import javax.servlet.http.HttpServletRequest;
+import javax.servlet.http.HttpServletResponse;
+import java.io.ByteArrayOutputStream;
+import java.io.File;
+import java.io.IOException;
+import java.util.EnumSet;
+import java.util.Properties;
 
 public class FakeBootstrapperServer extends JUnit4ClassRunner {
     private Server server;
@@ -73,7 +69,7 @@ public void start() throws Exception {
         addlatestAgentStatusCall(wac);
         addStopServlet(server, wac);
         addDefaultServlet(wac);
-        server.addHandler(wac);
+        server.setHandler(wac);
         server.setStopAtShutdown(true);
         server.start();
     }
@@ -113,7 +109,7 @@ public void destroy() {
     }
 
     private void addDefaultServlet(WebAppContext wac) {
-        wac.addFilter(BreakpointFriendlyFilter.class, "*", 0);
+        wac.addFilter(BreakpointFriendlyFilter.class, "*", EnumSet.of(DispatcherType.REQUEST));
     }
 
     private static void addFakeAgentBinaryServlet(WebAppContext wac, final String pathSpec, final File file) {

--- util/pom.xml (modified) ---
additions: 2, deletions: 2, changes: 4
@@ -64,8 +64,8 @@
 
         <dependency>
             <groupId>javax.servlet</groupId>
-            <artifactId>servlet-api</artifactId>
-            <version>2.5</version>
+            <artifactId>javax.servlet-api</artifactId>
+            <version>3.1.0</version>
         </dependency>
 
         <dependency>

