# TRUE POSITIVE: zaproxy/zaproxy
# SHA: 6d68f2b657fccca3c226a99e92a2969dcbe7f356
# Our Score: 45
# High score (45), confirmed bug-introducing commit
# GitHub: https://github.com/zaproxy/zaproxy/commit/6d68f2b657fccca3c226a99e92a2969dcbe7f356

Commit message: Merge pull request #5166 from kingthorin/client-cert-api

Client Certificates Web API Support

--- src/lang/Messages.properties (modified) ---
additions: 2, deletions: 0, changes: 2
@@ -1042,6 +1042,8 @@ core.api.action.modifyProxyChainExcludedDomain = Modifies a domain excluded from
 core.api.action.removeProxyChainExcludedDomain = Removes a domain excluded from the outgoing proxy, with the given index. The index can be obtained with the view proxyChainExcludedDomains.
 core.api.action.enableAllProxyChainExcludedDomains = Enables all domains excluded from the outgoing proxy.
 core.api.action.disableAllProxyChainExcludedDomains = Disables all domains excluded from the outgoing proxy.
+core.api.action.disableClientCertificate = Disables the option for use of client certificates.
+core.api.action.enablePKCS12ClientCertificate = Enables use of a PKCS12 client certificate for the certificate with the given file system path, password, and optional index.
 core.api.action.setOptionProxyChainSkipName = Use actions [add|modify|remove]ProxyChainExcludedDomain instead.
 core.api.action.setOptionDefaultUserAgent = Sets the user agent that ZAP should use when creating HTTP messages (for example, spider messages or CONNECT requests to outgoing proxy).
 core.api.action.setOptionMaximumAlertInstances = Sets the maximum number of alert instances to include in a report. A value of zero is treated as unlimited.

--- src/org/parosproxy/paros/extension/option/OptionsCertificatePanel.java (modified) ---
additions: 8, deletions: 1, changes: 9
@@ -166,7 +166,6 @@ private void initialize() {
 		}
 		
 		if(contextManager.getKeyStoreCount() != 0) {
-			keyStoreListModel.insertElementAt(contextManager.getKeyStoreDescription(0), 0);
 			overrideEnableClientCertificate = true;
 		}
 
@@ -1005,6 +1004,14 @@ public void initParam(Object obj) {
 			certParam.setEnableCertificate(true);
 			overrideEnableClientCertificate = false;
 		}
+		keyStoreListModel.clear();
+		for (int i = 0; i < contextManager.getKeyStoreCount(); i++) {
+			keyStoreListModel.addElement(contextManager.getKeyStoreDescription(i));
+		}
+		Certificate cert = contextManager.getDefaultCertificate();
+		if (cert != null) {
+			certificateTextField.setText(cert.toString());
+		}
 		useClientCertificateCheckBox.setSelected(certParam.isUseClientCert());
 		useClientCertificateCheckBoxActionPerformed(null);
 		

--- src/org/zaproxy/zap/extension/api/CoreAPI.java (modified) ---
additions: 50, deletions: 0, changes: 50
@@ -27,7 +27,11 @@
 import java.nio.file.Files;
 import java.nio.file.Path;
 import java.nio.file.Paths;
+import java.security.KeyManagementException;
+import java.security.KeyStoreException;
+import java.security.NoSuchAlgorithmException;
 import java.security.cert.Certificate;
+import java.security.cert.CertificateException;
 import java.text.SimpleDateFormat;
 import java.util.ArrayList;
 import java.util.Date;
@@ -57,6 +61,7 @@
 import org.parosproxy.paros.db.RecordHistory;
 import org.parosproxy.paros.db.TableHistory;
 import org.parosproxy.paros.extension.history.ExtensionHistory;
+import org.parosproxy.paros.extension.option.OptionsParamCertificate;
 import org.parosproxy.paros.extension.report.ReportGenerator;
 import org.parosproxy.paros.extension.report.ReportLastScan;
 import org.parosproxy.paros.model.HistoryReference;
@@ -86,6 +91,7 @@
 import org.zaproxy.zap.utils.ApiUtils;
 import org.zaproxy.zap.utils.HarUtils;
 
+import ch.csnc.extension.httpclient.SSLContextManager;
 import edu.umass.cs.benchlab.har.HarEntries;
 import edu.umass.cs.benchlab.har.HarLog;
 import net.sf.json.JSONException;
@@ -131,6 +137,8 @@ private enum ScanReportType {
 	private static final String ACTION_OPTION_MERGE_RELATED_ALERTS = "setOptionMergeRelatedAlerts";
 	private static final String ACTION_OPTION_ALERT_OVERRIDES_FILE_PATH = "setOptionAlertOverridesFilePath";
 	private static final String ACTION_OPTION_USE_PROXY_CHAIN = "setOptionUseProxyChain";
+	private static final String ACTION_ENABLE_PKCS12_CLIENT_CERTIFICATE = "enablePKCS12ClientCertificate";
+	private static final String ACTION_DISABLE_CLIENT_CERTIFICATE = "disableClientCertificate";
 	
 	private static final String VIEW_ALERT = "alert";
 	private static final String VIEW_ALERTS = "alerts";
@@ -196,6 +204,8 @@ private enum ScanReportType {
 	private static final String PARAM_NUMBER_OF_INSTANCES = "numberOfInstances";
 	private static final String PARAM_ENABLED = "enabled";
 	private static final String PARAM_FILE_PATH = "filePath";
+	private static final String PARAM_PASSWORD = "password";
+	private static final String PARAM_INDEX = "index";
 
 	/* Update the version whenever the script is changed (once per release) */
 	protected static final int API_SCRIPT_VERSION = 2;
@@ -271,6 +281,8 @@ public CoreAPI(ConnectionParam connectionParam) {
 		this.addApiAction(new ApiAction(ACTION_OPTION_MAXIMUM_ALERT_INSTANCES, new String[] { PARAM_NUMBER_OF_INSTANCES }));
 		this.addApiAction(new ApiAction(ACTION_OPTION_MERGE_RELATED_ALERTS, new String[] { PARAM_ENABLED }));
 		this.addApiAction(new ApiAction(ACTION_OPTION_ALERT_OVERRIDES_FILE_PATH, null, new String[] { PARAM_FILE_PATH }));
+		this.addApiAction(new ApiAction(ACTION_ENABLE_PKCS12_CLIENT_CERTIFICATE, new String[] {PARAM_FILE_PATH, PARAM_PASSWORD}, new String[] {PARAM_INDEX}));
+		this.addApiAction(new ApiAction(ACTION_DISABLE_CLIENT_CERTIFICATE));
 
 		// Deprecated actions
 		this.addApiAction(depreciatedAlertApi(new ApiAction(ACTION_DELETE_ALL_ALERTS)));
@@ -712,6 +724,44 @@ public void run() {
 			if (!Control.getSingleton().getExtensionLoader().getExtension(ExtensionAlert.class).reloadOverridesFile()) {
 				throw new ApiException(ApiException.Type.ILLEGAL_PARAMETER, PARAM_FILE_PATH);
 			}
+		} else if (ACTION_ENABLE_PKCS12_CLIENT_CERTIFICATE.equals(name)) {
+			String filePath = getParam(params, PARAM_FILE_PATH, "");
+			if (!filePath.isEmpty()) {
+				File file = new File(filePath);
+				if (!file.isFile() || !file.canRead()) {
+					throw new ApiException(ApiException.Type.ILLEGAL_PARAMETER, PARAM_FILE_PATH);
+				}
+			}
+			String password = getParam(params, PARAM_PASSWORD, "");
+			if (password.isEmpty()) {
+				throw new ApiException(ApiException.Type.ILLEGAL_PARAMETER, PARAM_PASSWORD);
+			}
+			int certIndex = getParam(params, PARAM_INDEX, 0);
+			if (certIndex < 0) {
+				certIndex = 0;
+			}
+
+			OptionsParamCertificate certParams = Model.getSingleton().getOptionsParam().getCertificateParam();
+			try {
+				SSLContextManager contextManager = certParams.getSSLContextManager();
+				int ksIndex = contextManager.loadPKCS12Certificate(filePath, password);
+				contextManager.unlockKey(ksIndex, certIndex, password);
+				contextManager.setDefaultKey(ksIndex, certIndex);
+				certParams.setActiveCertificate();
+				certParams.setEnableCertificate(true);
+				logger.info("Client Certificate enabled from API");
+			} catch (IOException | CertificateException | NoSuchAlgorithmException | KeyStoreException
+					| KeyManagementException ex) {
+				logger.error("The certificate could not be enabled due to an error", ex);
+				throw new ApiException(ApiException.Type.INTERNAL_ERROR, ex);
+			}
+			return ApiResponseElement.OK;
+
+		} else if (ACTION_DISABLE_CLIENT_CERTIFICATE.equals(name)) {
+			Model.getSingleton().getOptionsParam().getCertificateParam().setEnableCertificate(false);
+			logger.info("Client Certificate disabled from API");
+
+			return ApiResponseElement.OK;
 		} else {
 			throw new ApiException(ApiException.Type.BAD_ACTION);
 		}

